---
title: "Island Species-Area Relationship"
author: "Amy Solman"
date: "07/10/2021"
output: html_document
---
This script will look for a significant correlation between cryoconite hole area and species richness/Shannon/Simpson diversity.

I'm going to plot hole area against diversity in a scatter plot.

I'm going to carry out linear regression of log10(Diversity) against log10(Area) to estimate the c and z coefficients (where z is the strength of the relationship).

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear workspace and load packages
```{r}
rm(list=ls())
graphics.off()

# library(ggpubr) #for making my boxplots
# library(FSA) #for dunn's test
# library(vegan) #for diversity indices
# library(ggplot2) #for making plots
# library(dplyr) #for manipulating data where you see %>% and computing summary stats
# install.packages("dendextend")
# library(dendextend) #for hierchical clustering
# install.packages("indicspecies")
# library(indicspecies) #for indicator species analysis

```

Load data 
```{r}
#Load data files
load("../data-output/18S-my-sequence-data.RData") #load all our pre-processed data files

#load phyloseq object
##################################################BOTH POLES#################################################
ps <- readRDS("../data-output/18S-my-phyloseq-object.rds") #load unrarefied phyloseq object
ps.rar <- readRDS("../data-output/18S-my-phyloseq-object-rarefied.rds") #load rarefied phyloseq objectcol

# #Global abundances i.e. globally abundant, globally rare, globally intermediate
# ps.global.RA <- readRDS("../data-output/18S-all-rarefied-abundant.rds") #load rarefied globally abundant phyloseq object
# ps.global.RR <- readRDS("../data-output/18S-all-rarefied-rare.rds") #load rarefied globally rare phyloseq object
# ps.global.I <- readRDS("../data-output/18S-all-rarefied-intermediate.rds") #load rarefied globally abundant phyloseq object
# 
# #Both poles merged regional abundances
# ps.both.merged.RA <- readRDS("../data-output/18S-all-merged-rarefied-abundant.rds") #merged poles abundant phyloseq object
# ps.both.merged.RR <- readRDS("../data-output/18S-all-merged-rarefied-rare.rds") #merged poles rare phyloseq object
# ps.both.merged.I <- readRDS("../data-output/18S-all-merged-rarefied-intermediate.rds") #merged poles intermediate phyloseq object

#All glaciers merged abundances
ps.glaciers.merged.RA <- readRDS("../data-output/18S-all-glaciers-merged-rarefied-abundant.rds") #merged glaciers abundant phyloseq object
ps.glaciers.merged.RR <- readRDS("../data-output/18S-all-glaciers-merged-rarefied-rare.rds") #merged glaciers rare phyloseq object
ps.glaciers.merged.I <- readRDS("../data-output/18S-all-glaciers-merged-rarefied-intermediate.rds") #merged glaciers intermediate phyloseq object

# ##################################################ARCTIC#################################################
# ps.arc <- readRDS("../data-output/18S-arctic-rarefied.rds")
# ps.arc.RA <- readRDS("../data-output/18S-arctic-rarefied-abundant.rds") #load rarefied arctic abundant phyloseq object
# ps.arc.RR <- readRDS("../data-output/18S-arctic-rarefied-rare.rds") #load rarefied arctic rare phyloseq object
# ps.arc.I <- readRDS("../data-output/18S-arctic-rarefied-intermediate.rds") #load rarefied arctic intermediate phyloseq object
# 
# ##################################################ANTARCTIC#################################################
# ps.ant <- readRDS("../data-output/18S-antarctic-rarefied.rds")
# ps.ant.RA <- readRDS("../data-output/18S-antarctic-rarefied-abundant.rds") #load rarefied antarctic abundant phyloseq object
# ps.ant.RR <- readRDS("../data-output/18S-antarctic-rarefied-rare.rds") #load rarefied antarctic rare phyloseq object
# ps.ant.I <- readRDS("../data-output/18S-antarctic-rarefied-intermediate.rds") #load rarefied antarctic intermediate phyloseq object
```

1 TOTAL TAXA

1.1 Get hole area and diversity data
```{r}
#get our ASV count table
asv_counts <- as.data.frame(otu_table(ps.rar))

#get sample data from ps.rar 
samp_data <- data.frame(sample_data(ps.rar))

#find the asv richness of each sample
#first convert to presence/absence table
asv_counts_pa <- asv_counts
asv_counts_pa[asv_counts_pa != 0] = 1
asv_rich <- colSums(asv_counts_pa)

#get shannon diversity
data = t(otu_table(ps.rar))
shannon <- diversity(data, index="shannon")

#get simpson diversity 
simpson <- diversity(data, index="simpson")

#Calculate hole areas
#Method as per Darcy et al (2018)
hole_area_cm2 <- pi*(samp_data$NS/2)*(samp_data$EW/2)

#put into dataframe
tot_data <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, asv_rich, shannon, simpson, hole_area_cm2)
colnames(tot_data) <- c("SampleID", "Glacier", "Region", "Pole", "Richness", "Shannon", "Simpson", "Area")
tot_data <- as.data.frame(tot_data)

#remove samples without area data
tot_data <- tot_data[complete.cases(tot_data$Area), ]

#make sure data is numeric
tot_data$Richness <- as.numeric(tot_data$Richness)
tot_data$Shannon <- as.numeric(tot_data$Shannon)
tot_data$Simpson <- as.numeric(tot_data$Simpson)
tot_data$Area <- as.numeric(tot_data$Area)

#add log10 transformtions
tot_data$log10Rich <- log10(tot_data$Richness)
tot_data$log10Shan <- log10(tot_data$Shannon)
tot_data$log10Simp <- log10(tot_data$Simpson)
tot_data$log10Area <- log10(tot_data$Area)

```

1.2  regression on log transformed data
Linear regession is a statistical model that analyzes the relationship between a response variable (richness) and explanatory variables (area).
```{r}
#RICHNESS
#Linear regression model of richness and area
lm_ISAR <- lm(log10Rich ~ log10Area, data = tot_data)

summary(lm_ISAR) #c = 1.87, z=0.04, p < 0.05

#Plot the fit
ggplot(tot_data, aes(x=log10Area, y=log10Rich)) + 
  geom_point()+
  geom_smooth(method=lm)+
  annotate(geom="text", x=3, y=2.5, label=paste0("p < 0.05, z=", as.numeric(round(lm_ISAR$coefficients[2], 3))),
              color="red")+
  ggtitle("Total Taxa: ASV Richness")

#SHANNON
lm_ISAR_shan <- lm(log10Shan ~ log10Area, data = tot_data)

summary(lm_ISAR_shan) #c = 0.18, z=0.08, p > 0.05

#Plot the fit
ggplot(tot_data, aes(x=log10Area, y=log10Shan)) + 
  geom_point()+
  geom_smooth(method=lm)+
  annotate(geom="text", x=3, y=0.75, label=paste0("p > 0.05, z=", as.numeric(round(lm_ISAR_shan$coefficients[2], 3))),
              color="red")+
  ggtitle("Total Taxa: Shannon Index")


#SIMPSON
lm_ISAR_simp <- lm(log10Simp ~ log10Area, data = tot_data)

summary(lm_ISAR_simp) #c = -0.23, z=0.04, p < 0.05

#Plot the fit
ggplot(tot_data, aes(x=log10Area, y=log10Simp)) + 
  geom_point()+
  geom_smooth(method=lm)+
  annotate(geom="text", x=3, y=0, label=paste0("p > 0.05, z=", as.numeric(round(lm_ISAR_simp$coefficients[2], 3))),
              color="red")+
  ggtitle("Total Taxa: Simpson Index")
```

2 ABUNDANT TAXA

2.1 Get hole area and diversity data
```{r}
#get our ASV count table
asv_counts.ab <- as.data.frame(otu_table(ps.glaciers.merged.RA))

#get sample data
samp_data.ab <- data.frame(sample_data(ps.glaciers.merged.RA))

#find the asv richness of each sample
#first convert to presence/absence table
asv_counts_pa.ab <- asv_counts.ab
asv_counts_pa.ab[asv_counts_pa.ab != 0] = 1
asv_rich.ab <- colSums(asv_counts_pa.ab)

#get shannon diversity
data.ab = t(otu_table(ps.glaciers.merged.RA))
shannon.ab <- diversity(data.ab, index="shannon")

#get simpson diversity 
simpson.ab <- diversity(data.ab, index="simpson")

#Calculate hole areas
#Method as per Darcy et al (2018)
hole_area_cm2.ab <- pi*(samp_data.ab$NS/2)*(samp_data.ab$EW/2)

#put into dataframe
data.ab <- cbind(samp_data.ab$SampleID, samp_data.ab$Glacier, samp_data.ab$Region, samp_data.ab$Pole, asv_rich.ab, shannon.ab, simpson.ab, hole_area_cm2.ab)
colnames(data.ab) <- c("SampleID", "Glacier", "Region", "Pole", "Richness", "Shannon", "Simpson", "Area")
data.ab <- as.data.frame(data.ab)

#remove samples without area data
data.ab <- data.ab[complete.cases(data.ab$Area), ]

#make sure data is numeric
data.ab$Richness <- as.numeric(data.ab$Richness)
data.ab$Shannon <- as.numeric(data.ab$Shannon)
data.ab$Simpson <- as.numeric(data.ab$Simpson)
data.ab$Area <- as.numeric(data.ab$Area)

#add log10 transformtions
data.ab$log10Rich <- log10(data.ab$Richness)
data.ab$log10Shan <- log10(data.ab$Shannon)
data.ab$log10Simp <- log10(data.ab$Simpson)
data.ab$log10Area <- log10(data.ab$Area)

```

2.2  regression on log transformed data
Linear regession is a statistical model that analyzes the relationship between a response variable (richness) and explanatory variables (area).
```{r}
#RICHNESS
#Linear regression model of richness and area
lm_ISAR.ab <- lm(log10Rich ~ log10Area, data = data.ab)

summary(lm_ISAR.ab) #c = 0.736, z=0.15, p < 0.05

#Plot the fit
ggplot(data.ab, aes(x=log10Area, y=log10Rich)) + 
  geom_point()+
  geom_smooth(method=lm)+
  annotate(geom="text", x=2, y=2.5, label=paste0("p < 0.05, z=", as.numeric(round(lm_ISAR.ab$coefficients[2], 3))),
              color="red")+
  ggtitle("Abundant Taxa: ASV Richness")

#SHANNON
lm_ISAR_shan.ab <- lm(log10Shan ~ log10Area, data = data.ab)

summary(lm_ISAR_shan.ab) #c = 0.008, z=0.09, p > 0.05

#Plot the fit
ggplot(data.ab, aes(x=log10Area, y=log10Shan)) + 
  geom_point()+
  geom_smooth(method=lm)+
  annotate(geom="text", x=3, y=0.75, label=paste0("p > 0.05, z=", as.numeric(round(lm_ISAR_shan.ab$coefficients[2], 3))),
              color="red")+
  ggtitle("Abundant Taxa: Shannon Index")


#SIMPSON
lm_ISAR_simp.ab <- lm(log10Simp ~ log10Area, data = data.ab)

summary(lm_ISAR_simp.ab) #c = -0.30, z=0.06, p < 0.05

#Plot the fit
ggplot(data.ab, aes(x=log10Area, y=log10Simp)) + 
  geom_point()+
  geom_smooth(method=lm)+
  annotate(geom="text", x=3, y=0, label=paste0("p < 0.05, z=", as.numeric(round(lm_ISAR_simp.ab$coefficients[2], 3))),
              color="red")+
  ggtitle("Abundant Taxa: Simpson Index")
```

3 INTERMEDIATE TAXA

3.1 Get hole area and diversity data
```{r}
#get our ASV count table
asv_counts.i <- as.data.frame(otu_table(ps.glaciers.merged.I))

#get sample data
samp_data.i <- data.frame(sample_data(ps.glaciers.merged.I))

#find the asv richness of each sample
#first convert to presence/absence table
asv_counts_pa.i <- asv_counts.i
asv_counts_pa.i[asv_counts_pa.i != 0] = 1
asv_rich.i <- colSums(asv_counts_pa.i)

#get shannon diversity
data.i = t(otu_table(ps.glaciers.merged.I))
shannon.i <- diversity(data.i, index="shannon")

#get simpson diversity 
simpson.i <- diversity(data.i, index="simpson")

#Calculate hole areas
#Method as per Darcy et al (2018)
hole_area_cm2.i <- pi*(samp_data.i$NS/2)*(samp_data.i$EW/2)

#put into dataframe
data.i <- cbind(samp_data.i$SampleID, samp_data.i$Glacier, samp_data.i$Region, samp_data.i$Pole, asv_rich.i, shannon.i, simpson.i, hole_area_cm2.i)
colnames(data.i) <- c("SampleID", "Glacier", "Region", "Pole", "Richness", "Shannon", "Simpson", "Area")
data.i <- as.data.frame(data.i)

#remove samples without area data
data.i <- data.i[complete.cases(data.i$Area), ]

#make sure data is numeric
data.i$Richness <- as.numeric(data.i$Richness)
data.i$Shannon <- as.numeric(data.i$Shannon)
data.i$Simpson <- as.numeric(data.i$Simpson)
data.i$Area <- as.numeric(data.i$Area)

#add log10 transformtions
data.i$log10Rich <- log10(data.i$Richness)
data.i$log10Shan <- log10(data.i$Shannon)
data.i$log10Simp <- log10(data.i$Simpson)
data.i$log10Area <- log10(data.i$Area)

```

3.2  regression on log transformed data
Linear regession is a statistical model that analyzes the relationship between a response variable (richness) and explanatory variables (area).
```{r}
#RICHNESS
#Linear regression model of richness and area
lm_ISAR.i <- lm(log10Rich ~ log10Area, data = data.i)

summary(lm_ISAR.i) #c = 1.53, z=0.05, p < 0.05

#Plot the fit
ggplot(data.i, aes(x=log10Area, y=log10Rich)) + 
  geom_point()+
  geom_smooth(method=lm)+
  annotate(geom="text", x=2, y=2.5, label=paste0("p < 0.05, z=", as.numeric(round(lm_ISAR.i$coefficients[2], 3))),
              color="red")+
  ggtitle("Intermediate Taxa: ASV Richness")

#SHANNON
lm_ISAR_shan.i <- lm(log10Shan ~ log10Area, data = data.i)

summary(lm_ISAR_shan.i) #c = 0.53, z=0.005, p < 0.05

#Plot the fit
ggplot(data.i, aes(x=log10Area, y=log10Shan)) + 
  geom_point()+
  geom_smooth(method=lm)+
  annotate(geom="text", x=3, y=0.75, label=paste0("p < 0.05, z=", as.numeric(round(lm_ISAR_shan.i$coefficients[2], 3))),
              color="red")+
  ggtitle("Intermediate Taxa: Shannon Index")


#SIMPSON
lm_ISAR_simp.i <- lm(log10Simp ~ log10Area, data = data.i)

summary(lm_ISAR_simp.i) #c = -0.01, z=-0.003, p > 0.05

#Plot the fit
ggplot(data.i, aes(x=log10Area, y=log10Simp)) + 
  geom_point()+
  geom_smooth(method=lm)+
  annotate(geom="text", x=3, y=0, label=paste0("p > 0.05, z=", as.numeric(round(lm_ISAR_simp.i$coefficients[2], 3))),
              color="red")+
  ggtitle("Intermediate Taxa: Simpson Index")
```

4 RARE TAXA

4.1 Get hole area and diversity data
```{r}
#get our ASV count table
asv_counts.ra <- as.data.frame(otu_table(ps.glaciers.merged.RR))

#get sample data
samp_data.ra <- data.frame(sample_data(ps.glaciers.merged.RR))

#find the asv richness of each sample
#first convert to presence/absence table
asv_counts_pa.ra <- asv_counts.ra
asv_counts_pa.ra[asv_counts_pa.ra != 0] = 1
asv_rich.ra <- colSums(asv_counts_pa.ra)

#get shannon diversity
data.ra = t(otu_table(ps.glaciers.merged.RR))
shannon.ra <- diversity(data.ra, index="shannon")

#get simpson diversity 
simpson.ra <- diversity(data.ra, index="simpson")

#Calculate hole areas
#Method as per Darcy et al (2018)
hole_area_cm2.ra <- pi*(samp_data.ra$NS/2)*(samp_data.ra$EW/2)

#put into dataframe
data.ra <- cbind(samp_data.ra$SampleID, samp_data.ra$Glacier, samp_data.ra$Region, samp_data.ra$Pole, asv_rich.ra, shannon.ra, simpson.ra, hole_area_cm2.ra)
colnames(data.ra) <- c("SampleID", "Glacier", "Region", "Pole", "Richness", "Shannon", "Simpson", "Area")
data.ra <- as.data.frame(data.ra)

#remove samples without area data
data.ra <- data.ra[complete.cases(data.ra$Area), ]

#make sure data is numeric
data.ra$Richness <- as.numeric(data.ra$Richness)
data.ra$Shannon <- as.numeric(data.ra$Shannon)
data.ra$Simpson <- as.numeric(data.ra$Simpson)
data.ra$Area <- as.numeric(data.ra$Area)

#add log10 transformtions
data.ra$log10Rich <- log10(data.ra$Richness)
data.ra$log10Shan <- log10(data.ra$Shannon)
data.ra$log10Simp <- log10(data.ra$Simpson)
data.ra$log10Area <- log10(data.ra$Area)

```

4.2  regression on log transformed data
Linear regession is a statistical model that analyzes the relationship between a response variable (richness) and explanatory variables (area).
```{r}
#RICHNESS
#Linear regression model of richness and area
lm_ISAR.ra <- lm(log10Rich ~ log10Area, data = data.ra)

summary(lm_ISAR.ra) #c = 1.60, z=-0.04, p < 0.05

#Plot the fit
ggplot(data.ra, aes(x=log10Area, y=log10Rich)) + 
  geom_point()+
  geom_smooth(method=lm)+
  annotate(geom="text", x=2, y=2.5, label=paste0("p < 0.05, z=", as.numeric(round(lm_ISAR.ra$coefficients[2], 3))),
              color="red")+
  ggtitle("Rare Taxa: ASV Richness")

#SHANNON
lm_ISAR_shan.ra <- lm(log10Shan ~ log10Area, data = data.ra)

summary(lm_ISAR_shan.ra) #c = 0.59, z=-0.05, p < 0.05

#Plot the fit
ggplot(data.ra, aes(x=log10Area, y=log10Shan)) + 
  geom_point()+
  geom_smooth(method=lm)+
  annotate(geom="text", x=3, y=0.75, label=paste0("p < 0.05, z=", as.numeric(round(lm_ISAR_shan.ra$coefficients[2], 3))),
              color="red")+
  ggtitle("Rare Taxa: Shannon Index")


#SIMPSON
lm_ISAR_simp.ra <- lm(log10Simp ~ log10Area, data = data.ra)

summary(lm_ISAR_simp.ra) #c = 0.02, z=-0.03, p > 0.05

#Plot the fit
ggplot(data.ra, aes(x=log10Area, y=log10Simp)) + 
  geom_point()+
  geom_smooth(method=lm)+
  annotate(geom="text", x=3, y=0, label=paste0("p > 0.05, z=", as.numeric(round(lm_ISAR_simp.ra$coefficients[2], 3))),
              color="red")+
  ggtitle("Rare Taxa: Simpson Index")
```