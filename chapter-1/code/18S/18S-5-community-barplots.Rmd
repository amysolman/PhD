---
title: "good-18S-6-community-profiles"
author: "Amy Solman"
date: "05/10/2021"
output: html_document
---

This script will visualize the taxa groups present in our samples, so that differences in total, abundant, intermediate and rare communities can be compared between glaciers, regions and poles.

This will be done by:
Abundance bar plots (bar plots showing the relative abundance of each phyla within each sample/glacier/region/pole

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear workspace and load packages
```{r}
rm(list=ls())
graphics.off()

# library(ggpubr) #for making my boxplots
# library(FSA) #for dunn's test
# library(vegan) #for diversity indices
library(ggplot2) #for making plots
library(dplyr) #for manipulating data where you see %>% and computing summary stats
```

Load data 
```{r}
#Load data files
load("../data-output/18S-my-sequence-data.RData") #load all our pre-processed data files

#load phyloseq object
##################################################BOTH POLES#################################################
ps <- readRDS("../data-output/18S-my-phyloseq-object.rds") #load unrarefied phyloseq object
ps.rar <- readRDS("../data-output/18S-my-phyloseq-object-rarefied.rds") #load rarefied phyloseq objectcol

#Global abundances i.e. globally abundant, globally rare, globally intermediate
ps.global.RA <- readRDS("../data-output/18S-all-rarefied-abundant.rds") #load rarefied globally abundant phyloseq object
ps.global.RR <- readRDS("../data-output/18S-all-rarefied-rare.rds") #load rarefied globally rare phyloseq object
ps.global.I <- readRDS("../data-output/18S-all-rarefied-intermediate.rds") #load rarefied globally abundant phyloseq object

#Both poles merged regional abundances
ps.both.merged.RA <- readRDS("../data-output/18S-all-merged-rarefied-abundant.rds") #merged poles abundant phyloseq object
ps.both.merged.RR <- readRDS("../data-output/18S-all-merged-rarefied-rare.rds") #merged poles rare phyloseq object
ps.both.merged.I <- readRDS("../data-output/18S-all-merged-rarefied-intermediate.rds") #merged poles intermediate phyloseq object

#All glaciers merged abundances
ps.glaciers.merged.RA <- readRDS("../data-output/18S-all-glaciers-merged-rarefied-abundant.rds") #merged glaciers abundant phyloseq object
ps.glaciers.merged.RR <- readRDS("../data-output/18S-all-glaciers-merged-rarefied-rare.rds") #merged glaciers rare phyloseq object
ps.glaciers.merged.I <- readRDS("../data-output/18S-all-glaciers-merged-rarefied-intermediate.rds") #merged glaciers intermediate phyloseq object

##################################################ARCTIC#################################################
ps.arc <- readRDS("../data-output/18S-arctic-rarefied.rds")
ps.arc.RA <- readRDS("../data-output/18S-arctic-rarefied-abundant.rds") #load rarefied arctic abundant phyloseq object
ps.arc.RR <- readRDS("../data-output/18S-arctic-rarefied-rare.rds") #load rarefied arctic rare phyloseq object
ps.arc.I <- readRDS("../data-output/18S-arctic-rarefied-intermediate.rds") #load rarefied arctic intermediate phyloseq object

##################################################ANTARCTIC#################################################
ps.ant <- readRDS("../data-output/18S-antarctic-rarefied.rds")
ps.ant.RA <- readRDS("../data-output/18S-antarctic-rarefied-abundant.rds") #load rarefied antarctic abundant phyloseq object
ps.ant.RR <- readRDS("../data-output/18S-antarctic-rarefied-rare.rds") #load rarefied antarctic rare phyloseq object
ps.ant.I <- readRDS("../data-output/18S-antarctic-rarefied-intermediate.rds") #load rarefied antarctic intermediate phyloseq object
```
1 TOTAL TAXA
1.1 Abundance Bar Plots
```{r}
#Agglomerate ASVs by phyla into dataframes ready for plotting
df.ps.rar <- ps.rar %>%
  tax_glom(taxrank = "Phylum", NArm=FALSE) %>%
  psmelt()

#Glacier
ggplot(df.ps.rar, aes(x = Glacier, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Glacier")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Region
ggplot(df.ps.rar, aes(x = Region, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Region")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Pole
ggplot(df.ps.rar, aes(x = Pole, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Pole")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```
1.2 Another bar plot
```{r}
#convert to relative abundance
ps_rel_abund = phyloseq::transform_sample_counts(ps.rar, function(x){x / sum(x)})

#plot
#Glacier
phyloseq::plot_bar(ps_rel_abund, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Glacier, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Region
phyloseq::plot_bar(ps_rel_abund, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Region, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Pole
phyloseq::plot_bar(ps_rel_abund, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Pole, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

```
1.3 Comparing phyla for both poles
```{r}
#Agglomerate taxa to phylum level
ps_phylum <- phyloseq::tax_glom(ps.rar, "Phylum")
phyloseq::taxa_names(ps_phylum) <- phyloseq::tax_table(ps_phylum)[, "Phylum"]

#plot
phyloseq::psmelt(ps_phylum) %>%
ggplot(data = ., aes(x = Pole, y = Abundance)) +
  geom_boxplot(outlier.shape  = NA) +
  geom_jitter(aes(color = Phylum), height = 0, width = .2) +
  labs(x = "", y = "Abundance\n") +
  facet_wrap(~ Phylum, scales = "free")

```

2 ABUNDANT TAXA
2.1 Abundance Bar Plots
```{r}
#Agglomerate ASVs by phyla into dataframes ready for plotting
df.ps.rar.ab <- ps.glaciers.merged.RA %>%
  tax_glom(taxrank = "Phylum", NArm=FALSE) %>%
  psmelt()

#Glacier
ggplot(df.ps.rar.ab, aes(x = Glacier, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Glacier")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Region
ggplot(df.ps.rar.ab, aes(x = Region, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Region")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Pole
ggplot(df.ps.rar.ab, aes(x = Pole, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Pole")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```
2.2 Another bar plot
```{r}
#convert to relative abundance
ps_rel_abund.ab = phyloseq::transform_sample_counts(ps.glaciers.merged.RA, function(x){x / sum(x)})

#plot
#Glacier
phyloseq::plot_bar(ps_rel_abund.ab, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Glacier, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Region
phyloseq::plot_bar(ps_rel_abund.ab, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Region, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Pole
phyloseq::plot_bar(ps_rel_abund.ab, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Pole, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

```
2.3 Comparing phyla for both poles
```{r}
#Agglomerate taxa to phylum level
ps_phylum.ab <- phyloseq::tax_glom(ps.glaciers.merged.RA, "Phylum")
phyloseq::taxa_names(ps_phylum.ab) <- phyloseq::tax_table(ps_phylum.ab)[, "Phylum"]

#plot
phyloseq::psmelt(ps_phylum.ab) %>%
ggplot(data = ., aes(x = Pole, y = Abundance)) +
  geom_boxplot(outlier.shape  = NA) +
  geom_jitter(aes(color = Phylum), height = 0, width = .2) +
  labs(x = "", y = "Abundance\n") +
  facet_wrap(~ Phylum, scales = "free")

```

3 INTERMEDIATE TAXA
3.1 Abundance Bar Plots
```{r}
#Agglomerate ASVs by phyla into dataframes ready for plotting
df.ps.rar.i <- ps.glaciers.merged.I %>%
  tax_glom(taxrank = "Phylum", NArm=FALSE) %>%
  psmelt()

#Glacier
ggplot(df.ps.rar.i, aes(x = Glacier, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Glacier")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Region
ggplot(df.ps.rar.i, aes(x = Region, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Region")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Pole
ggplot(df.ps.rar.i, aes(x = Pole, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Pole")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```
3.2 Another bar plot
```{r}
#convert to relative abundance
ps_rel_abund.i = phyloseq::transform_sample_counts(ps.glaciers.merged.I, function(x){x / sum(x)})

#plot
#Glacier
phyloseq::plot_bar(ps_rel_abund.i, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Glacier, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Region
phyloseq::plot_bar(ps_rel_abund.i, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Region, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Pole
phyloseq::plot_bar(ps_rel_abund.i, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Pole, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

```
3.3 Comparing phyla for both poles
```{r}
#Agglomerate taxa to phylum level
ps_phylum.i <- phyloseq::tax_glom(ps.glaciers.merged.I, "Phylum")
phyloseq::taxa_names(ps_phylum.i) <- phyloseq::tax_table(ps_phylum.i)[, "Phylum"]

#plot
phyloseq::psmelt(ps_phylum.i) %>%
ggplot(data = ., aes(x = Pole, y = Abundance)) +
  geom_boxplot(outlier.shape  = NA) +
  geom_jitter(aes(color = Phylum), height = 0, width = .2) +
  labs(x = "", y = "Abundance\n") +
  facet_wrap(~ Phylum, scales = "free")

```

4 RARE TAXA
4.1 Abundance Bar Plots
```{r}
#Agglomerate ASVs by phyla into dataframes ready for plotting
df.ps.rar.ra <- ps.glaciers.merged.RR %>%
  tax_glom(taxrank = "Phylum", NArm=FALSE) %>%
  psmelt()

#Glacier
ggplot(df.ps.rar.ra, aes(x = Glacier, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Glacier")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Region
ggplot(df.ps.rar.ra, aes(x = Region, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Region")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Pole
ggplot(df.ps.rar.ra, aes(x = Pole, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Pole")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```
4.2 Another bar plot
```{r}
#convert to relative abundance
ps_rel_abund.ra = phyloseq::transform_sample_counts(ps.glaciers.merged.RR, function(x){x / sum(x)})

#plot
#Glacier
phyloseq::plot_bar(ps_rel_abund.ra, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Glacier, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Region
phyloseq::plot_bar(ps_rel_abund.ra, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Region, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Pole
phyloseq::plot_bar(ps_rel_abund.ra, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Pole, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

```
4.3 Comparing phyla for both poles
```{r}
#Agglomerate taxa to phylum level
ps_phylum.ra <- phyloseq::tax_glom(ps.glaciers.merged.RR, "Phylum")
phyloseq::taxa_names(ps_phylum.ra) <- phyloseq::tax_table(ps_phylum.ra)[, "Phylum"]

#plot
phyloseq::psmelt(ps_phylum.ra) %>%
ggplot(data = ., aes(x = Pole, y = Abundance)) +
  geom_boxplot(outlier.shape  = NA) +
  geom_jitter(aes(color = Phylum), height = 0, width = .2) +
  labs(x = "", y = "Abundance\n") +
  facet_wrap(~ Phylum, scales = "free")

```