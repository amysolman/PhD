---
title: "18S-4a-alpha-diversity"
author: "Amy Solman"
date: "29/09/2021"
output: html_document
---

This script will be quantifying the alpha diversity of our communities:
ASV Richness
Shannon Diversity
Simpson Diversity 
Pielou Index

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Clear workspace and load packages
```{r}
rm(list=ls())
graphics.off()

library(dplyr) #for computing summary statistics
library(ggpubr) #for making my boxplots
library(FSA) #for dunn's test
library(vegan) #for diversity indices
```


Load data 
```{r}
#Load data files
load("../data-output/18S-my-sequence-data.RData") #load all our pre-processed data files

#load phyloseq object
##################################################BOTH POLES#################################################
ps <- readRDS("../data-output/18S-my-phyloseq-object.rds") #load unrarefied phyloseq object
ps.rar <- readRDS("../data-output/18S-my-phyloseq-object-rarefied.rds") #load rarefied phyloseq objectcol

#Global abundances i.e. globally abundant, globally rare, globally intermediate
ps.global.RA <- readRDS("../data-output/18S-all-rarefied-abundant.rds") #load rarefied globally abundant phyloseq object
ps.global.RR <- readRDS("../data-output/18S-all-rarefied-rare.rds") #load rarefied globally rare phyloseq object
ps.global.I <- readRDS("../data-output/18S-all-rarefied-intermediate.rds") #load rarefied globally abundant phyloseq object

#Both poles merged regional abundances
ps.both.merged.RA <- readRDS("../data-output/18S-all-merged-rarefied-abundant.rds") #merged poles abundant phyloseq object
ps.both.merged.RR <- readRDS("../data-output/18S-all-merged-rarefied-rare.rds") #merged poles rare phyloseq object
ps.both.merged.I <- readRDS("../data-output/18S-all-merged-rarefied-intermediate.rds") #merged poles intermediate phyloseq object

#All glaciers merged abundances
ps.glaciers.merged.RA <- readRDS("../data-output/18S-all-glaciers-merged-rarefied-abundant.rds") #merged glaciers abundant phyloseq object
ps.glaciers.merged.RR <- readRDS("../data-output/18S-all-glaciers-merged-rarefied-rare.rds") #merged glaciers rare phyloseq object
ps.glaciers.merged.I <- readRDS("../data-output/18S-all-glaciers-merged-rarefied-intermediate.rds") #merged glaciers intermediate phyloseq object

##################################################ARCTIC#################################################
ps.arc <- readRDS("../data-output/18S-arctic-rarefied.rds")
ps.arc.RA <- readRDS("../data-output/18S-arctic-rarefied-abundant.rds") #load rarefied arctic abundant phyloseq object
ps.arc.RR <- readRDS("../data-output/18S-arctic-rarefied-rare.rds") #load rarefied arctic rare phyloseq object
ps.arc.I <- readRDS("../data-output/18S-arctic-rarefied-intermediate.rds") #load rarefied arctic intermediate phyloseq object

##################################################ANTARCTIC#################################################
ps.ant <- readRDS("../data-output/18S-antarctic-rarefied.rds")
ps.ant.RA <- readRDS("../data-output/18S-antarctic-rarefied-abundant.rds") #load rarefied antarctic abundant phyloseq object
ps.ant.RR <- readRDS("../data-output/18S-antarctic-rarefied-rare.rds") #load rarefied antarctic rare phyloseq object
ps.ant.I <- readRDS("../data-output/18S-antarctic-rarefied-intermediate.rds") #load rarefied antarctic intermediate phyloseq object
```
PART ONE

SECTION ONE
TOTAL TAXA
1.1.1 Pull total taxa data from phyloseq object and create dataframe
1.1.2 Total taxa for each glacier + summary stats
1.1.3 Total taxa for each region + summary stats
1.1.4 Total taxa for each pole + summary stats
1.1.5 Boxplots showing range of Total richnesses for glacier/region/pole
1.1.6 Significant tests for differences between glaciers/regions/poles
1.1.7 Test the validity of the ANOVA
1.1.8 Run kruskal wallis tests if data do not meet ANOVA assumption
1.1.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
1.1.10 Use dunn's test to see which glaciers are different
1.1.11 Which of the poles has significantly higher Total richness

1.1.1 Pull total taxa data from phyloseq object and create dataframe
```{r}
#What is the total taxa asv richness for each glacier?

#get our ASV count table from ps.rar (contains total data)
asv_counts <- as.data.frame(otu_table(ps.rar))

#get sample data from ps.rar 
samp_data <- data.frame(sample_data(ps.rar))

#find the asv richness of each sample
#first convert to presence/absence table
asv_counts_pa <- asv_counts
asv_counts_pa[asv_counts_pa != 0] = 1
asv_rich <- colSums(asv_counts_pa)
tot_asv_rich <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, asv_rich)
colnames(tot_asv_rich) <- c("SampleID", "Glacier", "Region", "Pole", "Richness")
tot_asv_rich <- as.data.frame(tot_asv_rich)
tot_asv_rich$Richness <- as.numeric(tot_asv_rich$Richness)

```

1.1.2 Total taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(tot_asv_rich, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(Richness, na.rm=TRUE),
    sd = sd(Richness, na.rm=TRUE)
  )


```

1.1.3 Total taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(tot_asv_rich, Region) %>%
  summarise(
    count=n(),
    mean=mean(Richness, na.rm=TRUE),
    sd = sd(Richness, na.rm=TRUE)
  )
```

1.1.4 Total taxa for each pole + summary stats
```{r}
#compute summar stats for each pole
group_by(tot_asv_rich, Pole) %>%
  summarise(
    count=n(),
    mean=mean(Richness, na.rm=TRUE),
    sd = sd(Richness, na.rm=TRUE)
  )
```

1.1.5 Boxplots showing range of Total richnesses for glacier/region/pole
```{r}
# #plot total richness for each region
# ggboxplot(tot_asv_rich, x="Glacier", y="Richness",
#           color="Glacier", ylab="ASV Richness", xlab="Glacier")

ggplot(tot_asv_rich, aes(x=Glacier, y=Richness, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0, 300)+
  theme_bw()+
  ylab("ASV Richness")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# #plot total richness for each region
# ggboxplot(tot_asv_rich, x="Region", y="Richness",
#           color="Region", ylab="ASV Richness", xlab="Region")

ggplot(tot_asv_rich, aes(x=Region, y=Richness, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0, 300)+
  theme_bw()+
  ylab("ASV Richness")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# #plot total richness for each pole
# ggboxplot(tot_asv_rich, x="Pole", y="Richness",
#           color="Pole", ylab="ASV Richness", xlab="Pole")

ggplot(tot_asv_rich, aes(x=Pole, y=Richness, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0, 300)+
  theme_bw()+
  ylab("ASV Richness")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

1.1.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier asv richness
#ANOVA
res.aov.tot.gla <- aov(Richness ~ Glacier, data = tot_asv_rich)
#Summary of analysis
summary(res.aov.tot.gla) #p value > 0.05 no significant difference between glaciers

#Test for significant differences between region asv richness
#ANOVA
res.aov.tot.reg <- aov(Richness ~ Region, data = tot_asv_rich)
#Summary of analysis
summary(res.aov.tot.reg) #p value > 0.05 no significant difference between regions
```

1.1.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(Richness ~ Glacier, data = tot_asv_rich) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.tot.gla <- residuals(object = res.aov.tot.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.tot.gla) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

#REGION
#use levene's test to check homogeny of variances
leveneTest(Richness ~ Region, data = tot_asv_rich) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.tot.reg <- residuals(object = res.aov.tot.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.tot.reg) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

```

1.1.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between glaciers
kruskal.test(Richness ~ Glacier, data = tot_asv_rich) #p < 0.05 so the differences between the medians are statistically significant

#Differences between regions
kruskal.test(Richness ~ Region, data = tot_asv_rich) #p > 0.05 so the differences between the medians are not statistically significant

```


1.1.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Richness
with(tot_asv_rich, shapiro.test(Richness[Pole == "Arctic"]))# p > 0.05 so normally distributed

# Shapiro-Wilk normality test for Antarctic Richness
with(tot_asv_rich, shapiro.test(Richness[Pole == "Antarctic"])) #p < 0.05 not normally distributed

#Do the two populations have the same variances?
res.ftest.tot.pol <- var.test(Richness ~ Pole, data = tot_asv_rich)
res.ftest.tot.pol #p < 0.05 so variances are significantly different

#NEED NON-PARAMETRIC TEST
res.tot.pol <- wilcox.test(Richness ~ Pole, data = tot_asv_rich, exact = FALSE)
res.tot.pol # p < 0.05 the median Richness between poles are significantly different
```

1.1.10 Use dunn's test to see which glaciers are different
```{r}

#We have detected significant differences in asv richness between the glaciers and between the poles, but no significant differences between the regions

# pairwise.wilcox.test(tot_asv_rich$Richness, tot_asv_rich$Glacier,
#                  p.adjust.method = "BH")


dunnTest(Richness ~ Glacier, data=tot_asv_rich, method="bh")

```

1.1.11 Which of the poles has significantly higher Total richness
```{r}
wilcox.test(tot_asv_rich$Richness ~ tot_asv_rich$Pole,
  alternative = "less"
)
# p < 0.05 so the Antarctic has significantly lower asv richness than the Arctic
```

ABUNDANT TAXA
1.2.1 Pull abundant taxa data from phyloseq object and create dataframe
1.2.2 Abundant taxa for each glacier + summary stats
1.2.3 Abundant taxa for each region + summary stats
1.2.4 Abundant taxa for each pole + summary stats
1.2.5 Boxplots showing range of Abundant richnesses for glacier/region/pole
1.2.6 Significant tests for differences between glaciers/regions/poles
1.2.7 Test the validity of the ANOVA
1.2.8 Run kruskal wallis tests if data do not meet ANOVA assumption
1.2.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
1.2.10 Use pairwise wilcoxon test to see which glaciers are different
1.2.11 Which of the poles has significantly higher Abundant richness

1.2.1 Pull abundant taxa data from phyloseq object and create dataframe
```{r}
#What is the abundant taxa asv richness for each glacier?

#get our ASV count table from ps.rar (contains merged pole abundances)
asv_counts <- as.data.frame(otu_table(ps.glaciers.merged.RA))

#get sample data from ps.rar 
samp_data <- data.frame(sample_data(ps.both.merged.RA))

#find the asv richness of each sample
#first convert to presence/absence table
asv_counts_pa <- asv_counts
asv_counts_pa[asv_counts_pa != 0] = 1
asv_rich <- colSums(asv_counts_pa)
ab_asv_rich <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, asv_rich)
colnames(ab_asv_rich) <- c("SampleID", "Glacier", "Region", "Pole", "Richness")
ab_asv_rich <- as.data.frame(ab_asv_rich)
ab_asv_rich$Richness <- as.numeric(ab_asv_rich$Richness)
```

1.2.2 Abundant taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(ab_asv_rich, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(Richness, na.rm=TRUE),
    sd = sd(Richness, na.rm=TRUE)
  )
```

1.2.3 Abundant taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(ab_asv_rich, Region) %>%
  summarise(
    count=n(),
    mean=mean(Richness, na.rm=TRUE),
    sd = sd(Richness, na.rm=TRUE)
  )
```

1.2.4 Abundant taxa for each pole + summary stats
```{r}
#compute summar stats for each pole
group_by(ab_asv_rich, Pole) %>%
  summarise(
    count=n(),
    mean=mean(Richness, na.rm=TRUE),
    sd = sd(Richness, na.rm=TRUE)
  )
```

1.2.5 Boxplots showing range of Abundant richnesses for glacier/region/pole
```{r}
#plot abundant richness for each region
ggboxplot(ab_asv_rich, x="Glacier", y="Richness",
          color="Glacier", ylab="ASV Richness", xlab="Glacier")

#plot abundant richness for each region
ggboxplot(ab_asv_rich, x="Region", y="Richness",
          color="Region", ylab="ASV Richness", xlab="Region")

#plot abundant richness for each pole
ggboxplot(ab_asv_rich, x="Pole", y="Richness",
          color="Pole", ylab="ASV Richness", xlab="Pole")


ggplot(ab_asv_rich, aes(x=Glacier, y=Richness, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0, 300)+
  theme_bw()+
  ylab("ASV Richness")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(ab_asv_rich, aes(x=Region, y=Richness, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0, 300)+
  theme_bw()+
  ylab("ASV Richness")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(ab_asv_rich, aes(x=Pole, y=Richness, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0, 300)+
  theme_bw()+
  ylab("ASV Richness")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))


```

1.2.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier asv richness
#ANOVA
res.aov.ab.gla <- aov(Richness ~ Glacier, data = ab_asv_rich)
#Summary of analysis
summary(res.aov.ab.gla) #p value < 0.05 there is a significant difference between glaciers

#Test for significant differences between region asv richness
#ANOVA
res.aov.ab.reg <- aov(Richness ~ Region, data = ab_asv_rich)
#Summary of analysis
summary(res.aov.ab.reg) #p value < 0.05 there is a significant difference between regions
```


1.2.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(Richness ~ Glacier, data = ab_asv_rich) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ab.gla <- residuals(object = res.aov.ab.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ab.gla) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

#REGION
#use levene's test to check homogeny of variances
leveneTest(Richness ~ Region, data = ab_asv_rich) #p ? 0.05 so evidence to suggest variance across groups is NOT significantly different so data does meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ab.reg <- residuals(object = res.aov.ab.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ab.reg) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

```

1.2.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between glaciers
kruskal.test(Richness ~ Glacier, data = ab_asv_rich) #p < 0.05 so the differences between the medians ARE statistically significant

#Differences between regions
kruskal.test(Richness ~ Region, data = ab_asv_rich) #p < 0.05 so the differences between the medians ARE statistically significant

```


1.2.9 Two sample t-test or wilcoxon test for differences between two groups (poles)

```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Richness
with(ab_asv_rich, shapiro.test(Richness[Pole == "Arctic"]))# p > 0.05 so normally distributed

# Shapiro-Wilk normality test for Antarctic Richness
with(ab_asv_rich, shapiro.test(Richness[Pole == "Antarctic"])) #p < 0.05 not normally distributed

#Do the two populations have the same variances?
res.ftest.ab.pol <- var.test(Richness ~ Pole, data = ab_asv_rich)
res.ftest.ab.pol #p > 0.05 so variances are NOT significantly different

#NEED NON-PARAMETRIC TEST
res.ab.pol <- wilcox.test(Richness ~ Pole, data = ab_asv_rich, exact = FALSE)
res.ab.pol # p < 0.05 the median Richness between poles ARE significantly different
```

1.2.10 Use pairwise wilcoxon test to see which glaciers and regions are different
Check out this thread for info on why the post hoc pairwise wilcox test didn't show significant differences, while the kruskal wallis test did - https://stats.stackexchange.com/questions/434037/why-does-the-kruskal-wallis-test-shows-a-difference-but-wilcoxon-doesnt-find-an 
```{r}

#We have detected significant differences in asv richness between the glaciers, regions and between the poles
# pairwise.wilcox.test(ab_asv_rich$Richness, ab_asv_rich$Glacier,
#                  p.adjust.method = "BH", exact=FALSE) #This doesn't tell us anything useful about the data 

#Try Dunn's test as a more appropriate post hoc 
dunnTest(Richness ~ Glacier, data=ab_asv_rich, method="bh")

# pairwise.wilcox.test(ab_asv_rich$Richness, ab_asv_rich$Region,
#                  p.adjust.method = "BH", exact=FALSE) 

dunnTest(Richness ~ Region, data=ab_asv_rich, method="bh")

```

1.2.11 Which of the poles has significantly higher Abundant richness
```{r}
wilcox.test(ab_asv_rich$Richness ~ ab_asv_rich$Pole,
  alternative = "less"
)
# p < 0.05 so the Antarctic has significantly lower abundant asv richness than the Arctic
```

INTERMEDIATE TAXA
1.3.1 Pull intermediate taxa data from phyloseq object and create dataframe
1.3.2 Intermediate taxa for each glacier + summary stats
1.3.3 Intermediate taxa for each region + summary stats
1.3.4 Intermediate taxa for each pole + summary stats
1.3.5 Boxplots showing range of Intermediate richnesses for glacier/region/pole
1.3.6 Significant tests for differences between glaciers/regions/poles
1.3.7 Test the validity of the ANOVA
1.3.8 Run kruskal wallis tests if data do not meet ANOVA assumption
1.3.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
1.3.10 Use dunn's test to see which glaciers/regions are different
1.3.11 Which of the poles has significantly higher Abundant richness

1.3.1 Pull intermediate taxa data from phyloseq object and create dataframe
```{r}
#get our ASV count table
asv_counts <- as.data.frame(otu_table(ps.glaciers.merged.I))

#get sample data from ps.rar 
samp_data <- data.frame(sample_data(ps.glaciers.merged.I))

#find the asv richness of each sample
#first convert to presence/absence table
asv_counts_pa <- asv_counts
asv_counts_pa[asv_counts_pa != 0] = 1
asv_rich <- colSums(asv_counts_pa)
i_asv_rich <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, asv_rich)
colnames(i_asv_rich) <- c("SampleID", "Glacier", "Region", "Pole", "Richness")
i_asv_rich <- as.data.frame(i_asv_rich)
i_asv_rich$Richness <- as.numeric(i_asv_rich$Richness)
```

1.3.2 Intermediate taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(i_asv_rich, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(Richness, na.rm=TRUE),
    sd = sd(Richness, na.rm=TRUE)
  )
```

1.3.3 Intermediate taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(i_asv_rich, Region) %>%
  summarise(
    count=n(),
    mean=mean(Richness, na.rm=TRUE),
    sd = sd(Richness, na.rm=TRUE)
  )
```

1.3.4 Intermediate taxa for each pole + summary stats
```{r}
#compute summar stats for each pole
group_by(i_asv_rich, Pole) %>%
  summarise(
    count=n(),
    mean=mean(Richness, na.rm=TRUE),
    sd = sd(Richness, na.rm=TRUE)
  )
```

1.3.5 Boxplots showing range of Intermediate richnesses for glacier/region/pole
```{r}
#plot richness for each region
ggboxplot(i_asv_rich, x="Glacier", y="Richness",
          color="Glacier", ylab="ASV Richness", xlab="Glacier")

#plot richness for each region
ggboxplot(i_asv_rich, x="Region", y="Richness",
          color="Region", ylab="ASV Richness", xlab="Region")

#plot richness for each pole
ggboxplot(i_asv_rich, x="Pole", y="Richness",
          color="Pole", ylab="ASV Richness", xlab="Pole")

ggplot(i_asv_rich, aes(x=Glacier, y=Richness, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0, 150)+
  theme_bw()+
  ylab("ASV Richness")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(i_asv_rich, aes(x=Region, y=Richness, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0, 150)+
  theme_bw()+
  ylab("ASV Richness")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(i_asv_rich, aes(x=Pole, y=Richness, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0, 150)+
  theme_bw()+
  ylab("ASV Richness")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

1.3.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier asv richness
#ANOVA
res.aov.i.gla <- aov(Richness ~ Glacier, data = i_asv_rich)
#Summary of analysis
summary(res.aov.i.gla) #p value < 0.05 there is a significant difference between glaciers

#Test for significant differences between region asv richness
#ANOVA
res.aov.i.reg <- aov(Richness ~ Region, data = i_asv_rich)
#Summary of analysis
summary(res.aov.i.reg) #p value > 0.05 there is NO significant difference between regions
```


1.3.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(Richness ~ Glacier, data = i_asv_rich) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.i.gla <- residuals(object = res.aov.i.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.i.gla) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

#REGION
#use levene's test to check homogeny of variances
leveneTest(Richness ~ Region, data = i_asv_rich) #p > 0.05 no evidence to suggest variance across groups is significantly different so data does meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.i.reg <- residuals(object = res.aov.i.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.i.reg) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

```

1.3.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between glaciers
kruskal.test(Richness ~ Glacier, data = i_asv_rich) #p < 0.05 so the differences between the medians ARE statistically significant

#Differences between regions
kruskal.test(Richness ~ Region, data = i_asv_rich) #p > 0.05 so the differences between the medians are NOT statistically significant

```


1.3.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Richness
with(i_asv_rich, shapiro.test(Richness[Pole == "Arctic"]))# p > 0.05 normally distributed

# Shapiro-Wilk normality test for Antarctic Richness
with(i_asv_rich, shapiro.test(Richness[Pole == "Antarctic"])) #p < 0.05 not normally distributed

#Do the two populations have the same variances?
res.ftest.i.pol <- var.test(Richness ~ Pole, data = i_asv_rich)
res.ftest.i.pol #p > 0.05 so variances are NOT significantly different

#NEED NON-PARAMETRIC TEST
res.i.pol <- wilcox.test(Richness ~ Pole, data = i_asv_rich, exact = FALSE)
res.i.pol # p < 0.05 the median Richness between poles ARE significantly different
```

1.3.10 Use dunn's test to see which glaciers and regions are different
```{r}
# #We have detected significant differences in asv richness between the glaciers and between the poles
dunnTest(Richness ~ Glacier, data=i_asv_rich, method="bh")

```

1.3.11 Which of the poles has significantly higher richness
```{r}
wilcox.test(i_asv_rich$Richness ~ i_asv_rich$Pole,
  alternative = "less"
)
# p < 0.05 so the Antarctic has significantly lower asv richness than the Arctic
```

RARE TAXA
1.4.1 Pull rare taxa data from phyloseq object and create dataframe
1.4.2 Rare taxa for each glacier + summary stats
1.4.3 Rare taxa for each region + summary stats
1.4.4 Rare taxa for each pole + summary stats
1.4.5 Boxplots showing range of Rare richnesses for glacier/region/pole
1.4.6 Significant tests for differences between glaciers/regions/poles
1.4.7 Test the validity of the ANOVA
1.4.8 Run kruskal wallis tests if data do not meet ANOVA assumption
1.4.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
1.4.10 Use dunn's test to see which glaciers/regions are different
1.4.11 Which of the poles has significantly higher Abundant richness

1.4.1 Pull rare taxa data from phyloseq object and create dataframe
```{r}
#get our ASV count table
asv_counts <- as.data.frame(otu_table(ps.glaciers.merged.RR))

#get sample data from ps.rar 
samp_data <- data.frame(sample_data(ps.glaciers.merged.RR))

#find the asv richness of each sample
#first convert to presence/absence table
asv_counts_pa <- asv_counts
asv_counts_pa[asv_counts_pa != 0] = 1
asv_rich <- colSums(asv_counts_pa)
ra_asv_rich <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, asv_rich)
colnames(ra_asv_rich) <- c("SampleID", "Glacier", "Region", "Pole", "Richness")
ra_asv_rich <- as.data.frame(ra_asv_rich)
ra_asv_rich$Richness <- as.numeric(ra_asv_rich$Richness)
```

1.4.2 Rare taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(ra_asv_rich, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(Richness, na.rm=TRUE),
    sd = sd(Richness, na.rm=TRUE)
  )
```

1.4.3 Rare taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(ra_asv_rich, Region) %>%
  summarise(
    count=n(),
    mean=mean(Richness, na.rm=TRUE),
    sd = sd(Richness, na.rm=TRUE)
  )
```

1.4.4 Rare taxa for each pole + summary stats
```{r}
#compute summar stats for each pole
group_by(ra_asv_rich, Pole) %>%
  summarise(
    count=n(),
    mean=mean(Richness, na.rm=TRUE),
    sd = sd(Richness, na.rm=TRUE)
  )
```

1.4.5 Boxplots showing range of Rare richnesses for glacier/region/pole
```{r}
# #plot richness for each region
# ggboxplot(ra_asv_rich, x="Glacier", y="Richness",
#           color="Glacier", ylab="ASV Richness", xlab="Glacier")

#plot richness with outliers removed
ggplot(ra_asv_rich, aes(x=Glacier, y=Richness, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0, 85)+
  theme_bw()+
  ylab("ASV Richness")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# #plot richness for each region
# ggboxplot(ra_asv_rich, x="Region", y="Richness",
#           color="Region", ylab="ASV Richness", xlab="Region")

#plot richness with outliers removed
ggplot(ra_asv_rich, aes(x=Region, y=Richness, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0, 85)+
  theme_bw()+
  ylab("ASV Richness")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# #plot richness for each pole
# ggboxplot(ra_asv_rich, x="Pole", y="Richness",
#           color="Pole", ylab="ASV Richness", xlab="Pole")

#plot richness with outliers removed
ggplot(ra_asv_rich, aes(x=Pole, y=Richness, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0, 85)+
  theme_bw()+
  ylab("ASV Richness")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

1.4.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier asv richness
#ANOVA
res.aov.ra.gla <- aov(Richness ~ Glacier, data = ra_asv_rich)
#Summary of analysis
summary(res.aov.ra.gla) #p value > 0.05 there is NO significant difference between glaciers

#Test for significant differences between region asv richness
#ANOVA
res.aov.ra.reg <- aov(Richness ~ Region, data = ra_asv_rich)
#Summary of analysis
summary(res.aov.ra.reg) #p value > 0.05 there is NO significant difference between regions
```


1.4.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(Richness ~ Glacier, data = ra_asv_rich) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ra.gla <- residuals(object = res.aov.ra.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ra.gla) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

#REGION
#use levene's test to check homogeny of variances
leveneTest(Richness ~ Region, data = ra_asv_rich) #p > 0.05 no evidence to suggest variance across groups is significantly different so data does meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ra.reg <- residuals(object = res.aov.ra.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ra.reg) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

```

1.4.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between glaciers
kruskal.test(Richness ~ Glacier, data = ra_asv_rich) #p < 0.05 so the differences between the medians ARE statistically significant

#Differences between regions
kruskal.test(Richness ~ Region, data = ra_asv_rich) #p > 0.05 so the differences between the medians are NOT statistically significant

```


1.4.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Richness
with(ra_asv_rich, shapiro.test(Richness[Pole == "Arctic"]))# p > 0.05 normally distributed

# Shapiro-Wilk normality test for Antarctic Richness
with(ra_asv_rich, shapiro.test(Richness[Pole == "Antarctic"])) #p < 0.05 not normally distributed

#Do the two populations have the same variances?
res.ftest.ra.pol <- var.test(Richness ~ Pole, data = ra_asv_rich)
res.ftest.ra.pol #p < 0.05 so variances ARE significantly different

#NEED NON-PARAMETRIC TEST
res.ra.pol <- wilcox.test(Richness ~ Pole, data = ra_asv_rich, exact = FALSE)
res.ra.pol # p > 0.05 the median Richness between poles are NOT significantly different
```

1.4.10 Use dunn's test to see which glaciers and regions are different
```{r}
# #We have detected significant differences in asv richness between the glaciers
dunnTest(Richness ~ Glacier, data=i_asv_rich, method="bh")
```

1.4.11 Which of the poles has significantly higher richness? Won't do this because there is no significant difference
```{r}
# wilcox.test(i_asv_rich$Richness ~ i_asv_rich$Pole,
#   alternative = "less"
# )
```

1.5 Plots
1.5.1 Plot this as a barplot showing distribution of abundant/intermediate/rare for each glacier/region/pole
1.5.2 Plot this as a boxplot showing the range of values (abundant/rare/intermediate)

1.5.1 Plot this as a barplot showing distribution of abundant/intermediate/rare for each glacier/region/pole
```{r}
#Add abundant/rare/intermediate column to our count tables
ab_asv_rich$Abundance <- "Abundant"
i_asv_rich$Abundance <- "Intermediate"
ra_asv_rich$Abundance <- "Rare"

#merge dataframes
df <- rbind(ab_asv_rich, i_asv_rich, ra_asv_rich)

# Grouped
ggplot(df, aes(fill=Abundance, y=Richness, x=Glacier)) + 
    geom_bar(position="fill", stat="identity")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(df, aes(fill=Abundance, y=Richness, x=Region)) + 
    geom_bar(position="fill", stat="identity")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(df, aes(fill=Abundance, y=Richness, x=Pole)) + 
    geom_bar(position="fill", stat="identity")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

1.5.2 Plot this as a boxplot showing the range of values (abundant/rare/intermediate)
```{r}
# Basic boxplot
ggplot(df, aes(x=Abundance, y=Richness, color=Abundance, fill=Pole))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0, 150)+
  theme_bw()+
  ylab("ASV Richness")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")

```

PART TWO SHANNON INDEX
TOTAL TAXA
2.1.1 Pull total taxa data from phyloseq object and create dataframe
2.1.2 Total taxa for each glacier + summary stats
2.1.3 Total taxa for each region + summary stats
2.1.4 Total taxa for each pole + summary stats
2.1.5 Boxplots showing range of Total richnesses for glacier/region/pole
2.1.6 Significant tests for differences between glaciers/regions/poles
2.1.7 Test the validity of the ANOVA
2.1.8 Run kruskal wallis tests if data do not meet ANOVA assumption
2.1.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
2.1.10 Use dunn's test to see which glaciers are different

2.1.1 Pull total taxa data from phyloseq object and create dataframe
```{r}
#What is the total taxa shannon index for each glacier?

#get our ASV count table from ps.rar (contains total data)
asv_counts <- as.data.frame(otu_table(ps.rar))

#get sample data from ps.rar 
samp_data <- data.frame(sample_data(ps.rar))

#find shannon index of each sample
#make a new dataframe with shannon as the shannon diversity index of each sample
data = t(otu_table(ps.rar))
shannon <- diversity(data, index="shannon")
tot_shan <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, shannon)
colnames(tot_shan) <- c("SampleID", "Glacier", "Region", "Pole", "ShannonIndex")
tot_shan <- as.data.frame(tot_shan)
tot_shan$ShannonIndex <- as.numeric(tot_shan$ShannonIndex)
```

2.1.2 Total taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(tot_shan, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(ShannonIndex, na.rm=TRUE),
    sd = sd(ShannonIndex, na.rm=TRUE)
  )
```

2.1.3 Total taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(tot_shan, Region) %>%
  summarise(
    count=n(),
    mean=mean(ShannonIndex, na.rm=TRUE),
    sd = sd(ShannonIndex, na.rm=TRUE)
  )
```

2.1.4 Total taxa for each pole + summary stats
```{r}
#compute summar stats for each pole
group_by(tot_shan, Pole) %>%
  summarise(
    count=n(),
    mean=mean(ShannonIndex, na.rm=TRUE),
    sd = sd(ShannonIndex, na.rm=TRUE)
  )
```

2.1.5 Boxplots showing range of Total shannon index for glacier/region/pole
```{r}
# #plot total shannon index for each glacier
# ggboxplot(tot_shan, x="Glacier", y="ShannonIndex",
#           color="Glacier", ylab="Shannon Index", xlab="Glacier")
# 
# #plot total shannon index for each region
# ggboxplot(tot_shan, x="Region", y="ShannonIndex",
#           color="Region", ylab="Shannon Index", xlab="Region")
# 
# #plot total shannon index for each pole
# ggboxplot(tot_shan, x="Pole", y="ShannonIndex",
#           color="Pole", ylab="Shannon Index", xlab="Pole")

ggplot(tot_shan, aes(x=Glacier, y=ShannonIndex, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0, 85)+
  theme_bw()+
  ylab("Shannon Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(tot_shan, aes(x=Region, y=ShannonIndex, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0, 85)+
  theme_bw()+
  ylab("Shannon Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(tot_shan, aes(x=Pole, y=ShannonIndex, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0, 85)+
  theme_bw()+
  ylab("Shannon Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

2.1.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier shannon index
#ANOVA
res.aov.tot.shan.gla <- aov(ShannonIndex ~ Glacier, data = tot_shan)
#Summary of analysis
summary(res.aov.tot.shan.gla) #p value < 0.05 significant difference between glaciers

#Test for significant differences between region asv richness
#ANOVA
res.aov.tot.shan.reg <- aov(ShannonIndex ~ Region, data = tot_shan)
#Summary of analysis
summary(res.aov.tot.shan.reg) #p value < 0.05 significant difference between regions


```

2.1.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(ShannonIndex ~ Glacier, data = tot_shan) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.tot.shan.gla <- residuals(object = res.aov.tot.shan.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.tot.shan.gla) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

#REGION
#use levene's test to check homogeny of variances
leveneTest(ShannonIndex ~ Region, data = tot_shan) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.tot.shan.reg <- residuals(object = res.aov.tot.shan.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.tot.shan.reg) #p > 0.05 which suggests the data ARE normally distributed

#ANOVA VALID

```

2.1.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between glaciers
kruskal.test(ShannonIndex ~ Glacier, data = tot_shan) #p < 0.05 so the differences between the medians ARE statistically significant

```


2.1.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Richness
with(tot_shan, shapiro.test(ShannonIndex[Pole == "Arctic"]))# p > 0.05 so normally distributed

# Shapiro-Wilk normality test for Antarctic Richness
with(tot_shan, shapiro.test(ShannonIndex[Pole == "Antarctic"])) #p > 0.05 normally distributed

#Do the two populations have the same variances?
res.ftest.tot.shan.pol <- var.test(ShannonIndex ~ Pole, data = tot_shan)
res.ftest.tot.shan.pol #p > 0.05 so variances NOT significantly different

#ASSUMPTIONS ARE MET FOR PARAMETRIC TEST

#NEED TWO SAMPLE T TEST
res <- t.test(ShannonIndex ~ Pole, data = tot_shan, var.equal = TRUE, alternative="less")
res #p < 0.05 so Antarctic significantly less than Arctic
```

2.1.10 Use dunn's or tukey test to see which glaciers are different
```{r}
#We have detected significant differences in asv richness between the glaciers, regions and the poles
dunnTest(ShannonIndex ~ Glacier, data=tot_shan, method="bh")
#dunnTest(ShannonIndex ~ Region, data=tot_shan, method="bh")

TukeyHSD(res.aov.tot.shan.reg)
```

ABUNDANT TAXA
2.2.1 Pull abundant taxa data from phyloseq object and create dataframe
2.2.2 Abundant taxa for each glacier + summary stats
2.2.3 Abundant taxa for each region + summary stats
2.2.4 Abundant taxa for each pole + summary stats
2.2.5 Boxplots showing range of Abundant shannon index for glacier/region/pole
2.2.6 Significant tests for differences between glaciers/regions/poles
2.2.7 Test the validity of the ANOVA
2.2.8 Run kruskal wallis tests if data do not meet ANOVA assumption
2.2.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
2.2.10 Use dunn's test to see which glaciers are different

2.2.1 Pull abundant taxa data from phyloseq object and create dataframe
```{r}
#What is the total taxa shannon index for each glacier?
asv_counts <- as.data.frame(otu_table(ps.glaciers.merged.RA))

#get sample data from ps.rar 
samp_data <- data.frame(sample_data(ps.glaciers.merged.RA))

#find shannon index of each sample
#make a new dataframe with shannon as the shannon diversity index of each sample
data = t(otu_table(ps.glaciers.merged.RA))
shannon <- diversity(data, index="shannon")
ab_shan <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, shannon)
colnames(ab_shan) <- c("SampleID", "Glacier", "Region", "Pole", "ShannonIndex")
ab_shan <- as.data.frame(ab_shan)
ab_shan$ShannonIndex <- as.numeric(ab_shan$ShannonIndex)
```

2.2.2 Abundant taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(ab_shan, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(ShannonIndex, na.rm=TRUE),
    sd = sd(ShannonIndex, na.rm=TRUE)
  )
```

2.2.3 Abundant taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(ab_shan, Region) %>%
  summarise(
    count=n(),
    mean=mean(ShannonIndex, na.rm=TRUE),
    sd = sd(ShannonIndex, na.rm=TRUE)
  )
```

2.2.4 Abundant taxa for each pole + summary stats
```{r}
#compute summar stats for each pole
group_by(ab_shan, Pole) %>%
  summarise(
    count=n(),
    mean=mean(ShannonIndex, na.rm=TRUE),
    sd = sd(ShannonIndex, na.rm=TRUE)
  )
```

2.2.5 Boxplots showing range of Abundant shannon index for glacier/region/pole
```{r}
# #plot shannon index for each glacier
# ggboxplot(ab_shan, x="Glacier", y="ShannonIndex",
#           color="Glacier", ylab="Shannon Index", xlab="Glacier")
# 
# #plot shannon index for each region
# ggboxplot(ab_shan, x="Region", y="ShannonIndex",
#           color="Region", ylab="Shannon Index", xlab="Region")
# 
# #plot shannon index for each pole
# ggboxplot(ab_shan, x="Pole", y="ShannonIndex",
#           color="Pole", ylab="Shannon Index", xlab="Pole")

ggplot(ab_shan, aes(x=Glacier, y=ShannonIndex, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0, 85)+
  theme_bw()+
  ylab("Shannon Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(ab_shan, aes(x=Region, y=ShannonIndex, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0, 85)+
  theme_bw()+
  ylab("Shannon Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(ab_shan, aes(x=Pole, y=ShannonIndex, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0, 85)+
  theme_bw()+
  ylab("Shannon Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

2.2.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier shannon index
#ANOVA
res.aov.ab.shan.gla <- aov(ShannonIndex ~ Glacier, data = ab_shan)
#Summary of analysis
summary(res.aov.ab.shan.gla) #p value < 0.05 significant difference between glaciers

#Test for significant differences between region asv richness
#ANOVA
res.aov.ab.shan.reg <- aov(ShannonIndex ~ Region, data = ab_shan)
#Summary of analysis
summary(res.aov.ab.shan.reg) #p value < 0.05 significant difference between regions

#Test for significant differences between pole asv richness
#ANOVA
res.aov.ab.shan.pol <- aov(ShannonIndex ~ Pole, data = ab_shan)
#Summary of analysis
summary(res.aov.ab.shan.pol) #p value < 0.05 significant difference between poles

```

2.2.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(ShannonIndex ~ Glacier, data = ab_shan) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ab.shan.gla <- residuals(object = res.aov.ab.shan.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ab.shan.gla) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

#REGION
#use levene's test to check homogeny of variances
leveneTest(ShannonIndex ~ Region, data = ab_shan) #p < 0.05 variance across groups IS significantly different so data DOES NOT meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ab.shan.reg <- residuals(object = res.aov.ab.shan.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ab.shan.reg) #p > 0.05 which suggests the data ARE normally distributed

#ANOVA not valid so need to use kruskal wallis test

```

2.2.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between glaciers
kruskal.test(ShannonIndex ~ Glacier, data = ab_shan) #p < 0.05 so the differences between the medians ARE statistically significant

#Differences between regions
kruskal.test(ShannonIndex ~ Region, data = ab_shan) #p < 0.05 so the differences between the medians ARE statistically significant

```


2.2.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Shannon Index
with(ab_shan, shapiro.test(ShannonIndex[Pole == "Arctic"]))# p > 0.05 so normally distributed

# Shapiro-Wilk normality test for Antarctic Shannon Index
with(ab_shan, shapiro.test(ShannonIndex[Pole == "Antarctic"])) #p > 0.05 normally distributed

#Do the two populations have the same variances?
res.ftest.ab.shan.pol <- var.test(ShannonIndex ~ Pole, data = ab_shan)
res.ftest.ab.shan.pol #p < 0.05 so variances ARE significantly different

#ASSUMPTIONS ARE MET NOT FOR PARAMETRIC TEST
#Wilcoxon Test
wilcox.test(ab_shan$ShannonIndex ~ ab_shan$Pole,
  alternative = "less"
) #P < 0.05 so Antartcic DOES have lower shannon index than Arctic

```

2.2.10 Use dunn's test to see which glaciers are different
```{r}
#We have detected significant differences in asv richness between the glaciers, regions and the poles
dunnTest(ShannonIndex ~ Glacier, data=ab_shan, method="bh")
dunnTest(ShannonIndex ~ Region, data=ab_shan, method="bh")
```

INTERMEDIATE TAXA
2.3.1 Pull intermediate taxa data from phyloseq object and create dataframe
2.3.2 Intermediate taxa for each glacier + summary stats
2.3.3 Intermediate taxa for each region + summary stats
2.3.4 Intermediate taxa for each pole + summary stats
2.3.5 Boxplots showing range of Intermediate shannon index for glacier/region/pole
2.3.6 Significant tests for differences between glaciers/regions/poles
2.3.7 Test the validity of the ANOVA
2.3.8 Run kruskal wallis tests if data do not meet ANOVA assumption
2.3.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
2.3.10 Use dunn's test to see which glaciers are different

2.3.1 Pull intermediate taxa data from phyloseq object and create dataframe
```{r}
#What is the total taxa shannon index for each glacier?
asv_counts <- as.data.frame(otu_table(ps.glaciers.merged.I))

#get sample data from ps.rar 
samp_data <- data.frame(sample_data(ps.glaciers.merged.I))

#find shannon index of each sample
#make a new dataframe with shannon as the shannon diversity index of each sample
data = t(otu_table(ps.glaciers.merged.I))
shannon <- diversity(data, index="shannon")
i_shan <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, shannon)
colnames(i_shan) <- c("SampleID", "Glacier", "Region", "Pole", "ShannonIndex")
i_shan <- as.data.frame(i_shan)
i_shan$ShannonIndex <- as.numeric(i_shan$ShannonIndex)
```

2.3.2 Intermediate taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(i_shan, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(ShannonIndex, na.rm=TRUE),
    sd = sd(ShannonIndex, na.rm=TRUE)
  )
```

2.3.3 Intermediate taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(i_shan, Region) %>%
  summarise(
    count=n(),
    mean=mean(ShannonIndex, na.rm=TRUE),
    sd = sd(ShannonIndex, na.rm=TRUE)
  )
```

2.3.4 Intermediate taxa for each pole + summary stats
```{r}
#compute summar stats for each pole
group_by(i_shan, Pole) %>%
  summarise(
    count=n(),
    mean=mean(ShannonIndex, na.rm=TRUE),
    sd = sd(ShannonIndex, na.rm=TRUE)
  )
```

2.3.5 Boxplots showing range of Intermediate shannon index for glacier/region/pole
```{r}
# #plot shannon index for each glacier
# ggboxplot(i_shan, x="Glacier", y="ShannonIndex",
#           color="Glacier", ylab="Shannon Index", xlab="Glacier")
# 
# #plot shannon index for each region
# ggboxplot(i_shan, x="Region", y="ShannonIndex",
#           color="Region", ylab="Shannon Index", xlab="Region")
# 
# #plot shannon index for each pole
# ggboxplot(i_shan, x="Pole", y="ShannonIndex",
#           color="Pole", ylab="Shannon Index", xlab="Pole")

ggplot(i_shan, aes(x=Glacier, y=ShannonIndex, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0, 85)+
  theme_bw()+
  ylab("Shannon Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(i_shan, aes(x=Region, y=ShannonIndex, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(2, 5)+
  theme_bw()+
  ylab("Shannon Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(i_shan, aes(x=Pole, y=ShannonIndex, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(2, 5)+
  theme_bw()+
  ylab("Shannon Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

2.3.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier shannon index
#ANOVA
res.aov.i.shan.gla <- aov(ShannonIndex ~ Glacier, data = i_shan)
#Summary of analysis
summary(res.aov.i.shan.gla) #p value < 0.05 significant difference between glaciers

#Test for significant differences between region asv richness
#ANOVA
res.aov.i.shan.reg <- aov(ShannonIndex ~ Region, data = i_shan)
#Summary of analysis
summary(res.aov.i.shan.reg) #p value > 0.05 NO significant difference between regions
```

2.3.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(ShannonIndex ~ Glacier, data = i_shan) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.i.shan.gla <- residuals(object = res.aov.i.shan.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.i.shan.gla) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

#REGION
#use levene's test to check homogeny of variances
leveneTest(ShannonIndex ~ Region, data = i_shan) #p > 0.05 variance across groups NOT significantly different so data DOES meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.i.shan.reg <- residuals(object = res.aov.i.shan.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.i.shan.reg) #p < 0.05 which suggests the data ARE NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

```

2.3.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between glaciers
kruskal.test(ShannonIndex ~ Glacier, data = i_shan) #p < 0.05 so the differences between the medians ARE statistically significant

#Differences between regions
kruskal.test(ShannonIndex ~ Region, data = i_shan) #p > 0.05 so the differences between the medians ARE NOT statistically significant

```


2.3.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Shannon Index
with(i_shan, shapiro.test(ShannonIndex[Pole == "Arctic"]))# p > 0.05 so normally distributed

# Shapiro-Wilk normality test for Antarctic Shannon Index
with(i_shan, shapiro.test(ShannonIndex[Pole == "Antarctic"])) #p < 0.05 NOT normally distributed

#Do the two populations have the same variances?
res.ftest.i.shan.pol <- var.test(ShannonIndex ~ Pole, data = i_shan)
res.ftest.i.shan.pol #p > 0.05 so variances ARE NOT significantly different

#ASSUMPTIONS ARE NOT MET FOR PARAMETRIC TEST
#Wilcoxon Test
wilcox.test(i_shan$ShannonIndex ~ i_shan$Pole) #p > 0.05 so no significant different
# wilcox.test(i_shan$ShannonIndex ~ i_shan$Pole,
#   alternative = "less"
# )

```

2.3.10 Use dunn's test to see which glaciers are different
```{r}
#We have detected significant differences in asv richness between the glaciers, regions and the poles
dunnTest(ShannonIndex ~ Glacier, data=i_shan, method="bh")
#dunnTest(ShannonIndex ~ Region, data=i_shan, method="bh")
```

RARE TAXA
2.4.1 Pull rare taxa data from phyloseq object and create dataframe
2.4.2 Rare taxa for each glacier + summary stats
2.4.3 Rare taxa for each region + summary stats
2.4.4 Rare taxa for each pole + summary stats
2.4.5 Boxplots showing range of Rare shannon index for glacier/region/pole
2.4.6 Significant tests for differences between glaciers/regions/poles
2.4.7 Test the validity of the ANOVA
2.4.8 Run kruskal wallis tests if data do not meet ANOVA assumption
2.4.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
2.4.10 Use dunn's test to see which glaciers are different

2.4.1 Pull rare taxa data from phyloseq object and create dataframe
```{r}
#What is the shannon index for each glacier?
asv_counts <- as.data.frame(otu_table(ps.glaciers.merged.RR))

#get sample data
samp_data <- data.frame(sample_data(ps.glaciers.merged.RR))

#find shannon index of each sample
#make a new dataframe with shannon as the shannon diversity index of each sample
data = t(otu_table(ps.glaciers.merged.RR))
shannon <- diversity(data, index="shannon")
ra_shan <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, shannon)
colnames(ra_shan) <- c("SampleID", "Glacier", "Region", "Pole", "ShannonIndex")
ra_shan <- as.data.frame(ra_shan)
ra_shan$ShannonIndex <- as.numeric(ra_shan$ShannonIndex)
```

2.4.2 Rare taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(ra_shan, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(ShannonIndex, na.rm=TRUE),
    sd = sd(ShannonIndex, na.rm=TRUE)
  )
```

2.4.3 Rare taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(ra_shan, Region) %>%
  summarise(
    count=n(),
    mean=mean(ShannonIndex, na.rm=TRUE),
    sd = sd(ShannonIndex, na.rm=TRUE)
  )
```

2.4.4 Rare taxa for each pole + summary stats
```{r}
#compute summar stats for each pole
group_by(ra_shan, Pole) %>%
  summarise(
    count=n(),
    mean=mean(ShannonIndex, na.rm=TRUE),
    sd = sd(ShannonIndex, na.rm=TRUE)
  )
```

2.4.5 Boxplots showing range of Rare shannon index for glacier/region/pole
```{r}
# #plot shannon index for each glacier
# ggboxplot(ra_shan, x="Glacier", y="ShannonIndex",
#           color="Glacier", ylab="Shannon Index", xlab="Glacier")
# 
# #plot shannon index for each region
# ggboxplot(ra_shan, x="Region", y="ShannonIndex",
#           color="Region", ylab="Shannon Index", xlab="Region")
# 
# #plot shannon index for each pole
# ggboxplot(ra_shan, x="Pole", y="ShannonIndex",
#           color="Pole", ylab="Shannon Index", xlab="Pole")

ggplot(ra_shan, aes(x=Glacier, y=ShannonIndex, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0, 5)+
  theme_bw()+
  ylab("Shannon Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(ra_shan, aes(x=Region, y=ShannonIndex, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(2, 5)+
  theme_bw()+
  ylab("Shannon Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(ra_shan, aes(x=Pole, y=ShannonIndex, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(2, 5)+
  theme_bw()+
  ylab("Shannon Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

2.4.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier shannon index
#ANOVA
res.aov.ra.shan.gla <- aov(ShannonIndex ~ Glacier, data = ra_shan)
#Summary of analysis
summary(res.aov.ra.shan.gla) #p value < 0.05 significant difference between glaciers

#Test for significant differences between region asv richness
#ANOVA
res.aov.ra.shan.reg <- aov(ShannonIndex ~ Region, data = ra_shan)
#Summary of analysis
summary(res.aov.ra.shan.reg) #p value > 0.05 NO significant difference between regions
```

2.4.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(ShannonIndex ~ Glacier, data = ra_shan) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ra.shan.gla <- residuals(object = res.aov.ra.shan.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ra.shan.gla) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

#REGION
#use levene's test to check homogeny of variances
leveneTest(ShannonIndex ~ Region, data = ra_shan) #p > 0.05 variance across groups NOT significantly different so data DOES meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ra.shan.reg <- residuals(object = res.aov.ra.shan.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ra.shan.reg) #p < 0.05 which suggests the data ARE NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

```

2.4.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between glaciers
kruskal.test(ShannonIndex ~ Glacier, data = ra_shan) #p < 0.05 so the differences between the medians ARE statistically significant

#Differences between regions
kruskal.test(ShannonIndex ~ Region, data = ra_shan) #p > 0.05 so the differences between the medians ARE NOT statistically significant

```


2.4.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Shannon Index
with(ra_shan, shapiro.test(ShannonIndex[Pole == "Arctic"]))# p > 0.05 so normally distributed

# Shapiro-Wilk normality test for Antarctic Shannon Index
with(ra_shan, shapiro.test(ShannonIndex[Pole == "Antarctic"])) #p > 0.05 normally distributed

#Do the two populations have the same variances?
res.ftest.ra.shan.pol <- var.test(ShannonIndex ~ Pole, data = ra_shan)
res.ftest.ra.shan.pol #p > 0.05 so variances ARE NOT significantly different

#ASSUMPTIONS ARE MET FOR PARAMETRIC TEST

# #Wilcoxon Test
# wilcox.test(ra_shan$ShannonIndex ~ ra_shan$Pole,
#   alternative = "less"
# )

res <- t.test(ShannonIndex ~ Pole, data = ra_shan, var.equal = TRUE)
res #p > 0.05 not significant difference betwen the poles

# res <- t.test(ShannonIndex ~ Pole, data = ra_shan, var.equal = TRUE, alternative="less")
# res 

```

2.4.10 Use dunn's test to see which glaciers are different
```{r}
#We have detected significant differences in asv richness between the glaciers, regions and the poles
dunnTest(ShannonIndex ~ Glacier, data=ra_shan, method="bh")
#dunnTest(ShannonIndex ~ Region, data=ra_shan, method="bh")
```

2.5 Plots

2.5.2 Plot this as a boxplot showing the range of values (abundant/rare/intermediate)
```{r}
#Add abundant/rare/intermediate column to our count tables
ab_shan$Abundance <- "Abundant"
i_shan$Abundance <- "Intermediate"
ra_shan$Abundance <- "Rare"

#merge dataframes
df <- rbind(ab_shan, i_shan, ra_shan)

# Basic boxplot
ggplot(df, aes(x=Abundance, y=ShannonIndex, color=Abundance, fill=Pole))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0, 2)+
  theme_bw()+
  ylab("Shannon Index")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")

```

PART THREE SIMPSON INDEX
TOTAL TAXA
3.1.1 Pull total taxa data from phyloseq object and create dataframe
3.1.2 Total taxa for each glacier + summary stats
3.1.3 Total taxa for each region + summary stats
3.1.4 Total taxa for each pole + summary stats
3.1.5 Boxplots showing range of Total richnesses for glacier/region/pole
3.1.6 Significant tests for differences between glaciers/regions/poles
3.1.7 Test the validity of the ANOVA
3.1.8 Run kruskal wallis tests if data do not meet ANOVA assumption
3.1.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
3.1.10 Use dunn's test to see which glaciers are different

3.1.1 Pull total taxa data from phyloseq object and create dataframe
```{r}
#What is the total taxa simpson index for each glacier?

#get our ASV count table from ps.rar (contains total data)
asv_counts <- as.data.frame(otu_table(ps.rar))

#get sample data from ps.rar 
samp_data <- data.frame(sample_data(ps.rar))

#find simpson index of each sample
#make a new dataframe with simpson as the diversity index of each sample
data = t(otu_table(ps.rar))
simpson <- diversity(data, index="simpson")
tot_simp <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, simpson)
colnames(tot_simp) <- c("SampleID", "Glacier", "Region", "Pole", "SimpsonIndex")
tot_simp <- as.data.frame(tot_simp)
tot_simp$SimpsonIndex <- as.numeric(tot_simp$SimpsonIndex)
```

3.1.2 Total taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(tot_simp, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(SimpsonIndex, na.rm=TRUE),
    sd = sd(SimpsonIndex, na.rm=TRUE)
  )
```

3.1.3 Total taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(tot_simp, Region) %>%
  summarise(
    count=n(),
    mean=mean(SimpsonIndex, na.rm=TRUE),
    sd = sd(SimpsonIndex, na.rm=TRUE)
  )
```

3.1.4 Total taxa for each pole + summary stats
```{r}
#compute summar stats for each pole
group_by(tot_simp, Pole) %>%
  summarise(
    count=n(),
    mean=mean(SimpsonIndex, na.rm=TRUE),
    sd = sd(SimpsonIndex, na.rm=TRUE)
  )
```

3.1.5 Boxplots showing range of Total simpson index for glacier/region/pole
```{r}
# #plot total simpson index for each glacier
# ggboxplot(tot_simp, x="Glacier", y="SimpsonIndex",
#           color="Glacier", ylab="Simpson Index", xlab="Glacier")
# 
# #plot total simpson index for each region
# ggboxplot(tot_simp, x="Region", y="SimpsonIndex",
#           color="Region", ylab="Simpson Index", xlab="Region")
# 
# #plot total simpson index for each pole
# ggboxplot(tot_simp, x="Pole", y="SimpsonIndex",
#           color="Pole", ylab="Simpson Index", xlab="Pole")

ggplot(tot_simp, aes(x=Glacier, y=SimpsonIndex, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0, 5)+
  theme_bw()+
  ylab("Simpson Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(tot_simp, aes(x=Region, y=SimpsonIndex, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(2, 5)+
  theme_bw()+
  ylab("Simpson Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(tot_simp, aes(x=Pole, y=SimpsonIndex, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(2, 5)+
  theme_bw()+
  ylab("Simpson Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

3.1.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier simson index
#ANOVA
res.aov.tot.simp.gla <- aov(SimpsonIndex ~ Glacier, data = tot_simp)
#Summary of analysis
summary(res.aov.tot.simp.gla) #p value < 0.05 significant difference between glaciers

#Test for significant differences between region simpson index
#ANOVA
res.aov.tot.simp.reg <- aov(SimpsonIndex ~ Region, data = tot_simp)
#Summary of analysis
summary(res.aov.tot.simp.reg) #p value < 0.05 significant difference between regions
```

3.1.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(SimpsonIndex ~ Glacier, data = tot_simp) #p < 0.05 so variance across groups is significantly different so data DOES NOT meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.tot.simp.gla <- residuals(object = res.aov.tot.simp.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.tot.simp.gla) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

#REGION
#use levene's test to check homogeny of variances
leveneTest(SimpsonIndex ~ Region, data = tot_simp) #p < 0.05  variance across groups is significantly different so data DOES NOT meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.tot.simp.reg <- residuals(object = res.aov.tot.simp.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.tot.simp.reg) #p < 0.05 which suggests the data ARE NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

```

3.1.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between glaciers
kruskal.test(SimpsonIndex ~ Glacier, data = tot_simp) #p < 0.05 so the differences between the medians ARE statistically significant

#Differences between regions
kruskal.test(SimpsonIndex ~ Region, data = tot_simp) #p < 0.05 so the differences between the medians ARE statistically significant

```


3.1.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Richness
with(tot_simp, shapiro.test(SimpsonIndex[Pole == "Arctic"]))# p > 0.05 so normally distributed

# Shapiro-Wilk normality test for Antarctic Richness
with(tot_simp, shapiro.test(SimpsonIndex[Pole == "Antarctic"])) #p < 0.05 NOT normally distributed

#Do the two populations have the same variances?
res.ftest.tot.simp.pol <- var.test(SimpsonIndex ~ Pole, data = tot_simp)
res.ftest.tot.simp.pol #p < 0.05 so variances significantly different

#ASSUMPTIONS NOT MET FOR PARAMETRIC TEST

# #NEED TWO SAMPLE T TEST
# res <- t.test(ShannonIndex ~ Pole, data = tot_shan, var.equal = TRUE, alternative="less")
# res #p < 0.05 so Antarctic significantly less than Arctic

#Wilcoxon Test
wilcox.test(tot_simp$SimpsonIndex ~ tot_simp$Pole) #p < 0.05 so poles are significant different

#Wilcoxon test to see if Antarctic has significantly LESS
wilcox.test(tot_simp$SimpsonIndex ~ tot_simp$Pole, alternative="less") #p < 0.05 so Antarctic has significantly lower Simpson Index
```

3.1.10 Use dunn's test to see which are different
```{r}
dunnTest(SimpsonIndex ~ Glacier, data=tot_simp, method="bh")
dunnTest(SimpsonIndex ~ Region, data=tot_simp, method="bh")
```

ABUNDANT TAXA
3.2.1 Pull abundant taxa data from phyloseq object and create dataframe
3.2.2 Abundant taxa for each glacier + summary stats
3.2.3 Abundant taxa for each region + summary stats
3.2.4 Abundant taxa for each pole + summary stats
3.2.5 Boxplots showing range of Abundant simpson index for glacier/region/pole
3.2.6 Significant tests for differences between glaciers/regions/poles
3.2.7 Test the validity of the ANOVA
3.2.8 Run kruskal wallis tests if data do not meet ANOVA assumption
3.2.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
3.2.10 Use dunn's test to see which glaciers are different

3.2.1 Pull abundant taxa data from phyloseq object and create dataframe
```{r}
#What is the total taxa shannon index for each glacier?
asv_counts <- as.data.frame(otu_table(ps.glaciers.merged.RA))

#get sample data from ps.rar 
samp_data <- data.frame(sample_data(ps.glaciers.merged.RA))

#find simpson index of each sample
#make a new dataframe with simpson diversity index of each sample
data = t(otu_table(ps.glaciers.merged.RA))
simpson <- diversity(data, index="simpson")
ab_simp <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, simpson)
colnames(ab_simp) <- c("SampleID", "Glacier", "Region", "Pole", "SimpsonIndex")
ab_simp <- as.data.frame(ab_simp)
ab_simp$SimpsonIndex <- as.numeric(ab_simp$SimpsonIndex)
```

3.2.2 Abundant taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(ab_simp, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(SimpsonIndex, na.rm=TRUE),
    sd = sd(SimpsonIndex, na.rm=TRUE)
  )
```

3.2.3 Abundant taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(ab_simp, Region) %>%
  summarise(
    count=n(),
    mean=mean(SimpsonIndex, na.rm=TRUE),
    sd = sd(SimpsonIndex, na.rm=TRUE)
  )
```

3.2.4 Abundant taxa for each pole + summary stats
```{r}
#compute summar stats for each pole
group_by(ab_shan, Pole) %>%
  summarise(
    count=n(),
    mean=mean(ShannonIndex, na.rm=TRUE),
    sd = sd(ShannonIndex, na.rm=TRUE)
  )
```

3.2.5 Boxplots showing range of Abundant simpson index for glacier/region/pole
```{r}
# #plot simpson index for each glacier
# ggboxplot(ab_simp, x="Glacier", y="SimpsonIndex",
#           color="Glacier", ylab="Simpson Index", xlab="Glacier")
# 
# #plot simpson index for each region
# ggboxplot(ab_simp, x="Region", y="SimpsonIndex",
#           color="Region", ylab="Simpson Index", xlab="Region")
# 
# #plot simpson index for each pole
# ggboxplot(ab_simp, x="Pole", y="SimpsonIndex",
#           color="Pole", ylab="Simpson Index", xlab="Pole")

ggplot(ab_simp, aes(x=Glacier, y=SimpsonIndex, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0, 5)+
  theme_bw()+
  ylab("Simpson Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(ab_simp, aes(x=Region, y=SimpsonIndex, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0.5, 1)+
  theme_bw()+
  ylab("Simpson Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(ab_simp, aes(x=Pole, y=SimpsonIndex, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0.5, 1)+
  theme_bw()+
  ylab("Simpson Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

3.2.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier simpson index
#ANOVA
res.aov.ab.simp.gla <- aov(SimpsonIndex ~ Glacier, data = ab_simp)
#Summary of analysis
summary(res.aov.ab.simp.gla) #p value < 0.05 significant difference between glaciers

#Test for significant differences between region asv richness
#ANOVA
res.aov.ab.simp.reg <- aov(SimpsonIndex ~ Region, data = ab_simp)
#Summary of analysis
summary(res.aov.ab.simp.reg) #p value < 0.05 significant difference between regions
```

3.2.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(SimpsonIndex ~ Glacier, data = ab_simp) #p < 0.05 so variance across groups is significantly different so data DOES NOT meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ab.simp.gla <- residuals(object = res.aov.ab.simp.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ab.simp.gla) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

#REGION
#use levene's test to check homogeny of variances
leveneTest(SimpsonIndex ~ Region, data = ab_simp) #p < 0.05 variance across groups IS significantly different so data DOES NOT meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ab.simp.reg <- residuals(object = res.aov.ab.simp.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ab.simp.reg) #p < 0.05 which suggests the data ARE NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

```

3.2.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between glaciers
kruskal.test(SimpsonIndex ~ Glacier, data = ab_simp) #p < 0.05 so the differences between the medians ARE statistically significant

#Differences between regions
kruskal.test(SimpsonIndex ~ Region, data = ab_simp) #p < 0.05 so the differences between the medians ARE statistically significant

```


3.2.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Simpson Index
with(ab_simp, shapiro.test(SimpsonIndex[Pole == "Arctic"]))# p > 0.05 so normally distributed

# Shapiro-Wilk normality test for Antarctic Simpson Index
with(ab_simp, shapiro.test(SimpsonIndex[Pole == "Antarctic"])) #p < 0.05 NOT normally distributed

#Do the two populations have the same variances?
res.ftest.ab.simp.pol <- var.test(SimpsonIndex ~ Pole, data = ab_simp)
res.ftest.ab.simp.pol #p < 0.05 so variances ARE significantly different

#ASSUMPTIONS ARE MET NOT FOR PARAMETRIC TEST
#Wilcoxon Test

wilcox.test(ab_simp$SimpsonIndex ~ ab_simp$Pole) # p < 0.05 so they are singificantly different

wilcox.test(ab_simp$SimpsonIndex ~ ab_simp$Pole,
  alternative = "less"
) #P < 0.05 so Antartcic DOES have lower simpson index than Arctic

```

3.2.10 Use dunn's test to see which glaciers are different
```{r}
#We have detected significant differences in asv richness between the glaciers, regions and the poles
dunnTest(SimpsonIndex ~ Glacier, data=ab_simp, method="bh")
dunnTest(SimpsonIndex ~ Region, data=ab_simp, method="bh")
```

INTERMEDIATE TAXA
3.3.1 Pull intermediate taxa data from phyloseq object and create dataframe
3.3.2 Intermediate taxa for each glacier + summary stats
3.3.3 Intermediate taxa for each region + summary stats
3.3.4 Intermediate taxa for each pole + summary stats
3.3.5 Boxplots showing range of Intermediate simpson index for glacier/region/pole
3.3.6 Significant tests for differences between glaciers/regions/poles
3.3.7 Test the validity of the ANOVA
3.3.8 Run kruskal wallis tests if data do not meet ANOVA assumption
3.3.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
3.3.10 Use dunn's test to see which glaciers are different

3.3.1 Pull intermediate taxa data from phyloseq object and create dataframe
```{r}
#What is the total taxa simpson index for each glacier?
asv_counts <- as.data.frame(otu_table(ps.glaciers.merged.I))

#get sample data
samp_data <- data.frame(sample_data(ps.glaciers.merged.I))

#find simpson index of each sample
#make a new dataframe with simpson diversity index of each sample
data = t(otu_table(ps.glaciers.merged.I))
simpson <- diversity(data, index="simpson")
i_simp <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, simpson)
colnames(i_simp) <- c("SampleID", "Glacier", "Region", "Pole", "SimpsonIndex")
i_simp <- as.data.frame(i_simp)
i_simp$SimpsonIndex <- as.numeric(i_simp$SimpsonIndex)
```

3.3.2 Intermediate taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(i_simp, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(SimpsonIndex, na.rm=TRUE),
    sd = sd(SimpsonIndex, na.rm=TRUE)
  )
```

3.3.3 Intermediate taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(i_simp, Region) %>%
  summarise(
    count=n(),
    mean=mean(SimpsonIndex, na.rm=TRUE),
    sd = sd(SimpsonIndex, na.rm=TRUE)
  )
```

3.3.4 Intermediate taxa for each pole + summary stats
```{r}
#compute summar stats for each pole
group_by(i_simp, Pole) %>%
  summarise(
    count=n(),
    mean=mean(SimpsonIndex, na.rm=TRUE),
    sd = sd(SimpsonIndex, na.rm=TRUE)
  )
```

3.3.5 Boxplots showing range of Intermediate simpson index for glacier/region/pole
```{r}
# #plot simpson index for each glacier
# ggboxplot(i_simp, x="Glacier", y="SimpsonIndex",
#           color="Glacier", ylab="Simpson Index", xlab="Glacier")
# 
# #plot simpson index for each region
# ggboxplot(i_simp, x="Region", y="SimpsonIndex",
#           color="Region", ylab="Simpson Index", xlab="Region")
# 
# #plot simpson index for each pole
# ggboxplot(i_simp, x="Pole", y="SimpsonIndex",
#           color="Pole", ylab="Simpson Index", xlab="Pole")

ggplot(i_simp, aes(x=Glacier, y=SimpsonIndex, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0.8, 1)+
  theme_bw()+
  ylab("Simpson Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(i_simp, aes(x=Region, y=SimpsonIndex, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0.875, 1)+
  theme_bw()+
  ylab("Simpson Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(i_simp, aes(x=Pole, y=SimpsonIndex, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0.875, 1)+
  theme_bw()+
  ylab("Simpson Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

3.3.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier simpson index
#ANOVA
res.aov.i.simp.gla <- aov(SimpsonIndex ~ Glacier, data = i_simp)
#Summary of analysis
summary(res.aov.i.simp.gla) #p value > 0.05 NO significant difference between glaciers

#Test for significant differences between region asv richness
#ANOVA
res.aov.i.simp.reg <- aov(SimpsonIndex ~ Region, data = i_simp)
#Summary of analysis
summary(res.aov.i.simp.reg) #p value > 0.05 NO significant difference between regions
```

3.3.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(SimpsonIndex ~ Glacier, data = i_simp) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.i.simp.gla <- residuals(object = res.aov.i.simp.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.i.simp.gla) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

#REGION
#use levene's test to check homogeny of variances
leveneTest(SimpsonIndex ~ Region, data = i_simp) #p > 0.05 variance across groups NOT significantly different so data DOES meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.i.simp.reg <- residuals(object = res.aov.i.simp.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.i.simp.reg) #p < 0.05 which suggests the data ARE NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

```

3.3.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between glaciers
kruskal.test(SimpsonIndex ~ Glacier, data = i_simp) #p < 0.05 so the differences between the medians ARE statistically significant

#Differences between regions
kruskal.test(SimpsonIndex ~ Region, data = i_simp) #p > 0.05 so the differences between the medians ARE NOT statistically significant

```


3.3.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Simpson Index
with(i_simp, shapiro.test(SimpsonIndex[Pole == "Arctic"]))# p < 0.05 so NOT normally distributed

# Shapiro-Wilk normality test for Antarctic Simpson Index
with(i_simp, shapiro.test(SimpsonIndex[Pole == "Antarctic"])) #p < 0.05 NOT normally distributed

#Do the two populations have the same variances?
res.ftest.i.simp.pol <- var.test(SimpsonIndex ~ Pole, data = i_simp)
res.ftest.i.simp.pol #p < 0.05 so variances ARE significantly different

#ASSUMPTIONS ARE NOT MET FOR PARAMETRIC TEST
#Wilcoxon Test

wilcox.test(i_simp$SimpsonIndex ~ i_simp$Pole) #P > 0.05 so indexes not significantly different

# wilcox.test(i_simp$SimpsonIndex ~ i_simp$Pole,
#   alternative = "less"
# ) #P > 0.05 so Antartcic DOES NOT have lower shannon index than Arctic

```

3.3.10 Use dunn's test to see which glaciers are different
```{r}
#We have detected significant differences in index between the glaciers, regions and the poles
dunnTest(SimpsonIndex ~ Glacier, data=i_simp, method="bh")
#dunnTest(SimpsonIndex ~ Region, data=i_simp, method="bh")
```

RARE TAXA
3.4.1 Pull rare taxa data from phyloseq object and create dataframe
3.4.2 Rare taxa for each glacier + summary stats
3.4.3 Rare taxa for each region + summary stats
3.4.4 Rare taxa for each pole + summary stats
3.4.5 Boxplots showing range of Rare simpson index for glacier/region/pole
3.4.6 Significant tests for differences between glaciers/regions/poles
3.4.7 Test the validity of the ANOVA
3.4.8 Run kruskal wallis tests if data do not meet ANOVA assumption
3.4.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
3.4.10 Use dunn's test to see which glaciers are different

3.4.1 Pull rare taxa data from phyloseq object and create dataframe
```{r}
#What is the simpson index for each glacier?
asv_counts <- as.data.frame(otu_table(ps.glaciers.merged.RR))

#get sample data
samp_data <- data.frame(sample_data(ps.glaciers.merged.RR))

#find simpson index of each sample
#make a new dataframe with simpson diversity index of each sample
data = t(otu_table(ps.glaciers.merged.RR))
simpson <- diversity(data, index="simpson")
ra_simp <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, simpson)
colnames(ra_simp) <- c("SampleID", "Glacier", "Region", "Pole", "SimpsonIndex")
ra_simp <- as.data.frame(ra_simp)
ra_simp$SimpsonIndex <- as.numeric(ra_simp$SimpsonIndex)
```

3.4.2 Rare taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(ra_simp, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(SimpsonIndex, na.rm=TRUE),
    sd = sd(SimpsonIndex, na.rm=TRUE)
  )
```

3.4.3 Rare taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(ra_simp, Region) %>%
  summarise(
    count=n(),
    mean=mean(SimpsonIndex, na.rm=TRUE),
    sd = sd(SimpsonIndex, na.rm=TRUE)
  )
```

3.4.4 Rare taxa for each pole + summary stats
```{r}
#compute summary stats for each pole
group_by(ra_simp, Pole) %>%
  summarise(
    count=n(),
    mean=mean(SimpsonIndex, na.rm=TRUE),
    sd = sd(SimpsonIndex, na.rm=TRUE)
  )
```

3.4.5 Boxplots showing range of Rare simpson index for glacier/region/pole
```{r}
# #plot simpson index for each glacier
# ggboxplot(ra_simp, x="Glacier", y="SimpsonIndex",
#           color="Glacier", ylab="Simpson Index", xlab="Glacier")
# 
# #plot simpson index for each region
# ggboxplot(ra_simp, x="Region", y="SimpsonIndex",
#           color="Region", ylab="Simpson Index", xlab="Region")
# 
# #plot simpson index for each pole
# ggboxplot(ra_simp, x="Pole", y="SimpsonIndex",
#           color="Pole", ylab="Simpson Index", xlab="Pole")

ggplot(ra_simp, aes(x=Glacier, y=SimpsonIndex, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0.8, 1)+
  theme_bw()+
  ylab("Simpson Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(ra_simp, aes(x=Region, y=SimpsonIndex, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0.15, 1)+
  theme_bw()+
  ylab("Simpson Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(ra_simp, aes(x=Pole, y=SimpsonIndex, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0.15, 1)+
  theme_bw()+
  ylab("Simpson Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

3.4.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier simpson index
#ANOVA
res.aov.ra.simp.gla <- aov(SimpsonIndex ~ Glacier, data = ra_simp)
#Summary of analysis
summary(res.aov.ra.simp.gla) #p value < 0.05 significant difference between glaciers

#Test for significant differences between region indexes
#ANOVA
res.aov.ra.simp.reg <- aov(SimpsonIndex ~ Region, data = ra_simp)
#Summary of analysis
summary(res.aov.ra.simp.reg) #p value > 0.05 NO significant difference between regions
```

3.4.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(SimpsonIndex ~ Glacier, data = ra_simp) #p < 0.05 variance across groups is significantly different so data DOES NOT meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ra.simp.gla <- residuals(object = res.aov.ra.simp.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ra.simp.gla) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

#REGION
#use levene's test to check homogeny of variances
leveneTest(SimpsonIndex ~ Region, data = ra_simp) #p > 0.05 variance across groups NOT significantly different so data DOES meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ra.simp.reg <- residuals(object = res.aov.ra.simp.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ra.simp.reg) #p < 0.05 which suggests the data ARE NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

```

3.4.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between glaciers
kruskal.test(SimpsonIndex ~ Glacier, data = ra_simp) #p < 0.05 so the differences between the medians ARE statistically significant

#Differences between regions
kruskal.test(SimpsonIndex ~ Region, data = ra_simp) #p > 0.05 so the differences between the medians ARE NOT statistically significant

```


3.4.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Simpson Index
with(ra_simp, shapiro.test(SimpsonIndex[Pole == "Arctic"]))# p < 0.05 NOT normally distributed

# Shapiro-Wilk normality test for Antarctic Simpson Index
with(ra_simp, shapiro.test(SimpsonIndex[Pole == "Antarctic"])) #p < 0.05 NOT normally distributed

#Do the two populations have the same variances?
res.ftest.ra.simp.pol <- var.test(SimpsonIndex ~ Pole, data = ra_simp)
res.ftest.ra.simp.pol #p > 0.05 so variances ARE NOT significantly different

#ASSUMPTIONS ARE NOT MET FOR PARAMETRIC TEST

#Wilcoxon Test
wilcox.test(ra_simp$SimpsonIndex ~ ra_simp$Pole) # p > 0.05 so NO significant difference
wilcox.test(ra_simp$SimpsonIndex ~ ra_simp$Pole, # p > 0.05 Anarctic NOT significantly lower than Arctic
  alternative = "less"
)

# res <- t.test(ShannonIndex ~ Pole, data = ra_shan, var.equal = TRUE)
# res #p > 0.05 not significant difference betwen the poles
# 
# # res <- t.test(ShannonIndex ~ Pole, data = ra_shan, var.equal = TRUE, alternative="less")
# # res 

```

3.4.10 Use dunn's test to see which glaciers are different
```{r}
#We have detected significant differences in simpson index between the glaciers, regions and the poles
dunnTest(SimpsonIndex ~ Glacier, data=ra_simp, method="bh")
#dunnTest(SimpsonIndex ~ Region, data=ra_simp, method="bh")
```

3.5 Plots

3.5.2 Plot this as a boxplot showing the range of values (abundant/rare/intermediate)
```{r}
#Add abundant/rare/intermediate column to our count tables
ab_simp$Abundance <- "Abundant"
i_simp$Abundance <- "Intermediate"
ra_simp$Abundance <- "Rare"

#merge dataframes
df <- rbind(ab_simp, i_simp, ra_simp)

# Basic boxplot
ggplot(df, aes(x=Abundance, y=SimpsonIndex, color=Abundance, fill=Pole))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0.4, 1)+
  theme_bw()+
  ylab("Simpson Index")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")

```

PART FOUR PIELOU INDEX
TOTAL TAXA
4.1.1 Pull total taxa data from phyloseq object and create dataframe
4.1.2 Total taxa for each glacier + summary stats
4.1.3 Total taxa for each region + summary stats
4.1.4 Total taxa for each pole + summary stats
4.1.5 Boxplots showing range of Total Pielou index for glacier/region/pole
4.1.6 Significant tests for differences between glaciers/regions/poles
4.1.7 Test the validity of the ANOVA
4.1.8 Run kruskal wallis tests if data do not meet ANOVA assumption
4.1.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
4.1.10 Use dunn's test to see which glaciers are different

4.1.1 Pull total taxa data from phyloseq object and create dataframe
```{r}
#What is the total taxa pielou index for each glacier?

#get our ASV count table 
asv_counts <- as.data.frame(otu_table(ps.rar))

#get sample data from ps.rar 
samp_data <- data.frame(sample_data(ps.rar))

#find pielou index of each sample
#make a new dataframe with pielou diversity index of each sample
data = t(otu_table(ps.rar))

#pielou is calculated as...
pielou <- diversity(data, index="shannon")/log(specnumber(data))

tot_pie <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, pielou)
colnames(tot_pie) <- c("SampleID", "Glacier", "Region", "Pole", "PielouIndex")
tot_pie <- as.data.frame(tot_pie)
tot_pie$PielouIndex <- as.numeric(tot_pie$PielouIndex)
```

4.1.2 Total taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(tot_pie, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(PielouIndex, na.rm=TRUE),
    sd = sd(PielouIndex, na.rm=TRUE)
  )
```

4.1.3 Total taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(tot_pie, Region) %>%
  summarise(
    count=n(),
    mean=mean(PielouIndex, na.rm=TRUE),
    sd = sd(PielouIndex, na.rm=TRUE)
  )
```

4.1.4 Total taxa for each pole + summary stats
```{r}
#compute summar stats for each pole
group_by(tot_pie, Pole) %>%
  summarise(
    count=n(),
    mean=mean(PielouIndex, na.rm=TRUE),
    sd = sd(PielouIndex, na.rm=TRUE)
  )
```

4.1.5 Boxplots showing range of Total pielou index for glacier/region/pole
```{r}
# #plot total pielou index for each glacier
# ggboxplot(tot_pie, x="Glacier", y="PielouIndex",
#           color="Glacier", ylab="Pielou Index", xlab="Glacier")
# 
# #plot total pielou index for each region
# ggboxplot(tot_pie, x="Region", y="PielouIndex",
#           color="Region", ylab="Pielou Index", xlab="Region")
# 
# #plot total pielou index for each pole
# ggboxplot(tot_pie, x="Pole", y="PielouIndex",
#           color="Pole", ylab="Pielou Index", xlab="Pole")

ggplot(tot_pie, aes(x=Glacier, y=PielouIndex, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0.8, 1)+
  theme_bw()+
  ylab("Pielou Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(tot_pie, aes(x=Region, y=PielouIndex, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0.15, 1)+
  theme_bw()+
  ylab("Pielou Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(tot_pie, aes(x=Pole, y=PielouIndex, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0.15, 1)+
  theme_bw()+
  ylab("Pielou Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

4.1.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier pielou index
#ANOVA
res.aov.tot.pie.gla <- aov(PielouIndex ~ Glacier, data = tot_pie)
#Summary of analysis
summary(res.aov.tot.pie.gla) #p value < 0.05 significant difference between glaciers

#Test for significant differences between region pielou index
#ANOVA
res.aov.tot.pie.reg <- aov(PielouIndex ~ Region, data = tot_pie)
#Summary of analysis
summary(res.aov.tot.pie.reg) #p value < 0.05 significant difference between regions
```

4.1.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(PielouIndex ~ Glacier, data = tot_pie) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.tot.pie.gla <- residuals(object = res.aov.tot.pie.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.tot.pie.gla) #p > 0.05 which suggests the data are normally distributed

#ANOVA valid

#REGION
#use levene's test to check homogeny of variances
leveneTest(PielouIndex ~ Region, data = tot_pie) #p < 0.05 variance across groups is significantly different so data DOES NOT meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.tot.pie.reg <- residuals(object = res.aov.tot.pie.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.tot.pie.reg) #p > 0.05 which suggests the data ARE normally distributed

#ANOVA NOT VALID

```

4.1.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between regions
kruskal.test(PielouIndex ~ Region, data = tot_pie) #p < 0.05 so the differences between the medians ARE statistically significant

```


4.1.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Pielou Index
with(tot_pie, shapiro.test(PielouIndex[Pole == "Arctic"]))# p > 0.05 so normally distributed

# Shapiro-Wilk normality test for Antarctic Pielou Index
with(tot_pie, shapiro.test(PielouIndex[Pole == "Antarctic"])) #p > 0.05 normally distributed

#Do the two populations have the same variances?
res.ftest.tot.pie.pol <- var.test(PielouIndex ~ Pole, data = tot_pie)
res.ftest.tot.pie.pol #p > 0.05 so variances NOT significantly different

#ASSUMPTIONS ARE MET FOR PARAMETRIC TEST

#NEED TWO SAMPLE T TEST
res1 <- t.test(PielouIndex ~ Pole, data = tot_pie, var.equal = TRUE) # p < 0.05 poles are significantly different
res1
res2 <- t.test(PielouIndex ~ Pole, data = tot_pie, var.equal = TRUE, alternative="less")
res2 #p < 0.05 so Antarctic significantly less than Arctic
```

4.1.10 Use dunn's/Tukey test to see which glaciers are different
```{r}
#We have detected significant differences in pielous index between the glaciers, regions
TukeyHSD(res.aov.tot.pie.gla) #tukey on anova
dunnTest(PielouIndex ~ Region, data=tot_pie, method="bh") #dunn's test on kruskal wallis
```

ABUNDANT TAXA
4.2.1 Pull abundant taxa data from phyloseq object and create dataframe
4.2.2 Abundant taxa for each glacier + summary stats
4.2.3 Abundant taxa for each region + summary stats
4.2.4 Abundant taxa for each pole + summary stats
4.2.5 Boxplots showing range of Abundant pielou index for glacier/region/pole
4.2.6 Significant tests for differences between glaciers/regions/poles
4.2.7 Test the validity of the ANOVA
4.2.8 Run kruskal wallis tests if data do not meet ANOVA assumption
4.2.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
4.2.10 Use dunn's test to see which glaciers are different

4.2.1 Pull abundant taxa data from phyloseq object and create dataframe
```{r}
#What is the total taxa pielou index for each glacier?
asv_counts <- as.data.frame(otu_table(ps.glaciers.merged.RA))

#get sample data
samp_data <- data.frame(sample_data(ps.glaciers.merged.RA))

#make a new dataframe with pielou diversity index of each sample
data = t(otu_table(ps.glaciers.merged.RA))
pielou <- diversity(data, index="shannon")/log(specnumber(data))
ab_pie <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, pielou)
colnames(ab_pie) <- c("SampleID", "Glacier", "Region", "Pole", "PielouIndex")
ab_pie <- as.data.frame(ab_pie)
ab_pie$PielouIndex <- as.numeric(ab_pie$PielouIndex)
```

4.2.2 Abundant taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(ab_pie, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(PielouIndex, na.rm=TRUE),
    sd = sd(PielouIndex, na.rm=TRUE)
  )
```

4.2.3 Abundant taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(ab_pie, Region) %>%
  summarise(
    count=n(),
    mean=mean(PielouIndex, na.rm=TRUE),
    sd = sd(PielouIndex, na.rm=TRUE)
  )
```

4.2.4 Abundant taxa for each pole + summary stats
```{r}
#compute summary stats for each pole
group_by(ab_pie, Pole) %>%
  summarise(
    count=n(),
    mean=mean(PielouIndex, na.rm=TRUE),
    sd = sd(PielouIndex, na.rm=TRUE)
  )
```

4.2.5 Boxplots showing range of Abundant pielou index for glacier/region/pole
```{r}
# #plot pielou index for each glacier
# ggboxplot(ab_pie, x="Glacier", y="PielouIndex",
#           color="Glacier", ylab="Pielou Index", xlab="Glacier")
# 
# #plot pielou index for each region
# ggboxplot(ab_pie, x="Region", y="PielouIndex",
#           color="Region", ylab="Pielou Index", xlab="Region")
# 
# #plot pielou index for each pole
# ggboxplot(ab_pie, x="Pole", y="PielouIndex",
#           color="Pole", ylab="Pielou Index", xlab="Pole")

ggplot(ab_pie, aes(x=Glacier, y=PielouIndex, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0.8, 1)+
  theme_bw()+
  ylab("Pielou Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(ab_pie, aes(x=Region, y=PielouIndex, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0.15, 1)+
  theme_bw()+
  ylab("Pielou Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(ab_pie, aes(x=Pole, y=PielouIndex, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0.15, 1)+
  theme_bw()+
  ylab("Pielou Index")+
    geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

4.2.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier pielou index
#ANOVA
res.aov.ab.pie.gla <- aov(PielouIndex ~ Glacier, data = ab_pie)
#Summary of analysis
summary(res.aov.ab.pie.gla) #p value < 0.05 significant difference between glaciers

#Test for significant differences between region pielou index
#ANOVA
res.aov.ab.pie.reg <- aov(PielouIndex ~ Region, data = ab_pie)
#Summary of analysis
summary(res.aov.ab.pie.reg) #p value < 0.05 significant difference between regions
```

4.2.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(PielouIndex ~ Glacier, data = ab_pie) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ab.pie.gla <- residuals(object = res.aov.ab.pie.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ab.pie.gla) #p > 0.05 which suggests the data ARE normally distributed

#ANOVA VALID

#REGION
#use levene's test to check homogeny of variances
leveneTest(PielouIndex ~ Region, data = ab_pie) #p > 0.05 variance across groups NOT significantly different so data DOES meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ab.pie.reg <- residuals(object = res.aov.ab.pie.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ab.pie.reg) #p > 0.05 which suggests the data ARE normally distributed

#ANOVA VALID

```

4.2.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
# #Differences between glaciers
# kruskal.test(ShannonIndex ~ Glacier, data = ab_shan) #p < 0.05 so the differences between the medians ARE statistically significant
# 
# #Differences between regions
# kruskal.test(ShannonIndex ~ Region, data = ab_shan) #p < 0.05 so the differences between the medians ARE statistically significant

```


4.2.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Pielou Index
with(ab_pie, shapiro.test(PielouIndex[Pole == "Arctic"]))# p > 0.05 so normally distributed

# Shapiro-Wilk normality test for Antarctic Pielou Index
with(ab_pie, shapiro.test(PielouIndex[Pole == "Antarctic"])) #p > 0.05 normally distributed

#Do the two populations have the same variances?
res.ftest.ab.pie.pol <- var.test(PielouIndex ~ Pole, data = ab_pie)
res.ftest.ab.pie.pol #p > 0.05 so variances ARE NOT significantly different

#ASSUMPTIONS ARE MET FOR PARAMETRIC TEST

#NEED TWO SAMPLE T TEST
res1 <- t.test(PielouIndex ~ Pole, data = ab_pie, var.equal = TRUE) # p < 0.05 poles are significantly different
res1
res2 <- t.test(PielouIndex ~ Pole, data = ab_pie, var.equal = TRUE, alternative="less")
res2 #p < 0.05 so Antarctic significantly less than Arctic


# #Wilcoxon Test
# wilcox.test(ab_shan$ShannonIndex ~ ab_shan$Pole,
#   alternative = "less"
# )

```

4.2.10 Use dunn's or Tukey test to see which glaciers are different
```{r}
TukeyHSD(res.aov.ab.pie.gla)
TukeyHSD(res.aov.ab.pie.reg)

# dunnTest(PielouIndex ~ Glacier, data=ab_shan, method="bh")
# dunnTest(ShannonIndex ~ Region, data=ab_shan, method="bh")
```

INTERMEDIATE TAXA
4.3.1 Pull intermediate taxa data from phyloseq object and create dataframe
4.3.2 Intermediate taxa for each glacier + summary stats
4.3.3 Intermediate taxa for each region + summary stats
4.3.4 Intermediate taxa for each pole + summary stats
4.3.5 Boxplots showing range of Intermediate pielou index for glacier/region/pole
4.3.6 Significant tests for differences between glaciers/regions/poles
4.3.7 Test the validity of the ANOVA
4.3.8 Run kruskal wallis tests if data do not meet ANOVA assumption
4.3.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
4.3.10 Use dunn's or tukey test to see which glaciers are different

4.3.1 Pull intermediate taxa data from phyloseq object and create dataframe
```{r}
asv_counts <- as.data.frame(otu_table(ps.glaciers.merged.I))

#get sample data
samp_data <- data.frame(sample_data(ps.glaciers.merged.I))

#find pielou index of each sample
data = t(otu_table(ps.glaciers.merged.I))
pielou <- diversity(data, index="shannon")/log(specnumber(data))
i_pie <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, pielou)
colnames(i_pie) <- c("SampleID", "Glacier", "Region", "Pole", "PielouIndex")
i_pie <- as.data.frame(i_pie)
i_pie$PielouIndex <- as.numeric(i_pie$PielouIndex)
```

4.3.2 Intermediate taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(i_pie, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(PielouIndex, na.rm=TRUE),
    sd = sd(PielouIndex, na.rm=TRUE)
  )
```

4.3.3 Intermediate taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(i_pie, Region) %>%
  summarise(
    count=n(),
    mean=mean(PielouIndex, na.rm=TRUE),
    sd = sd(PielouIndex, na.rm=TRUE)
  )
```

4.3.4 Intermediate taxa for each pole + summary stats
```{r}
#compute summary stats for each pole
group_by(i_pie, Pole) %>%
  summarise(
    count=n(),
    mean=mean(PielouIndex, na.rm=TRUE),
    sd = sd(PielouIndex, na.rm=TRUE)
  )
```

4.3.5 Boxplots showing range of Intermediate pielou index for glacier/region/pole
```{r}
# #plot pielou index for each glacier
# ggboxplot(i_pie, x="Glacier", y="PielouIndex",
#           color="Glacier", ylab="Pielou Index", xlab="Glacier")

# Basic boxplot
ggplot(i_pie, aes(x=Glacier, y=PielouIndex, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0.78, 1)+
  theme_bw()+
  ylab("Pielou Index")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# #plot pielou index for each region
# ggboxplot(i_pie, x="Region", y="PielouIndex",
#           color="Region", ylab="Pielou Index", xlab="Region")

# Basic boxplot
ggplot(i_pie, aes(x=Region, y=PielouIndex, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0.78, 1)+
  theme_bw()+
  ylab("Pielou Index")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# #plot pielou index for each pole
# ggboxplot(i_pie, x="Pole", y="PielouIndex",
#           color="Pole", ylab="Pielou Index", xlab="Pole")

# Basic boxplot
ggplot(i_pie, aes(x=Pole, y=PielouIndex, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  ylim(0.9, 1)+
  theme_bw()+
  ylab("Pielou Index")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

4.3.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier pielou index
#ANOVA
res.aov.i.pie.gla <- aov(PielouIndex ~ Glacier, data = i_pie)
#Summary of analysis
summary(res.aov.i.pie.gla) #p value > 0.05 NO significant difference between glaciers

#Test for significant differences between region pielou index
#ANOVA
res.aov.i.pie.reg <- aov(PielouIndex ~ Region, data = i_pie)
#Summary of analysis
summary(res.aov.i.pie.reg) #p value > 0.05 NO significant difference between regions
```

4.3.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(PielouIndex ~ Glacier, data = i_pie) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.i.pie.gla <- residuals(object = res.aov.i.pie.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.i.pie.gla) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

#REGION
#use levene's test to check homogeny of variances
leveneTest(PielouIndex ~ Region, data = i_pie) #p > 0.05 variance across groups NOT significantly different so data DOES meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.i.pie.reg <- residuals(object = res.aov.i.pie.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.i.pie.reg) #p < 0.05 which suggests the data ARE NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

```

4.3.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between glaciers
kruskal.test(PielouIndex ~ Glacier, data = i_pie) #p < 0.05 so the differences between the medians ARE statistically significant

#Differences between regions
kruskal.test(PielouIndex ~ Region, data = i_pie) #p > 0.05 so the differences between the medians ARE NOT statistically significant

```


4.3.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Pielou Index
with(i_pie, shapiro.test(PielouIndex[Pole == "Arctic"]))# p < 0.05 so NOT normally distributed

# Shapiro-Wilk normality test for Antarctic Pielou Index
with(i_pie, shapiro.test(PielouIndex[Pole == "Antarctic"])) #p < 0.05 NOT normally distributed

#Do the two populations have the same variances?
res.ftest.i.pie.pol <- var.test(PielouIndex ~ Pole, data = i_pie)
res.ftest.i.pie.pol #p > 0.05 so variances ARE NOT significantly different

#ASSUMPTIONS ARE NOT MET FOR PARAMETRIC TEST
#Wilcoxon Test
wilcox.test(i_pie$PielouIndex ~ i_pie$Pole) #P > 0.05 so not significant different

```

4.3.10 Use dunn's test to see which glaciers are different
```{r}
dunnTest(PielouIndex ~ Glacier, data=i_pie, method="bh")
```

RARE TAXA
4.4.1 Pull rare taxa data from phyloseq object and create dataframe
4.4.2 Rare taxa for each glacier + summary stats
4.4.3 Rare taxa for each region + summary stats
4.4.4 Rare taxa for each pole + summary stats
4.4.5 Boxplots showing range of Rare pielou index for glacier/region/pole
4.4.6 Significant tests for differences between glaciers/regions/poles
4.4.7 Test the validity of the ANOVA
4.4.8 Run kruskal wallis tests if data do not meet ANOVA assumption
4.4.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
4.4.10 Use dunn's test to see which glaciers are different

4.4.1 Pull rare taxa data from phyloseq object and create dataframe
```{r}
asv_counts <- as.data.frame(otu_table(ps.glaciers.merged.RR))

#get sample data
samp_data <- data.frame(sample_data(ps.glaciers.merged.RR))

#find pielou index of each sample
data = t(otu_table(ps.glaciers.merged.RR))
pielou <- diversity(data, index="shannon")/log(specnumber(data))
ra_pie <- cbind(samp_data$SampleID, samp_data$Glacier, samp_data$Region, samp_data$Pole, pielou)
colnames(ra_pie) <- c("SampleID", "Glacier", "Region", "Pole", "PielouIndex")
ra_pie <- as.data.frame(ra_pie)
ra_pie$PielouIndex <- as.numeric(ra_pie$PielouIndex)
```

4.4.2 Rare taxa for each glacier + summary stats
```{r}
#compute summary stats for each glacier
group_by(ra_pie, Glacier) %>%
  summarise(
    count=n(),
    mean=mean(PielouIndex, na.rm=TRUE),
    sd = sd(PielouIndex, na.rm=TRUE)
  )
```

4.4.3 Rare taxa for each region + summary stats
```{r}
#compute summary states for each region
group_by(ra_pie, Region) %>%
  summarise(
    count=n(),
    mean=mean(PielouIndex, na.rm=TRUE),
    sd = sd(PielouIndex, na.rm=TRUE)
  )
```

4.4.4 Rare taxa for each pole + summary stats
```{r}
#compute summar stats for each pole
group_by(ra_pie, Pole) %>%
  summarise(
    count=n(),
    mean=mean(PielouIndex, na.rm=TRUE),
    sd = sd(PielouIndex, na.rm=TRUE)
  )
```

4.4.5 Boxplots showing range of Rare Pielou index for glacier/region/pole
```{r}
# #plot pielou index for each glacier
# ggboxplot(ra_pie, x="Glacier", y="PielouIndex",
#           color="Glacier", ylab="Pielou Index", xlab="Glacier")+
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
# 
# #plot pielou index for each region
# ggboxplot(ra_pie, x="Region", y="PielouIndex",
#           color="Region", ylab="Pielou Index", xlab="Region")
# 
# #plot pielou index for each pole
# ggboxplot(ra_pie, x="Pole", y="PielouIndex",
#           color="Pole", ylab="Pielou Index", xlab="Pole")

ggplot(ra_pie, aes(x=Glacier, y=PielouIndex, color=Glacier))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0.78, 1)+
  theme_bw()+
  ylab("Pielou Index")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(ra_pie, aes(x=Region, y=PielouIndex, color=Region))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0.78, 1)+
  theme_bw()+
  ylab("Pielou Index")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggplot(ra_pie, aes(x=Pole, y=PielouIndex, color=Pole))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0.9, 1)+
  theme_bw()+
  ylab("Pielou Index")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

4.4.6 Significant tests for differences between glaciers/regions/poles
```{r}
#Test for significant differences between glacier pielou index
#ANOVA
res.aov.ra.pie.gla <- aov(PielouIndex ~ Glacier, data = ra_pie)
#Summary of analysis
summary(res.aov.ra.pie.gla) #p value < 0.05 significant difference between glaciers

#Test for significant differences between region pielou index
#ANOVA
res.aov.ra.pie.reg <- aov(PielouIndex ~ Region, data = ra_pie)
#Summary of analysis
summary(res.aov.ra.pie.reg) #p value < 0.05 significant difference between regions
```

4.4.7 Test the validity of the ANOVA
```{r}
#GLACIER
#use levene's test to check homogeny of variances
leveneTest(SimpsonIndex ~ Glacier, data = ra_simp) #p < 0.05  variance across groups is significantly different so data DOES NOT meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ra.simp.gla <- residuals(object = res.aov.ra.simp.gla)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ra.simp.gla) #p < 0.05 which suggests the data are NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

#REGION
#use levene's test to check homogeny of variances
leveneTest(SimpsonIndex ~ Region, data = ra_simp) #p > 0.05 variance across groups NOT significantly different so data DOES meet this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
aov_residuals.ra.simp.reg <- residuals(object = res.aov.ra.simp.reg)

#Run shapiro-wilk test
shapiro.test(x=aov_residuals.ra.simp.reg) #p < 0.05 which suggests the data ARE NOT normally distributed

#ANOVA not valid so need to use kruskal wallis test

```

4.4.8 Run kruskal wallis tests if data do not meet ANOVA assumption
```{r}
#Differences between glaciers
kruskal.test(PielouIndex ~ Glacier, data = ra_pie) #p < 0.05 so the differences between the medians ARE statistically significant

#Differences between regions
kruskal.test(PielouIndex ~ Region, data = ra_pie) #p < 0.05 so the differences between the medians ARE statistically significant

```

4.4.9 Two sample t-test or wilcoxon test for differences between two groups (poles)
```{r}
#POLE
#For this we will use two-sample t-test but our data need to meet certain assumptions
#Are the data from each group normally distributed?
# Shapiro-Wilk normality test for Arctic Pielou Index
with(ra_pie, shapiro.test(PielouIndex[Pole == "Arctic"]))# p < 0.05 so NOT normally distributed

# Shapiro-Wilk normality test for Antarctic Pielou Index
with(ra_pie, shapiro.test(PielouIndex[Pole == "Antarctic"])) #p < 0.05 NOT normally distributed

#Do the two populations have the same variances?
res.ftest.ra.pie.pol <- var.test(PielouIndex ~ Pole, data = ra_pie)
res.ftest.ra.pie.pol #p < 0.05 so variances ARE significantly different

#ASSUMPTIONS ARE NOT MET FOR PARAMETRIC TEST

#Wilcoxon Test
wilcox.test(ra_pie$PielouIndex ~ ra_pie$Pole) # p < 0.05 so poles are significantly different
wilcox.test(ra_pie$PielouIndex ~ ra_pie$Pole, alternative = "greater") #p < 0.05 so Antarctic is greater than Arctic

# res <- t.test(ShannonIndex ~ Pole, data = ra_shan, var.equal = TRUE)
# res #p > 0.05 not significant difference betwen the poles
# 
# # res <- t.test(ShannonIndex ~ Pole, data = ra_shan, var.equal = TRUE, alternative="less")
# # res 

```

4.4.10 Use dunn's test to see which glaciers are different
```{r}
#We have detected significant differences in pielou index between the glaciers, regions and the poles
dunnTest(PielouIndex ~ Glacier, data=ra_pie, method="bh")
dunnTest(PielouIndex ~ Region, data=ra_pie, method="bh")
```
4.5 Plots
4.5.2 Plot this as a boxplot showing the range of values (abundant/rare/intermediate)
```{r}
#Add abundant/rare/intermediate column to our count tables
ab_pie$Abundance <- "Abundant"
i_pie$Abundance <- "Intermediate"
ra_pie$Abundance <- "Rare"

#merge dataframes
df <- rbind(ab_pie, i_pie, ra_pie)

# Basic boxplot
ggplot(df, aes(x=Abundance, y=PielouIndex, color=Abundance, fill=Pole))+
  geom_boxplot(outlier.shape = NA)+
  #ylim(0, 2)+
  theme_bw()+
  ylab("Pielou Index")+
  geom_jitter(shape=16, position=position_jitter(0.2), color="black")

```




