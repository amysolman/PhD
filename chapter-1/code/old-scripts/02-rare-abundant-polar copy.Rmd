---
title: "02-rare-abundant-polar"
author: "Amy Solman"
date: "05/08/2021"
output: html_document
---
In this script I'm going to divide my cryoconite data into subcommunities based on their regional abundance.
Following Liu et al. (2015), Li et al., (2021)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear workspace and load packages
```{r}
rm(list=ls())
graphics.off()

library(phyloseq)
library(dplyr) 
library(plyr)
#install.packages("BiodiversityR") #for rank abundance plot
#library(BiodiversityR)
library(ggplot2)
```

Load data 
```{r}
#load phyloseq object
ps_pro <- readRDS("../results/16S/phylo-objects/16S-phyloseq-object-rarefied-decontam.rds") 
ps_euk <- readRDS("../results/18S/phylo-objects/18S-phyloseq-object-rarefied.rds") 
```

Abundance cut-offs
```{r}
#These are the cut-offs from the literature
# rare_range <- c(0.001, 0.00001, 0.0001, 0.0001, 0.00001, 0.00001, 0.0005, 0.001, 0.0001, 0.001, 0.00001)
# abundant_range <- c(0.01, 0.0005, 0.0001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.001, 0.01, 0.0005)

#I've made my mid-range cut-off, low = half the mid, high = twice the mid
rare_mid <- 0.0001
rare_low <- rare_mid/2
rare_high <- rare_mid*2
abun_mid <- 0.001
abun_low <- abun_mid/2
abun_high <- abun_mid*2

cutoffs.df = data.frame(Scenario=c(1,2,3,4,5,6,7,8,9), Description=c("Low-Low", "Mid-Low", "High-Low", "Low-Mid", "Mid-Mid", "High-Mid", "Low-High", "Mid-High", "High-High"), Rare=c(rare_low, rare_mid, rare_high, rare_low, rare_mid, rare_high, rare_low, rare_mid, rare_high), Abundant=c(abun_low, abun_low, abun_low, abun_mid, abun_mid, abun_mid, abun_high, abun_high, abun_high))

write.csv(cutoffs.df, "../results/16S/tables/abundance-classes/scenarios.csv")
```

Plot mean relative abundance of each ASV (x axis) by number of ASVs (y axis)
```{r}
#Function testing area
# phylo = ps_pro
# pole1 = "Arctic"
# pole2 = "Antarctic"
# kingdom = "16S"
# 
# output1 <- abundance_frequences_cutoffs(ps_pro, "Arctic", "Antarctic", "16S")
# output2 <- abundance_frequences_cutoffs(ps_pro, "Antarctic", "Arctic", "16S")

abundance_frequences_cutoffs <- function(phylo, kingdom){
  
#subset by pole
phylo_sub1 <- subset_samples(phylo, Pole == "Arctic")
phylo_sub2 <- subset_samples(phylo, Pole == "Antarctic")
  
#transform to relative abundance
rel1 = transform_sample_counts(phylo_sub1, function(x) x / sum(x) )
rel2 = transform_sample_counts(phylo_sub2, function(x) x / sum(x) )

#remove rows with zero relative abundance
rel1 = filter_taxa(rel1, function(x) mean(x) > 0, TRUE)
rel2 = filter_taxa(rel2, function(x) mean(x) > 0, TRUE)

#get count table
rel_asv1 <- data.frame(otu_table(rel1))
rel_asv2 <- data.frame(otu_table(rel2))

#find column means
mean_rel_abun1 <- rowMeans(rel_asv1)
mean_rel_abun2 <- rowMeans(rel_asv2)

#count the mean relative abundances
df1 <- count(mean_rel_abun1)
df1$Pole <- "Arctic"
df2 <- count(mean_rel_abun2)
df2$Pole <- "Antarctic"
df3 <- rbind(df1, df2)

p1 <- ggplot(df3, aes(x=x, y=freq, color=Pole)) + 
  geom_point()+
  geom_vline(xintercept = rare_low, linetype="dotted", 
                color = "blue", size=0.5)+
    geom_vline(xintercept = rare_mid, linetype="solid", 
                color = "blue", size=0.5)+
    geom_vline(xintercept = rare_high, linetype="dotted", 
                color = "blue", size=0.5)+
  geom_vline(xintercept = abun_low, linetype="dotted", 
                color = "red", size=0.5)+
    geom_vline(xintercept = abun_mid, linetype="solid", 
                color = "red", size=0.5)+
    geom_vline(xintercept = abun_high, linetype="dotted", 
                color = "red", size=0.5)+
  scale_x_continuous(trans='log10')+
  xlab("Log10 Mean Relative Abundance")+
  ylab("Frequency")+
  ggtitle(paste0("Frequency of Mean Relative Abundance of ", kingdom, " ASVs"))+
  theme_bw()

    pdf(paste0("../results/", kingdom, "/graphs/abundance-class/", kingdom, "-abundance-frequency-cutoffs.pdf"))
    print(p1)
    dev.off()
    
    
  #export list of ASVs with classifications
  #list of ASVs with mean relative abundance
  # df2 <- data.frame(ASV=row.names(rel_asv), RelAbun=mean_rel_abun)
  # 
  # return(df2)
}

```

Function to merge phyloseq objects of same abundance class
```{r}
combine_phyloseq <- function(phylo1, phylo2, phylo3){
  #get our arctic abundance count table
abun_count1 <- data.frame(otu_table(phylo1), check.names = FALSE)
names(abun_count1) <- sample_data(phylo1)$SampleID
abun_count1$ASV <- row.names(abun_count1)
#get our antarctic abundance count table
abun_count2 <- data.frame(otu_table(phylo2), check.names = FALSE)
names(abun_count2) <- sample_data(phylo2)$SampleID
abun_count2$ASV <- row.names(abun_count2)
x <- dplyr::bind_rows(abun_count1, abun_count2)
x[is.na(x)] <- 0
#aggregate rows by ASV ID
y <- ddply(x,"ASV",numcolwise(sum))
row.names(y) <- y$ASV
y <- subset(y, select=-c(ASV))

my_subset <- subset(otu_table(phylo3), rownames(otu_table(phylo3)) %in% row.names(y))
new_physeq <- merge_phyloseq(my_subset, tax_table(phylo3), sample_data(phylo3), phy_tree(phylo3))
return(new_physeq)
}
```

Function for getting phyloseq objects by abundance under one scenario
```{r}
#Function testing area
# out <- get_my_phyloseq_objects(ps_pro, 0.00005, 0.0005)
# phylo = ps_pro
# rare = 0.00005
# abundant= 0.0005

get_my_phyloseq_objects <- function(phylo, rare, abundant){
  
  #subset phyloseq object by pole
  ps1 <- subset_samples(phylo, Pole == "Arctic")
  
  #get relative abundances
  ps1_rel  = transform_sample_counts(ps1, function(x) x / sum(x) )
  
  #remove ASVs with zero relative abundance
  ps1_rel = filter_taxa(ps1_rel, function(x) sum(x) > 0, TRUE)
  
  #filter taxa by mean relative abundance
  ps1_rel_rare = filter_taxa(ps1_rel, function(x) mean(x) <= rare, TRUE)
  ps1_rel_abundant = filter_taxa(ps1_rel, function(x) mean(x) >= abundant, TRUE)
  ps1_rel_intermediate = filter_taxa(ps1_rel, function(x) mean(x) > rare && mean(x) < abundant, TRUE)
  
  #subset phyloseq object by pole
  ps2 <- subset_samples(phylo, Pole == "Antarctic")
  
  #get relative abundances
  ps2_rel  = transform_sample_counts(ps2, function(x) x / sum(x) )
  
  #remove ASVs with zero relative abundance
  ps2_rel = filter_taxa(ps2_rel, function(x) sum(x) > 0, TRUE)
  
  #filter taxa by mean relative abundance
  ps2_rel_rare = filter_taxa(ps2_rel, function(x) mean(x) <= rare, TRUE)
  ps2_rel_abundant = filter_taxa(ps2_rel, function(x) mean(x) >= abundant, TRUE)
  ps2_rel_intermediate = filter_taxa(ps2_rel, function(x) mean(x) > rare && mean(x) < abundant, TRUE)
  
  #merge arctic and antarctic phyloseq objects under this scenario 
  phylo.rare <- combine_phyloseq(ps1_rel_rare, ps2_rel_rare, phylo)
  phylo.abundant <- combine_phyloseq(ps1_rel_abundant, ps2_rel_abundant, phylo)
  phylo.intermediate <- combine_phyloseq(ps1_rel_intermediate, ps2_rel_intermediate, phylo)
  
  #save phyloseq object to list ready to be returned
  list<-list()
  list[[1]] <- phylo.rare
  list[[2]] <- phylo.abundant
  list[[3]] <- phylo.intermediate
  
  return(list)
  
}
```

Function: Get my phyloseq objects under different scenarios
```{r}
get_multi_lists <- function(phylo, df){
  res <- list()
for (i in 1:nrow(df)){
  rare = df$Rare[i]
  abundant= df$Abundant[i]
  x <- get_my_phyloseq_objects(phylo, rare, abundant)
  res[[i]] <- x
}
  return(res)
}

#Function testing area
# pro_multi_list_res <- get_multi_lists(ps_pro, cutoffs.df)
# phylo = ps_pro
# df = cutoffs.df
```

Now create the phyloseq objects ready to export!
```{r}
#16S
abundance_frequences_cutoffs(ps_pro, "16S")
pro_multi_list_res <- get_multi_lists(ps_pro, cutoffs.df)

#18S
abundance_frequences_cutoffs(ps_euk, "18S")
euk_multi_list_res <- get_multi_lists(ps_euk, cutoffs.df)
```

Export phyloseq objects
```{r}
#Prokaryotic rare ASVs scenario one
saveRDS(pro_multi_list_res[[1]][[1]], "../results/16S/phylo-objects/16S-polar-rare-scenario-one.rds")
#Prokaryotic abundant ASVs scenario one
saveRDS(pro_multi_list_res[[1]][[2]], "../results/16S/phylo-objects/16S-polar-abundant-scenario-one.rds")
#Prokaryotic intermediate ASVs scenario one
saveRDS(pro_multi_list_res[[1]][[3]], "../results/16S/phylo-objects/16S-polar-intermediate-scenario-one.rds")

#Prokaryotic rare ASVs scenario two
saveRDS(pro_multi_list_res[[2]][[1]], "../results/16S/phylo-objects/16S-polar-rare-scenario-two.rds")
#Prokaryotic abundant ASVs scenario two
saveRDS(pro_multi_list_res[[2]][[2]], "../results/16S/phylo-objects/16S-polar-abundant-scenario-two.rds")
#Prokaryotic intermediate ASVs scenario two
saveRDS(pro_multi_list_res[[2]][[3]], "../results/16S/phylo-objects/16S-polar-intermediate-scenario-two.rds")

#Prokaryotic rare ASVs scenario three
saveRDS(pro_multi_list_res[[3]][[1]], "../results/16S/phylo-objects/16S-polar-rare-scenario-three.rds")
#Prokaryotic abundant ASVs scenario three
saveRDS(pro_multi_list_res[[3]][[2]], "../results/16S/phylo-objects/16S-polar-abundant-scenario-three.rds")
#Prokaryotic intermediate ASVs scenario three
saveRDS(pro_multi_list_res[[3]][[3]], "../results/16S/phylo-objects/16S-polar-intermediate-scenario-three.rds")

#Prokaryotic rare ASVs scenario four
saveRDS(pro_multi_list_res[[4]][[1]], "../results/16S/phylo-objects/16S-polar-rare-scenario-four.rds")
#Prokaryotic abundant ASVs scenario four
saveRDS(pro_multi_list_res[[4]][[2]], "../results/16S/phylo-objects/16S-polar-abundant-scenario-four.rds")
#Prokaryotic intermediate ASVs scenario four
saveRDS(pro_multi_list_res[[4]][[3]], "../results/16S/phylo-objects/16S-polar-intermediate-scenario-four.rds")

#Prokaryotic rare ASVs scenario five
saveRDS(pro_multi_list_res[[5]][[1]], "../results/16S/phylo-objects/16S-polar-rare-scenario-five.rds")
#Prokaryotic abundant ASVs scenario five
saveRDS(pro_multi_list_res[[5]][[2]], "../results/16S/phylo-objects/16S-polar-abundant-scenario-five.rds")
#Prokaryotic intermediate ASVs scenario five
saveRDS(pro_multi_list_res[[5]][[3]], "../results/16S/phylo-objects/16S-polar-intermediate-scenario-five.rds")

#Prokaryotic rare ASVs scenario six
saveRDS(pro_multi_list_res[[6]][[1]], "../results/16S/phylo-objects/16S-polar-rare-scenario-six.rds")
#Prokaryotic abundant ASVs scenario six
saveRDS(pro_multi_list_res[[6]][[2]], "../results/16S/phylo-objects/16S-polar-abundant-scenario-six.rds")
#Prokaryotic intermediate ASVs scenario six
saveRDS(pro_multi_list_res[[6]][[3]], "../results/16S/phylo-objects/16S-polar-intermediate-scenario-six.rds")

#Prokaryotic rare ASVs scenario seven
saveRDS(pro_multi_list_res[[7]][[1]], "../results/16S/phylo-objects/16S-polar-rare-scenario-seven.rds")
#Prokaryotic abundant ASVs scenario seven
saveRDS(pro_multi_list_res[[7]][[2]], "../results/16S/phylo-objects/16S-polar-abundant-scenario-seven.rds")
#Prokaryotic intermediate ASVs scenario seven
saveRDS(pro_multi_list_res[[7]][[3]], "../results/16S/phylo-objects/16S-polar-intermediate-scenario-seven.rds")

#Prokaryotic rare ASVs scenario eight
saveRDS(pro_multi_list_res[[8]][[1]], "../results/16S/phylo-objects/16S-polar-rare-scenario-eight.rds")
#Prokaryotic abundant ASVs scenario eight
saveRDS(pro_multi_list_res[[8]][[2]], "../results/16S/phylo-objects/16S-polar-abundant-scenario-eight.rds")
#Prokaryotic intermediate ASVs scenario eight
saveRDS(pro_multi_list_res[[8]][[3]], "../results/16S/phylo-objects/16S-polar-intermediate-scenario-eight.rds")

#Prokaryotic rare ASVs scenario nine
saveRDS(pro_multi_list_res[[9]][[1]], "../results/16S/phylo-objects/16S-polar-rare-scenario-nine.rds")
#Prokaryotic abundant ASVs scenario nine
saveRDS(pro_multi_list_res[[9]][[2]], "../results/16S/phylo-objects/16S-polar-abundant-scenario-nine.rds")
#Prokaryotic intermediate ASVs scenario nine
saveRDS(pro_multi_list_res[[9]][[3]], "../results/16S/phylo-objects/16S-polar-intermediate-scenario-nine.rds")

#Eukaryotic rare ASVs scenario one
saveRDS(euk_multi_list_res[[1]][[1]], "../results/18S/phylo-objects/18S-polar-rare-scenario-one.rds")
#Eukaryotic abundant ASVs scenario one
saveRDS(euk_multi_list_res[[1]][[2]], "../results/18S/phylo-objects/18S-polar-abundant-scenario-one.rds")
#Eukaryotic intermediate ASVs scenario one
saveRDS(euk_multi_list_res[[1]][[3]], "../results/18S/phylo-objects/18S-polar-intermediate-scenario-one.rds")

#Eukaryotic rare ASVs scenario two
saveRDS(euk_multi_list_res[[2]][[1]], "../results/18S/phylo-objects/18S-polar-rare-scenario-two.rds")
#Eukaryotic abundant ASVs scenario two
saveRDS(euk_multi_list_res[[2]][[2]], "../results/18S/phylo-objects/18S-polar-abundant-scenario-two.rds")
#Eukaryotic intermediate ASVs scenario two
saveRDS(euk_multi_list_res[[2]][[3]], "../results/18S/phylo-objects/18S-polar-intermediate-scenario-two.rds")

#Eukaryotic rare ASVs scenario three
saveRDS(euk_multi_list_res[[3]][[1]], "../results/18S/phylo-objects/18S-polar-rare-scenario-three.rds")
#Eukaryotic abundant ASVs scenario three
saveRDS(euk_multi_list_res[[3]][[2]], "../results/18S/phylo-objects/18S-polar-abundant-scenario-thee.rds")
#Eukaryotic intermediate ASVs scenario three
saveRDS(euk_multi_list_res[[3]][[3]], "../results/18S/phylo-objects/18S-polar-intermediate-scenario-three.rds")

#Eukaryotic rare ASVs scenario four
saveRDS(euk_multi_list_res[[4]][[1]], "../results/18S/phylo-objects/18S-polar-rare-scenario-four.rds")
#Eukaryotic abundant ASVs scenario four
saveRDS(euk_multi_list_res[[4]][[2]], "../results/18S/phylo-objects/18S-polar-abundant-scenario-four.rds")
#Eukaryotic intermediate ASVs scenario four
saveRDS(euk_multi_list_res[[4]][[3]], "../results/18S/phylo-objects/18S-polar-intermediate-scenario-four.rds")

#Eukaryotic rare ASVs scenario five
saveRDS(euk_multi_list_res[[5]][[1]], "../results/18S/phylo-objects/18S-polar-rare-scenario-five.rds")
#Eukaryotic abundant ASVs scenario five
saveRDS(euk_multi_list_res[[5]][[2]], "../results/18S/phylo-objects/18S-polar-abundant-scenario-five.rds")
#Eukaryotic intermediate ASVs scenario five
saveRDS(euk_multi_list_res[[5]][[3]], "../results/18S/phylo-objects/18S-polar-intermediate-scenario-five.rds")

#Eukaryotic rare ASVs scenario six
saveRDS(euk_multi_list_res[[6]][[1]], "../results/18S/phylo-objects/18S-polar-rare-scenario-six.rds")
#Eukaryotic abundant ASVs scenario six
saveRDS(euk_multi_list_res[[6]][[2]], "../results/18S/phylo-objects/18S-polar-abundant-scenario-six.rds")
#Eukaryotic intermediate ASVs scenario six
saveRDS(euk_multi_list_res[[6]][[3]], "../results/18S/phylo-objects/18S-polar-intermediate-scenario-six.rds")

#Eukaryotic rare ASVs scenario seven
saveRDS(euk_multi_list_res[[7]][[1]], "../results/18S/phylo-objects/18S-polar-rare-scenario-seven.rds")
#Eukaryotic abundant ASVs scenario seven
saveRDS(euk_multi_list_res[[7]][[2]], "../results/18S/phylo-objects/18S-polar-abundant-scenario-seven.rds")
#Eukaryotic intermediate ASVs scenario seven
saveRDS(euk_multi_list_res[[7]][[3]], "../results/18S/phylo-objects/18S-polar-intermediate-scenario-seven.rds")

#Eukaryotic rare ASVs scenario eight
saveRDS(euk_multi_list_res[[8]][[1]], "../results/18S/phylo-objects/18S-polar-rare-scenario-eight.rds")
#Eukaryotic abundant ASVs scenario eight
saveRDS(euk_multi_list_res[[8]][[2]], "../results/18S/phylo-objects/18S-polar-abundant-scenario-eight.rds")
#Eukaryotic intermediate ASVs scenario eight
saveRDS(euk_multi_list_res[[8]][[3]], "../results/18S/phylo-objects/18S-polar-intermediate-scenario-eight.rds")

#Eukaryotic rare ASVs scenario nine
saveRDS(euk_multi_list_res[[9]][[1]], "../results/18S/phylo-objects/18S-polar-rare-scenario-nine.rds")
#Eukaryotic abundant ASVs scenario nine
saveRDS(euk_multi_list_res[[9]][[2]], "../results/18S/phylo-objects/18S-polar-abundant-scenario-nine.rds")
#Eukaryotic intermediate ASVs scenario nine
saveRDS(euk_multi_list_res[[9]][[3]], "../results/18S/phylo-objects/18S-polar-intermediate-scenario-nine.rds")
```