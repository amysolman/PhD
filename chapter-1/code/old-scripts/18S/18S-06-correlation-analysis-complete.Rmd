---
title: "Basic Multivariate Analysis"
author: "Amy Solman"
date: "06/10/2021"
output: html_document
---

This script will perform basic multivariate analysis on my data.

The questions we want to answer are:
Is alpha diversity significantly correlated with distance to sea/elevation/water depth/sediment depth/total depth/sediment volume/water volume/temperature/conductivity/pH/DO/DOC/C/TDN/TIN/TON/N/DON/TCP/DOP/Cl/SO4/Na/K/Mg/Ca/HCO3/PO4/NO2/SiO2/F/NH4/NO3?

Is ASV richness significantly correlated with any of the continuous environmental variables?

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear workspace and load packages
```{r}
rm(list=ls())
graphics.off()

library(ggpubr) #for making my boxplots

```

Step Two: Load data 
```{r}
#TOTAL DATASET
ps <- readRDS("../../results/18S/phylo-objects/18S-phyloseq-object-rarefied.rds")

#Total Abundant
ps.abun <- readRDS("../../results/18S/phylo-objects/18S-total-abundant.rds")
#Total Intermediate
ps.int <- readRDS("../../results/18S/phylo-objects/18S-total-intermediate.rds")
#Total Rare
ps.rare <- readRDS("../../results/18S/phylo-objects/18S-total-rare.rds")
```

Function to get observed species and shannon diversity with metadata
```{r}

diversity_and_meta <- function(phylo){
  

#Get metadata of samples
samp_data <- data.frame(sample_data(phylo))

#list of variables we're interested in 
keeps <- c("SampleID", "Name", "Glacier", "Pole", "Group", "Distance_To_Sea", "Elevation", "Water_Depth", "Sediment_Depth", "Total_Depth","Conductivity", "pH", "DOC_mgL.1",
           "Cl_merge", "SO4_merge", "Na_merge", "K_merge", "Mg_merge","Ca_merge", "HCO3_merge", "Radius", "EW", "NS")
samp_data <- samp_data[ , (names(samp_data) %in% keeps)]

#get cryoconite hole areas
area1 <- pi*samp_data$Radius^2
area2 <- pi*(samp_data$NS/2)*(samp_data$EW/2)
samp_data$Area <- coalesce(area1,area2)

#Merge into datafrome
Observed <- estimate_richness(phylo, measures=c("Observed"))
Shannon <- estimate_richness(phylo, measures=c("Shannon"))
samp_data$Observed <- Observed$Observed
samp_data$Shannon <- Shannon$Shannon

drops <- c("EW", "NS", "Radius")
samp_data <- samp_data[ , !(names(samp_data) %in% drops)]

#make sure data are numeric
samp_data[6:23] <- data.frame(lapply(samp_data[6:23],as.numeric))

#change sample names 
names(samp_data) <- c("SampleID", "Group", "Name", "Glacier", "Pole", "Distance_To_Sea", "Elevation", "Water_Depth", "Sediment_Depth", "Total_Depth","Conductivity", "pH", "DOC_mgL.1", "Cl", "SO4", "Na", "K", "Mg","Ca", "HCO3", "Area", "Observed","Shannon")
  
return(samp_data)
}

```

Function for getting dataframe of significant relationships
```{r}

am_i_significant <- function(phylo, index, group){
  

  #get data from our phyloseq object
  my_data <- diversity_and_meta(phylo)
  
  #subset data by group
  newdata <- my_data[ which(my_data$Group == group), ]
  
  #remove columns with more than 50% missing variables
  data_trim <- newdata[ lapply( newdata, function(x) sum(is.na(x)) / length(x) ) < 0.5 ]
  
  #check for normality of diversity index
  index_result <- shapiro.test(data_trim[,index])
  #get p value
  x <- index_result$p.value
  
  #create empty dataframe for our results
  df <- data.frame(var=character(0), p_val=numeric(0))

for (i in 6:(ncol(data_trim)-2)){
  
    if (x >= 0.05){
      data1 <- log(data_trim[,index])
      data2 <- log(as.numeric(data_trim[,i]))
    #if it is normally distributed then calculate correlation using the pearson method
    t <- cor.test(data1, data2, method="pearson", use = "complete.obs")
    
  } else if (x < 0.05) {
    #if it is not normally distributed then calculate correlation using the kendall method
    t <- cor.test(data_trim[,index], as.numeric(data_trim[,i]), method="kendall", use = "complete.obs")
    
  }
  
  var <- colnames(data_trim[i])
  p_val <- t$p.value
  
  j <- i-5
  
  df[j,]$var = var
  df[j,]$p_val = p_val
  
}

  return(df)
  
}

```

Function for visualising significant relationships
```{r}
# phylo = ps
# index = "Observed"
# group = 1

visualise_my_significance <- function(phylo, index, group){
  
  #get results of significance testing
  signif_test <- am_i_significant(phylo, index, group)
  
  #get data for plotting
  my_data <- diversity_and_meta(phylo)
  newdata <- my_data[ which(my_data$Group == group), ]
  data_trim <- newdata[ lapply( newdata, function(x) sum(is.na(x)) / length(x) ) < 0.5 ]
  
  #check for normality of diversity index
  index_result <- shapiro.test(data_trim[,index])
  #get p value
  a <- index_result$p.value
  
  #list to store plots
  my_many_plots <- list()
  
  for (z in 1:nrow(signif_test)){
    
    y <- 1
    
    if (signif_test[z,]$p_val < 0.05 && !is.na(signif_test[z,]$p_val)){
      
      #data_trim_complete <- complete.cases(data_trim)
      
      if (a >= 0.05){
         
         p1 <-ggscatter(data_trim, x = signif_test[z,]$var, y = index, 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = signif_test[z,]$var, ylab = index)+
           ggtitle(paste0("Correlation analysis of ",signif_test[z,]$var, " and ", index))
         p1 <- ggpar(p1, xscale = "log10", yscale = "log10",
                     xlab=paste0("Log10 ", signif_test[z,]$var)) 
               
      } else if (a < 0.05){
          p1 <- ggscatter(data_trim, x = signif_test[z,]$var, y = index, 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "kendall",
          xlab = signif_test[z,]$var, ylab = index)+
            ggtitle(paste0("Correlation analysis of ",signif_test[z,]$var, " and ", index))
      }

      my_many_plots[[y]] <- p1
      y <- y + 1
    }
    
  }

  return(my_many_plots)
  
}

```

Function to print and save all my plots
```{r}
save_my_plots <- function(plots_list, index, group, community){
  
  for (p in 1:length(plots_list)){
    
    plot_to_print <- plots_list[[p]]
    pdf(paste0("../../results/18S/graphs/correlation-analysis/", community, "-correlation-", index, "-",as.character(plot_to_print$labels[3]), "-group-", group, ".pdf"))
    print(plot_to_print)
    dev.off()
  }
}


```

Start testing!
```{r}
#Total
#ps, observed, group 1
total_plots_observed_group_1 <- visualise_my_significance(ps, "Observed", 1)
save_my_plots(total_plots_observed_group_1, "Observed", 1, "total")
#ps, observed, group 2
total_plots_observed_group_2 <- visualise_my_significance(ps, "Observed", 2)
save_my_plots(total_plots_observed_group_2, "Observed", 2, "total")
#ps, shannon, group 1
total_plots_shannon_group_1 <- visualise_my_significance(ps, "Shannon", 1)
save_my_plots(total_plots_shannon_group_1, "Shannon", 1, "total")
#ps, shannon, group 2
total_plots_shannon_group_2 <- visualise_my_significance(ps, "Shannon", 2)
save_my_plots(total_plots_shannon_group_2, "Shannon", 2, "total")

#Abundant
#ps.abun, observed, group 1
abun_plots_observed_group_1 <- visualise_my_significance(ps.abun, "Observed", 1)
save_my_plots(abun_plots_observed_group_1, "Observed", 1, "abundant")
#ps.abun, observed, group 2
abun_plots_observed_group_2 <- visualise_my_significance(ps.abun, "Observed", 2)
save_my_plots(abun_plots_observed_group_2, "Observed", 2, "abundant") 
#ps.abun, shannon, group 1
abun_plots_shannon_group_1 <- visualise_my_significance(ps.abun, "Shannon", 1)
save_my_plots(abun_plots_shannon_group_1, "Shannon", 1, "abundant")
#ps.abun, shannon, group 2
abun_plots_shannon_group_2 <- visualise_my_significance(ps.abun, "Shannon", 2)
save_my_plots(abun_plots_shannon_group_2, "Shannon", 2, "abundant")

#Intermediate
#ps.int, observed, group 1
int_plots_observed_group_1 <- visualise_my_significance(ps.int, "Observed", 1)
save_my_plots(int_plots_observed_group_1, "Observed", 1, "intermediate")
#ps.int, observed, group 2
int_plots_observed_group_2 <- visualise_my_significance(ps.int, "Observed", 2)
save_my_plots(int_plots_observed_group_2, "Observed", 2, "intermediate")
#ps.int, shannon, group 1
int_plots_shannon_group_1 <- visualise_my_significance(ps.int, "Shannon", 1)
#save_my_plots(int_plots_shannon_group_1, "Shannon", 1, "intermediate") #no plots
#ps.int, shannon, group 2
int_plots_shannon_group_2 <- visualise_my_significance(ps.int, "Shannon", 2)
#save_my_plots(int_plots_shannon_group_2, "Shannon", 2, "intermediate") #no plots

#Rare
#ps.rare, observed, group 1
rare_plots_observed_group_1 <- visualise_my_significance(ps.rare, "Observed", 1)
save_my_plots(rare_plots_observed_group_1, "Observed", 1, "rare") #no plots
#ps.rare, observed, group 2
rare_plots_observed_group_2 <- visualise_my_significance(ps.rare, "Observed", 2)
save_my_plots(rare_plots_observed_group_2, "Observed", 2, "rare")
#ps.rare, shannon, group 1
rare_plots_shannon_group_1 <- visualise_my_significance(ps.rare, "Shannon", 1)
save_my_plots(rare_plots_shannon_group_1, "Shannon", 1, "rare") #no plots
#ps.rare, shannon, group 2
rare_plots_shannon_group_2 <- visualise_my_significance(ps.rare, "Shannon", 2)
save_my_plots(rare_plots_shannon_group_2, "Shannon", 2, "rare") #no plots
```