---
title: "Six Category Abundance Classification Method"
author: "Amy Solman"
date: "16/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#TEST: Sourcing my functions
```{r}
source("abundance-functions.R")
```

#Clear workspace and load data to work with
```{r}
rm(list=ls())

#load phyloseq object
ps_pro <- readRDS("../results/16S/phylo-objects/16S-phyloseq-object-rarefied-decontam.rds") 
ps_euk <- readRDS("../results/18S/phylo-objects/18S-phyloseq-object-rarefied.rds") 
```

#Dummy data
```{R}
ASV1 <- c(0.01, 0.1, 0.02, 0.03, 0.05, 0.03,0.2, 0.1, 0.01, 0.02) #always abundant
ASV2 <-c(0, 0, 0,0, 0.0001, 0.00002, 0.00003, 0.000015, 0.00000043, 0.0001) #always rare
ASV3 <- c(0.002, 0.003, 0.004, 0.003, 0.005, 0.001, 0.002, 0.003, 0.005, 0.004) #moderate
ASV4 <-c(0.001, 0.00002, 0.00003, 0.0009, 0.0008, 0.0005, 0.001, 0, 0, 0) #conditionally rare
ASV5 <- c(0.02, 0.03, 0.02, 0.015, 0.0002, 0.0009, 0.007, 0.0002, 0.0002, 0.05) #conditionally abundant
ASV6 <- c(0, 0.00001, 0.0002, 0.001, 0.01, 0, 0.00002, 0.002, 0.02, 0.05) #conditionally abundant and rare

#combine into dataframe
dummy_data <- rbind(ASV1, ASV2, ASV3, ASV4, ASV5, ASV6)

```

```{r}
my_phylo <-ps_pro


#find the relative abundance of each ASV in each sample
#get the count table data
counts <- data.frame(t(otu_table(my_phylo)))

#transform counts into relative abundance data and get data frame
ps_rel = data.frame(otu_table(transform_sample_counts(my_phylo, function(x) x / sum(x) )))

# #get a list of asvs
# my_asvs <- rownames(data.frame(otu_table(my_phylo)))

# #get a dataframe of ASVs with their relative abundance in each sample
# rel_df <-data.frame(otu_table(ps_rel))

#with ASVs as row names
data <- dummy_data
data <- ps_rel
```

#A.	CLASSIFICATION METHOD ONE: Classify ASVs into six abundance categories: Abundant taxa (AT) with abundance ≥1% in all samples; Rare taxa (RT) with ≤0.01% in all samples; Moderate taxa (MT) with abundance between 0.01% and 1% in all samples; Conditionally rare taxa (CRT) with abundance below 1% in all samples and <0.01% in some samples; Conditionally abundant taxa (CAT) with abundance ≥0.01% in all samples and ≥1% in some samples; Conditionally rare and abundant taxa (CRAT) with abundance varying from rare <0.01% to abundance ≥1%. Combine AT, CAT and CRAT as ‘dominant taxa’ for further analysis. 
#Function to categorise ASVs by relative local abundance. The function needs a phyloseq object. Also needs rare and abundant cutoffs.
```{r}

six_cats <- function(my_phylo, rare_cut, abun_cut){
  
data = data.frame(otu_table(transform_sample_counts(my_phylo, function(x) x / sum(x) )))

#Create vectors to save our ASV names
AT <- vector()
RT <- vector()
MT <- vector()
CRT <- vector()
CAT <- vector()
CRAT <- vector()

for (i in 1:nrow(data)){
  
  #if every value in the row is over 0.01 then save the row name to Always Abundant]
  x <- data[i,] #data for our ASV
  n <- length(x) #our number of samples
  a <- length(x[x >= abun_cut]) #number of samples the ASV is over or equal to 1% 
  b <- length(x[x <= rare_cut]) # less than or equal to 0.01%
  c <- length(x[x > rare_cut & x < abun_cut]) # between 0.01% and 1%
  
  if (a == n){
    AT <- c(AT,row.names(data)[i])
  } else if (b == n){
    RT <- c(RT, row.names(data)[i])
  } else if (c == n){
    MT <- c(MT, row.names(data)[i])
  } else if (a == 0 & b > 0 & b < n){
    CRT <- c(CRT, row.names(data)[i])
  } else if (b == 0 & a > 0 & a < n){
    CAT <- c(CAT, row.names(data)[i])
  } else if (a > 0 & a < n & b > 0 & b < n){
      CRAT <- c(CRAT, row.names(data)[i])
    }
}

#bind and return our results
AT_res <- cbind(rep("AT", length(AT)), AT)
RT_res <- cbind(rep("RT", length(RT)), RT)
MT_res <- cbind(rep("MT", length(MT)), MT)
CRT_res <- cbind(rep("CRT", length(CRT)), CRT)
CAT_res <- cbind(rep("CAT", length(CAT)), CAT)
CRAT_res <- cbind(rep("CRAT", length(CRAT)), CRAT)

six_cat_res <- rbind(AT_res, RT_res, MT_res, CRT_res, CAT_res, CRAT_res)

return(six_cat_res)

}

```

#B.	CLASSIFICATION METHOD TWO: Calculate the local (within sample) relative abundance of each ASV. Locally abundant ASVs will be those relative abundance >1%. Locally rare ASVs <0.01% within a sample. Regional abundant ASVs mean relative abundance of >0.1% across all samples and regionally rare ASVs < 0.001%. 
#Function to categorise ASVs by relative local abundance. The function needs a phyloseq object. Also needs rare and abundant cutoffs.
```{r}

sample_three_cats <- function(my_phylo, rare_cut, abun_cut){
  
data = data.frame(otu_table(transform_sample_counts(my_phylo, function(x) x / sum(x) )))

#mean relative abundance for all ASVs
mean_rel_abun <- rowMeans(data)

#Create vectors to save our ASV names
AT <- vector()
RT <- vector()
MT <- vector()

for (i in 1:length(mean_rel_abun)){
  
  if (mean_rel_abun[[i]] >= abun_cut){
    AT <- c(AT,names(mean_rel_abun)[i])
  } else if (mean_rel_abun[[i]] <= rare_cut){
    RT <- c(RT, names(mean_rel_abun)[i])
  } else if (mean_rel_abun[[i]] < abun_cut & mean_rel_abun[[i]] > rare_cut){
    MT <- c(MT, names(mean_rel_abun)[i])
  } 
}

#bind and return our results
AT_res <- cbind(rep("AT", length(AT)), AT)
RT_res <- cbind(rep("RT", length(RT)), RT)
MT_res <- cbind(rep("MT", length(MT)), MT)

sample_three_cat_res <- rbind(AT_res, RT_res, MT_res)

return(sample_three_cat_res)

}

```

C.	CLASSIFICATION METHOD THREE: Abundant ASVs those with relative abundance >0.1% of total sequences. Rare ASVs as those with relative abundance <0.01% of total sequences.
#Function to categorise ASVs by relative local abundance. The function needs a phyloseq object. Also needs rare and abundant cutoffs.
```{r}

# my_phylo = ps_pro
# abun_cut =0.001
# rare_cut = 0.00001

data_three_cats <- function(my_phylo, rare_cut, abun_cut){

#relative abundance for each ASV across the whole dataset
data <- data.frame(otu_table(my_phylo))
ASV_rel_abun <- rowSums(data)/sum(colSums(data))

#Create vectors to save our ASV names
AT <- vector()
RT <- vector()
MT <- vector()

for (i in 1:length(ASV_rel_abun)){
  
  if (ASV_rel_abun[[i]] >= abun_cut){
    AT <- c(AT,names(ASV_rel_abun)[i])
  } else if (ASV_rel_abun[[i]] <= rare_cut){
    RT <- c(RT, names(ASV_rel_abun)[i])
  } else if (ASV_rel_abun[[i]] < abun_cut & ASV_rel_abun[[i]] > rare_cut){
    MT <- c(MT, names(ASV_rel_abun)[i])
  } 
}

#bind and return our results
AT_res <- cbind(rep("AT", length(AT)), AT)
RT_res <- cbind(rep("RT", length(RT)), RT)
MT_res <- cbind(rep("MT", length(MT)), MT)

data_three_cat_res <- rbind(AT_res, RT_res, MT_res)

return(data_three_cat_res)

}

```