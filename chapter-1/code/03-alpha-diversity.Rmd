---
title: "Alpha Diversity"
author: "Amy Solman"
date: "24/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script explores the alpha diversity of this 16S data. I will answer the questions:
Are there significant differences in alpha diversity between the poles and between the glaciers?
How does this change for total, abundant, intermediate and rare communities?

Alpha diversity indices I will use are:
- Richness
- Shannon Index (Shannon's index accounts for both abundance and evenness of the species present) 

Step One: Clear workspace and load packages
```{r}
rm(list=ls())
graphics.off()

library(dplyr) #for computing summary statistics
library(ggpubr) #for making my boxplots
library(FSA) #for dunn's test
#library(vegan) #for diversity indices
library(car)
library(tidyverse) #for converting to tibble
```

Function to import subcommunity data
```{r}
get_my_communities <- function(domain, area){
  big_list <- list()
my_list <- list()
for (i in 1:9){
  my_list[[1]] <- readRDS(paste0("../results/", domain, "/phylo-objects/", domain, "-", area, "-abundant-scenario-", i, ".rds"))
  my_list[[2]] <- readRDS(paste0("../results/", domain, "/phylo-objects/", domain, "-", area, "-intermediate-scenario-", i, ".rds"))
  my_list[[3]] <- readRDS(paste0("../results/", domain, "/phylo-objects/", domain, "-", area, "-rare-scenario-", i, ".rds"))
  
  big_list[[i]] <- my_list
  
}

return(big_list)
}

```

Load data 
```{r}
#Prokaryotic datasets
pro <- readRDS("../results/16S/phylo-objects/16S-phyloseq-object-rarefied-decontam.rds")
pro_pole_data <- get_my_communities("16S", "Pole")
pro_region_data <- get_my_communities("16S", "Region")

#Eukaryotic datasets
euk <- readRDS("../results/18S/phylo-objects/18S-phyloseq-object-rarefied.rds")
euk_pole_data <- get_my_communities("18S", "Pole")
euk_region_data <- get_my_communities("18S", "Region")
```

Function for getting table of alpha diversity for our data sets
```{r}

alpha_diversity_megaframe <- function(data, area, domain){
  #Empty data frame for storing our results
y <- data.frame()
  for (i in 1:length(data)){
  
  abundance_classes <- c("Abundant", "Intermediate", "Rare")
  
  for (j in 1:length(abundance_classes)){
    x <- estimate_richness(data[[i]][[j]], measures = c("Observed", "Chao1", "ACE", "Shannon", "Simpson", "InvSimpson"))
    row.names(x) <- data.frame(sample_data(data[[i]][[j]]))$SampleID
    x$Glacier <- data.frame(sample_data(data[[i]][[j]]))$Glacier
    x$Region <- data.frame(sample_data(data[[i]][[j]]))$Region
    x$Pole <- data.frame(sample_data(data[[i]][[j]]))$Pole
    x$Domain <- domain
    x$Area <- area
    x$Scenario <- i
    x$Abundance_Class <- abundance_classes[j]
    y <- rbind(y, x)
  }
  }

return(y)
}

# #Function testing area
# data = pro_region_data
# area = "Region"
# domain = "16S"

```

Get the alpha diversity table for communities
```{r}
#Pro pole
pro_pole_alpha_df <- alpha_diversity_megaframe(pro_pole_data, "Pole", "16S")
#Pro region
pro_region_alpha_df <- alpha_diversity_megaframe(pro_region_data, "Region", "16S")
#Euk pole
euk_pole_alpha_df <- alpha_diversity_megaframe(euk_pole_data, "Pole", "18S")
#Euk region
euk_region_alpha_df <- alpha_diversity_megaframe(euk_region_data, "Region", "18S")

#Total community alpha diversity
pro_alpha_df <- estimate_richness(pro, measures = c("Observed", "Chao1", "ACE", "Shannon", "Simpson", "InvSimpson"))
    row.names(pro_alpha_df) <- data.frame(sample_data(pro))$SampleID
    pro_alpha_df$Glacier <- data.frame(sample_data(pro))$Glacier
    pro_alpha_df$Region <- data.frame(sample_data(pro))$Region
    pro_alpha_df$Pole <- data.frame(sample_data(pro))$Pole
    pro_alpha_df$Domain <- "16S"
    pro_alpha_df$Area <- NA
    pro_alpha_df$Scenario <- 0
    pro_alpha_df$Abundance_Class <- "Total"
    
euk_alpha_df <- estimate_richness(euk, measures = c("Observed", "Chao1", "ACE", "Shannon", "Simpson", "InvSimpson"))
    row.names(euk_alpha_df) <- data.frame(sample_data(euk))$SampleID
    euk_alpha_df$Glacier <- data.frame(sample_data(euk))$Glacier
    euk_alpha_df$Region <- data.frame(sample_data(euk))$Region
    euk_alpha_df$Pole <- data.frame(sample_data(euk))$Pole
    euk_alpha_df$Domain <- "18S"
    euk_alpha_df$Area <- NA
    euk_alpha_df$Scenario <- 0
    euk_alpha_df$Abundance_Class <- "Total"

#merge dataframes
total_data <- rbind(pro_alpha_df, euk_alpha_df, pro_pole_alpha_df, pro_region_alpha_df, euk_pole_alpha_df, euk_region_alpha_df)

#Save
write.csv(total_data, "../results/all/tables/alpha-diversity/total-alpha-diversity.csv")
```

Now what do I want to know about alpha diversity?
What is the mean and standard deviation Observed and Shannon Richness for the Total Communities by Pole, by Region and by Glacier?
```{r}
#subset data to total data
total_data_only <- total_data[total_data$Abundance_Class == "Total",]

#convert to tibble for easier analysis
total_data_only_tib <- as_tibble(total_data_only)

#get mean and number of observations globally
t1 <- total_data_only_tib %>%
  group_by(Domain) %>%
  dplyr::summarise(
          count = n(),
          mean_obs = mean(Observed, na.rm = TRUE),
          mean_shan = mean(Shannon, na.rm = TRUE),
          sd_obs = sd(Observed, na.rm = T),
          sd_shan = sd(Shannon, na.rm = T)
          )

#get mean and number of observations by pole
t2 <- total_data_only_tib %>%
  group_by(Pole, Domain) %>%
  dplyr::summarise(
          count = n(),
          mean_obs = mean(Observed, na.rm = TRUE),
          mean_shan = mean(Shannon, na.rm = TRUE),
          sd_obs = sd(Observed, na.rm = T),
          sd_shan = sd(Shannon, na.rm = T)
          )

#get mean and number of observations by region
t3 <- total_data_only_tib %>%
  group_by(Region, Domain) %>%
  dplyr::summarise(
          count = n(),
          mean_obs = mean(Observed, na.rm = TRUE),
          mean_shan = mean(Shannon, na.rm = TRUE),
          sd_obs = sd(Observed, na.rm = T),
          sd_shan = sd(Shannon, na.rm = T)
          )

#get mean and number of observations by glacier
t4 <- total_data_only_tib %>%
  group_by(Glacier, Domain) %>%
  dplyr::summarise(
          count = n(),
          mean_obs = mean(Observed, na.rm = TRUE),
          mean_shan = mean(Shannon, na.rm = TRUE),
          sd_obs = sd(Observed, na.rm = T),
          sd_shan = sd(Shannon, na.rm = T)
          )

#prep for export
t1$Area <- "Global"
t1$Group <- "Global"
names(t2)[names(t2) == "Pole"] <- "Area"
t2$Group <- "Polar"
names(t3)[names(t3) == "Region"] <- "Area"
t3$Group <- "Regional"
names(t4)[names(t4) == "Glacier"] <- "Area"
t4$Group <- "Glacier"
total_sum <- rbind(t1, t2, t3, t4)
#rearrange data frame
total_sum <- total_sum[,c(8,7,1,2,3,4,5,6)]

write.csv(total_sum, "../results/all/tables/alpha-diversity/total-community-summary-stats.csv")
```

Boxplots of observed and shannon diversity by pole, region and glacier for 16S and 18S
```{r}
#Pole
#boxplot of observed species by pole
p1 <- ggplot(total_data_only, aes(x=Domain, y=Observed, fill=Pole)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  theme_classic()+
  ggtitle("Total Community Observed ASVs by Pole")+
  stat_compare_means()

#region
p2 <- ggplot(total_data_only, aes(x=Domain, y=Observed, fill=Region)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  theme_classic()+
  ggtitle("Total Community Observed ASVs by Region")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  stat_compare_means()

#glacier
p3 <- ggplot(total_data_only, aes(x=Domain, y=Observed, fill=Glacier)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  theme_classic()+
  ggtitle("Total Community Observed ASVs by Glacier")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  stat_compare_means()

#Pole
#boxplot of observed species by pole
p4 <- ggplot(total_data_only, aes(x=Domain, y=Shannon, fill=Pole)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  theme_classic()+
  ggtitle("Total Community Shannon Diversity by Pole")+
  stat_compare_means()

#region
p5 <- ggplot(total_data_only, aes(x=Domain, y=Shannon, fill=Region)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  theme_classic()+
  ggtitle("Total Community Shannon Diversity by Region")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  stat_compare_means()

#glacier
p6 <- ggplot(total_data_only, aes(x=Domain, y=Observed, fill=Glacier)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  theme_classic()+
  ggtitle("Total Community Shannon Diversity by Glacier")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  stat_compare_means()

#save plots
pdf("../results/all/graphs/alpha-diversity/total-community-observed-pole.pdf")
print(p1)
dev.off()
pdf("../results/all/graphs/alpha-diversity/total-community-observed-region.pdf")
print(p2)
dev.off()
pdf("../results/all/graphs/alpha-diversity/total-community-observed-glacier.pdf")
print(p3)
dev.off()
pdf("../results/all/graphs/alpha-diversity/total-community-shannon-pole.pdf")
print(p4)
dev.off()
pdf("../results/all/graphs/alpha-diversity/total-community-shannon-region.pdf")
print(p5)
dev.off()
pdf("../results/all/graphs/alpha-diversity/total-community-shannnon-glacier.pdf")
print(p6)
dev.off()


# Visualize: Specify the comparisons you want
my_comparisons <- list( c("abundant", "intermediate"), c("intermediate", "rare"), c("abundant", "rare") )
p2 <- ggboxplot(df, x = "category", y = "degree",
          color = "category", palette = "jco")+ 
  stat_compare_means(comparisons = my_comparisons)+ # Add pairwise comparisons p-value
  stat_compare_means(label.y = 300)   
```

What are the mean and standard deviation observed and shannon diversities for each of the subcommunities?
```{r}
#convert to tibble for easier analysis
total_data_tib <- as_tibble(total_data)
t5 <- total_data_tib %>%
  group_by(Domain, Scenario, Abundance_Class, Area) %>%
  dplyr::summarise(
          count = n(),
          mean_obs = mean(Observed, na.rm = TRUE),
          mean_shan = mean(Shannon, na.rm = TRUE),
          sd_obs = sd(Observed, na.rm = T),
          sd_shan = sd(Shannon, na.rm = T)
          )

#save table
write.csv(t5, "../results/all/tables/alpha-diversity/alpha-diversity-subcommunities.csv")

```

Is there a statistical different in the number of observed ASVs for upper, mid and lower limit defined abundant communities as defined by polar abundance?
```{r}
#subset by abundance class
#scenario 1 = low limit abundance
#scenario 4 = mid limit abundance
#scenario 7 = high limit abundance
abun_data_low <- total_data[total_data$Abundance_Class == "Abundant" & total_data$Scenario == 1 & total_data$Area == "Pole",]
abun_data_mid <- total_data[total_data$Abundance_Class == "Abundant" & total_data$Scenario == 4 & total_data$Area == "Pole",]
abun_data_high <- total_data[total_data$Abundance_Class == "Abundant" & total_data$Scenario == 7 & total_data$Area == "Pole",]
#bind dataframes
abun_data_low_mid_high <- rbind(abun_data_low, abun_data_mid, abun_data_high)

#boxplot of abundance class with comapred means
ggplot(abun_data_low_mid_high[abun_data_low_mid_high$Domain == "16S",], aes(x=as.factor(Scenario), y=Observed)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  theme_classic()+
  ggtitle("Abundant Community Observed Diversity for low, mid and high limits")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  stat_compare_means()+
  xlab("Abundant Class Limits")

#boxplot of abundance class with comapred means
ggplot(abun_data_low_mid_high[abun_data_low_mid_high$Domain == "16S",], aes(x=as.factor(Scenario), y=Shannon)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  theme_classic()+
  ggtitle("Abundant Community Shannon Diversity for low, mid and high limits")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  stat_compare_means()+
  xlab("Abundant Class Limits")
```

Is there a statistical different in the number of observed ASVs for upper, mid and lower limit defined rare communities as defined by polar abundance?
```{r}
#subset by abundance class
#scenario 1 = low limit abundance
#scenario 2 = mid limit abundance
rare_data_low <- total_data[total_data$Abundance_Class == "Rare" & total_data$Scenario == 1 & total_data$Area == "Pole",]
rare_data_mid <- total_data[total_data$Abundance_Class == "Rare" & total_data$Scenario == 2 & total_data$Area == "Pole",]
rare_data_high <- total_data[total_data$Abundance_Class == "Rare" & total_data$Scenario == 3 & total_data$Area == "Pole",]
#bind dataframes
rare_data_low_mid_high <- rbind(rare_data_low, rare_data_mid, rare_data_high)

#boxplot of abundance class with comapred means
ggplot(rare_data_low_mid_high[rare_data_low_mid_high$Domain == "16S",], aes(x=as.factor(Scenario), y=Observed)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  theme_classic()+
  ggtitle("Rare Community Observed Diversity for low, mid and high limits")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  stat_compare_means()+
  xlab("Rare Class Limits")

#boxplot of abundance class with comapred means
ggplot(rare_data_low_mid_high[rare_data_low_mid_high$Domain == "16S",], aes(x=as.factor(Scenario), y=Shannon)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  theme_classic()+
  ggtitle("Rare Community Shannon Diversity for low, mid and high limits")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  stat_compare_means()+
  xlab("Rare Class Limits")
```

Is there a statistical different in the number of observed ASVs for upper, mid and lower limit defined intermediate communities as defined by polar abundance?
```{r}
# #subset by abundance class
# int_data_1 <- total_data[total_data$Abundance_Class == "Intermediate" & total_data$Scenario == 1 & total_data$Area == "Pole",]
# int_data_2 <- total_data[total_data$Abundance_Class == "Intermediate" & total_data$Scenario == 2 & total_data$Area == "Pole",]
# int_data_3 <- total_data[total_data$Abundance_Class == "Intermediate" & total_data$Scenario == 3 & total_data$Area == "Pole",]
# int_data_4 <- total_data[total_data$Abundance_Class == "Intermediate" & total_data$Scenario == 4 & total_data$Area == "Pole",]
# int_data_5 <- total_data[total_data$Abundance_Class == "Intermediate" & total_data$Scenario == 5 & total_data$Area == "Pole",]
# int_data_6 <- total_data[total_data$Abundance_Class == "Intermediate" & total_data$Scenario == 6 & total_data$Area == "Pole",]
# int_data_7 <- total_data[total_data$Abundance_Class == "Intermediate" & total_data$Scenario == 7 & total_data$Area == "Pole",]
# int_data_8 <- total_data[total_data$Abundance_Class == "Intermediate" & total_data$Scenario == 8 & total_data$Area == "Pole",]
# int_data_9 <- total_data[total_data$Abundance_Class == "Intermediate" & total_data$Scenario == 9 & total_data$Area == "Pole",]
# #bind dataframes
# int_data_low_mid_high <- rbind(int_data_1, int_data_2, int_data_3, int_data_4, int_data_5, int_data_6, int_data_7, int_data_8, int_data_9)
# 
# #list of data to compare
# cmpr <- list(c("1","2"), c("1","3"), c("1","4"), c("1","5"), c("1","6"), c("1","7"), c("1","8"), c("1","9"), c("2","3"), c("2","4"), c("2","5"), c("2","6"), c("2","7"), c("2","8"), c("2","9"), c("3","4"), c("3","5"), c("3","6"), c("3","7"), c("3","8"), c("3","9"), c("4","5"), c("4","6"), c("4","7"), c("4","8"), c("4","9"), c("5","6"), c("5","7"), c("5","8"), c("5","9"), c("6","7"), c("6","8"), c("6","9"), c("7","8"), c("7","9"), c("8","9"))
# 
# #boxplot of abundance class with comapred means
# ggplot(int_data_low_mid_high[int_data_low_mid_high$Domain == "16S",], aes(x=as.factor(Scenario), y=Observed)) + 
#     geom_boxplot(outlier.colour="red", outlier.shape=8,
#                 outlier.size=4)+
#   theme_classic()+
#   ggtitle("Intermediate Community Observed Diversity for low, mid and high limits")+
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
#   xlab("Intermediate Class Limits")+
#   stat_compare_means(comparisons = cmpr, tip.length=0.01,
#          label = "p.signif", 
#          symnum.args = list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1), 
#          symbols = c("****", "***", "**", "*", "ns")))
# 
# #boxplot of abundance class with comapred means
# ggplot(int_data_low_mid_high[int_data_low_mid_high$Domain == "16S",], aes(x=as.factor(Scenario), y=Shannon)) + 
#     geom_boxplot(outlier.colour="red", outlier.shape=8,
#                 outlier.size=4)+
#   theme_classic()+
#   ggtitle("Intermediate Community Shannon Diversity for low, mid and high limits")+
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
#   stat_compare_means()+
#   xlab("Intermediate Class Limits")
```