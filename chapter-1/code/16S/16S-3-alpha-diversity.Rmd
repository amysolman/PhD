---
title: "Alpha Diversity"
author: "Amy Solman"
date: "24/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script explores the alpha diversity of this 16S data. I will answer the questions:
Are there significant differences in alpha diversity between the poles and between the glaciers?
How does this change for total, abundant, intermediate and rare communities?

Alpha diversity indices I will use are:
- Richness
- Shannon Index (Shannon's index accounts for both abundance and evenness of the species present) 

Step One: Clear workspace and load packages
```{r}
rm(list=ls())
graphics.off()

#library(dplyr) #for computing summary statistics
library(ggpubr) #for making my boxplots
library(FSA) #for dunn's test
#library(vegan) #for diversity indices
```

Step Two: Load data 
```{r}
#TOTAL DATASET
ps <- readRDS("../output/16S-phyloseq-object-rarefied.rds")

#Total Abundant
ps.abun <- readRDS("../output/16S-total-abundant.rds")
#Total Intermediate
ps.int <- readRDS("../output/16S-total-intermediate.rds")
#Total Rare
ps.rare <- readRDS("../output/16S-total-rare.rds")
```

Step Three: Remove any samples with zero counts from each of our communities
```{r}
#Total
ps.prune <- prune_samples(sample_sums(ps) > 0, ps)
#Abundant
abun.prune <- prune_samples(sample_sums(ps.abun) > 0, ps.abun)
#Intermediate
int.prune <- prune_samples(sample_sums(ps.int) > 0, ps.int)
#Rare
rare.prune <- prune_samples(sample_sums(ps.rare) > 0, ps.rare)
```

Step Four: Combine our data for plotting
```{r}
tot_rich <- estimate_richness(ps.prune)
tot_rich$SampleID <- as.character(data.frame(sample_data(ps.prune))$SampleID)
tot_rich$Glacier <- data.frame(sample_data(ps.prune))$Glacier
tot_rich$Pole <- data.frame(sample_data(ps.prune))$Pole
tot_rich$Abundance <- "Total"
abun_rich <- estimate_richness(abun.prune)
abun_rich$SampleID <- as.character(data.frame(sample_data(abun.prune))$SampleID)
abun_rich$Glacier <- data.frame(sample_data(abun.prune))$Glacier
abun_rich$Pole <- data.frame(sample_data(abun.prune))$Pole
abun_rich$Abundance <- "Abundant"
int_rich <- estimate_richness(int.prune)
int_rich$SampleID <- as.character(data.frame(sample_data(int.prune))$SampleID)
int_rich$Glacier <- data.frame(sample_data(int.prune))$Glacier
int_rich$Pole <- data.frame(sample_data(int.prune))$Pole
int_rich$Abundance <- "Intermediate"
rare_rich <- estimate_richness(rare.prune)
rare_rich$SampleID <- as.character(data.frame(sample_data(rare.prune))$SampleID)
rare_rich$Glacier <- data.frame(sample_data(rare.prune))$Glacier
rare_rich$Pole <- data.frame(sample_data(rare.prune))$Pole
rare_rich$Abundance <- "Rare"

data <- rbind(tot_rich, abun_rich, int_rich, rare_rich)
```

Step Five: Stacked barplots of the abundant, rare, intermediate species richness for each glacier
```{r}
#remove total data from dataframe
data_stack <- data[!(data$Abundance=="Total"), ]

# Stacked + percent
ggplot(data_stack, aes(fill=Abundance, y=Observed, x=SampleID)) + 
    geom_bar(position="fill", stat="identity")+
  ggtitle("Stacked Barplot of Abundance Richness Across All Samples")+
    theme(axis.text.x = element_text(angle=90, hjust=1))

# Stacked + percent
ggplot(data_stack, aes(fill=Abundance, y=Observed, x=Glacier)) + 
    geom_bar(position="fill", stat="identity")+
  ggtitle("Stacked Barplot of Abundance Richness Between Glaciers")+
  theme(axis.text.x = element_text(angle=90, hjust=1))

# Stacked + percent
ggplot(data_stack, aes(fill=Abundance, y=Observed, x=Pole)) + 
    geom_bar(position="fill", stat="identity")+
  ggtitle("Stacked Barplot of Abundance Richness Between Poles")

```

Step Six: Total Observed ASVs/Shannon Index by sample
```{r}
#subset data by abundance
data1 <- data[ which(data$Abundance=="Total"), ]

#Keeps our glaciers in the right order for barplots
data1 <- data1[order(data1$Glacier),]
# lock in factor level order
data1$SampleID <- factor(data1$SampleID, levels = data1$SampleID)

#barplot of species richness 
ggplot(data=data1, aes(x=SampleID, y=Observed, fill=Glacier)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Total Community Richness")+
  geom_bar(data=subset(data1, Observed==min(Observed)), aes(SampleID, Observed),
              color="black", stat="identity") +
  geom_bar(data=subset(data1, Observed==max(Observed)), aes(SampleID, Observed),
              color="black", stat="identity")+
  geom_text(aes(label=Observed), vjust=1.6, color="white", size=2)

#barplot of species richness 
ggplot(data=data1, aes(x=SampleID, y=Shannon, fill=Glacier)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Total Community Shannon Diversity")+
  geom_bar(data=subset(data1, Shannon==min(Shannon)), aes(SampleID, Shannon),
              color="black", stat="identity") +
  geom_bar(data=subset(data1, Shannon==max(Shannon)), aes(SampleID, Shannon),
              color="black", stat="identity")+
  geom_text(aes(label=round(Shannon, digits=2)), vjust=1.6, color="white", size=2)

```

Step Seven: Total Observed ASVs/Shannon Index by glacier
```{r}
#merge data to glacier level
ps.merged1 <- merge_samples(ps.prune, "Glacier")
tot_glacier <- estimate_richness(ps.merged1)
tot_glacier$Glacier <- row.names(tot_glacier)
tot_glacier$Pole <- c("Antarctic", "Antarctic", "Arctic", "Antarctic", "Antarctic", "Arctic", "Antarctic", "Antarctic", "Arctic", "Arctic","Antarctic", "Arctic", "Antarctic", "Antarctic", "Antarctic", "Antarctic")
tot_glacier <- tot_glacier[order(tot_glacier$Pole),]
tot_glacier$Glacier <- factor(tot_glacier$Glacier, levels = tot_glacier$Glacier)

#############################OBSERVED ASVS############################################
#plot total richness of each glacier
ggplot(data=tot_glacier, aes(x=Glacier, y=Observed, fill=Pole)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Total Community Richness by Glacier")+
          geom_bar(data=subset(tot_glacier, Observed==min(Observed)), aes(Glacier, Observed),
              color="black", stat="identity") +
  geom_bar(data=subset(tot_glacier, Observed==max(Observed)), aes(Glacier, Observed),
              color="black", stat="identity")+
  geom_text(aes(label=Observed), vjust=1.6, color="white", size=3)+
    geom_text(aes(label=Observed), vjust=1.6, color="white", size=3)

#Are there significant differences in species richness for each glacier?
#Test for significant differences between glacier asv richness
#ANOVA
res1a <- aov(Observed ~ Glacier, data = data1)
summary(res1a) #p value < 0.05 significant difference between glaciers
#use levene's test to check homogeny of variances
leveneTest(Observed ~ Glacier, data = data1) #p > 0.05 no evidence to suggest variance is significantly different
#extract residuals
anov_res1a <- residuals(object = res1a)
#Run shapiro-wilk test
shapiro.test(x=anov_res1a) #p > 0.05 which suggests the data are normally distributed
#ANOVA valid!
#Which glaciers are different?
pairwise.wilcox.test(data1$Observed, data1$Glacier,
                  p.adjust.method = "BH")
#no significant differences with adjusted p values

##############################SHANNON DIVERSITY################################

#barplot of shannon diversity richness 
ggplot(data=tot_glacier, aes(x=Glacier, y=Shannon, fill=Pole)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Total Community Shannon Diversity by Glacier")+
  geom_bar(data=subset(tot_glacier, Shannon==min(Shannon)), aes(Glacier, Shannon),
              color="black", stat="identity") +
  geom_bar(data=subset(tot_glacier, Shannon==max(Shannon)), aes(Glacier, Shannon),
              color="black", stat="identity")+
  geom_text(aes(label=round(Shannon, digits=2)), vjust=1.6, color="white", size=2)

#Set order of boxplot
newSTorder = c("Canada", "Commonwealth", "Diamond", 
               "Duboisbreen_Usteinen_Scoop", "Lower Koettlitz", "Lower Wright", "Miers",
               "Taylor", "Upper Koettlitz", "Upper Wright", "Usteinen Scoop", "Core", "Kangerlussuaq", "Margin", "Midre Lovenbreen", "Storglaci√§ren")

#Total by glacier
p = plot_richness(ps.prune, x="Glacier", color="Pole", measures=c("Observed", "Shannon")) + geom_boxplot()+
  ggtitle("Total Community Richness and Shannon Diversity Boxplots")

p$data$Glacier <- as.character(p$data$Glacier)
p$data$Glacier <- factor(p$data$Glacier, levels=newSTorder)
print(p)

#Are there significant differences in Shannon diversity for each glacier?
#Test for significant differences between glacier asv richness
#ANOVA
res1b <- aov(Shannon ~ Glacier, data = data1)
#Summary of analysis
summary(res1b) #p value < 0.05 significant difference between glaciers

#test validity of ANOVA
#use levene's test to check homogeny of variances
leveneTest(Shannon ~ Glacier, data = data1) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
anov_res1b <- residuals(object = res1b)

#Run shapiro-wilk test
shapiro.test(x=anov_res1b) #p > 0.05 which suggests the data are normally distributed

#ANOVA valid!

#Which glaciers are different?
pairwise.wilcox.test(data1$Shannon, data1$Glacier,
                  p.adjust.method = "BH")
#no significant differences with adjusted p values
```

Step Eight: Total Observed ASVs/Shannon Index by Pole
```{r}
#boxplot of observed species by pole
ggplot(data1, aes(x=Pole, y=Observed, fill=Pole)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  geom_jitter(shape=16, position=position_jitter(0.2))+
  theme_classic()+
  ggtitle("Total Community Observed ASVs by Pole")

#boxplot of shannon index species by pole
ggplot(data1, aes(x=Pole, y=Shannon, fill=Pole)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  geom_jitter(shape=16, position=position_jitter(0.2))+
  theme_classic()+
  ggtitle("Total Community Shannon Index by Pole")


#Total
#merge the phyloseq object by pole
ps.merged2 = merge_samples(ps.prune, "Pole")
tot_pole <- estimate_richness(ps.merged2)
tot_pole$Pole <- row.names(tot_pole)

#plot total richness of each pole
ggplot(data=tot_pole, aes(x=Pole, y=Observed, fill=Pole)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Total Community Richness by Pole")+
    geom_text(aes(label=Observed), vjust=1.6, color="white", size=5)

#differences in observed ASVs
#check normality of data
with(data1, shapiro.test(Observed[Pole == "Arctic"]))# p > 0.05 so normally distributed
with(data1, shapiro.test(Observed[Pole == "Antarctic"])) #p < 0.05 not normally distributed
#NEED NON-PARAMETRIC TEST
res <- wilcox.test(Observed ~ Pole, data = data1, exact = FALSE)
res # p < 0.05 the median Richness between poles are significantly different

#differences in shannon diversity
#check normality of data
with(data1, shapiro.test(Shannon[Pole == "Arctic"]))# p > 0.05 so normally distributed
with(data1, shapiro.test(Shannon[Pole == "Antarctic"])) #p > 0.05 normally distributed
var.test(Shannon ~ Pole, data = data1) #p > 0.05 variances not significantly different
#NEED PARAMETRIC TEST
t.test(Shannon ~ Pole, data = data1, var.equal = TRUE) #p < 0.05 significant difference
```

Step Nine: Abundant Observed ASVs/Shannon Index by Sample
```{r}
#subset data by abundance
data2 <- data[ which(data$Abundance=="Abundant"), ]

#Keeps our glaciers in the right order for barplots
data2 <- data2[order(data2$Glacier),]
# lock in factor level order
data2$SampleID <- factor(data2$SampleID, levels = data2$SampleID)

#barplot of species richness 
ggplot(data=data2, aes(x=SampleID, y=Observed, fill=Glacier)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Abundant Community Richness")+
  geom_bar(data=subset(data2, Observed==min(Observed)), aes(SampleID, Observed),
              color="black", stat="identity") +
  geom_bar(data=subset(data2, Observed==max(Observed)), aes(SampleID, Observed),
              color="black", stat="identity")+
  geom_text(aes(label=Observed), vjust=1.6, color="white", size=2)

#barplot of species richness 
ggplot(data=data2, aes(x=SampleID, y=Shannon, fill=Glacier)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Abundant Community Shannon Diversity")+
  geom_bar(data=subset(data2, Shannon==min(Shannon)), aes(SampleID, Shannon),
              color="black", stat="identity") +
  geom_bar(data=subset(data2, Shannon==max(Shannon)), aes(SampleID, Shannon),
              color="black", stat="identity")+
  geom_text(aes(label=round(Shannon, digits=2)), vjust=1.6, color="white", size=2)
```

Step Ten: Abundant Observed ASVs/Shannon Index by Glacier
```{r}
#merge data to glacier level
ps.merged2 <- merge_samples(abun.prune, "Glacier")
abun_glacier <- estimate_richness(ps.merged2)
abun_glacier$Glacier <- row.names(abun_glacier)
abun_glacier$Pole <- tot_glacier$Pole
abun_glacier <- abun_glacier[order(abun_glacier$Pole),]
abun_glacier$Glacier <- factor(abun_glacier$Glacier, levels = abun_glacier$Glacier)

#############################OBSERVED ASVS############################################
#plot total richness of each glacier
ggplot(data=abun_glacier, aes(x=Glacier, y=Observed, fill=Pole)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Abundant Community Richness by Glacier")+
          geom_bar(data=subset(abun_glacier, Observed==min(Observed)), aes(Glacier, Observed),
              color="black", stat="identity") +
  geom_bar(data=subset(abun_glacier, Observed==max(Observed)), aes(Glacier, Observed),
              color="black", stat="identity")+
  geom_text(aes(label=Observed), vjust=1.6, color="white", size=3)+
    geom_text(aes(label=Observed), vjust=1.6, color="white", size=3)

#Are there significant differences in species richness for each glacier?
#Test for significant differences between glacier asv richness
#ANOVA
res2a <- aov(Observed ~ Glacier, data = data2)
summary(res2a) #p value < 0.05 significant difference between glaciers
#use levene's test to check homogeny of variances
leveneTest(Observed ~ Glacier, data = data2) #p > 0.05 no evidence to suggest variance is significantly different
#extract residuals
anov_res2a <- residuals(object = res2a)
#Run shapiro-wilk test
shapiro.test(x=anov_res2a) #p > 0.05 which suggests the data are normally distributed
#ANOVA valid!
#Which glaciers are different?
pairwise.wilcox.test(data2$Observed, data2$Glacier,
                  p.adjust.method = "BH")
#Taylor and Upper Koettlitz sign dif

##############################SHANNON DIVERSITY################################

#barplot of shannon diversity richness 
ggplot(data=abun_glacier, aes(x=Glacier, y=Shannon, fill=Pole)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Abundant Community Shannon Diversity by Glacier")+
  geom_bar(data=subset(abun_glacier, Shannon==min(Shannon)), aes(Glacier, Shannon),
              color="black", stat="identity") +
  geom_bar(data=subset(abun_glacier, Shannon==max(Shannon)), aes(Glacier, Shannon),
              color="black", stat="identity")+
  geom_text(aes(label=round(Shannon, digits=2)), vjust=1.6, color="white", size=2)

#Total by glacier
p2 = plot_richness(abun.prune, x="Glacier", color="Pole", measures=c("Observed", "Shannon")) + geom_boxplot()+
  ggtitle("abundant Community Richness and Shannon Diversity Boxplots")

p2$data$Glacier <- as.character(p2$data$Glacier)
p2$data$Glacier <- factor(p2$data$Glacier, levels=newSTorder)
print(p2)

#Are there significant differences in Shannon diversity for each glacier?
#Test for significant differences between glacier asv richness
#ANOVA
res2b <- aov(Shannon ~ Glacier, data = data2)
#Summary of analysis
summary(res2b) #p value < 0.05 significant difference between glaciers

#test validity of ANOVA
#use levene's test to check homogeny of variances
leveneTest(Shannon ~ Glacier, data = data2) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
anov_res2b <- residuals(object = res2b)

#Run shapiro-wilk test
shapiro.test(x=anov_res2b) #p < 0.05 which suggests the data are not normally distributed

#ANOVA vinalid!

kruskal.test(Shannon ~ Glacier, data = data2) #p < 0.05 so the differences between the medians are statistically significant

dunnTest(Shannon ~ Glacier, data=data2, method="bh") #no signif with adjusted p values
```

Step Eleven: Abundant Observed ASVs/Shannon Index by Pole
```{r}
#boxplot of observed species by pole
ggplot(data2, aes(x=Pole, y=Observed, fill=Pole)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  geom_jitter(shape=16, position=position_jitter(0.2))+
  theme_classic()+
  ggtitle("Abundant Community Observed ASVs by Pole")

#boxplot of shannon index species by pole
ggplot(data2, aes(x=Pole, y=Shannon, fill=Pole)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  geom_jitter(shape=16, position=position_jitter(0.2))+
  theme_classic()+
  ggtitle("Abundant Community Shannon Index by Pole")


#Total
#merge the phyloseq object by pole
ps.merged3 = merge_samples(abun.prune, "Pole")
abun_pole <- estimate_richness(ps.merged3)
abun_pole$Pole <- row.names(abun_pole)

#plot total richness of each pole
ggplot(data=abun_pole, aes(x=Pole, y=Observed, fill=Pole)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Abundant Community Richness by Pole")+
    geom_text(aes(label=Observed), vjust=1.6, color="white", size=5)

#differences in observed ASVs
#check normality of data
with(data2, shapiro.test(Observed[Pole == "Arctic"]))# p > 0.05 so normally distributed
with(data2, shapiro.test(Observed[Pole == "Antarctic"])) #p < 0.05 not normally distributed
#NEED NON-PARAMETRIC TEST
res <- wilcox.test(Observed ~ Pole, data = data2, exact = FALSE)
res # p < 0.05 the median Richness between poles are significantly different

#differences in shannon diversity
#check normality of data
with(data2, shapiro.test(Shannon[Pole == "Arctic"]))# p < 0.05 not normally distributed
with(data2, shapiro.test(Shannon[Pole == "Antarctic"])) #p < 0.05 not normally distributed
var.test(Shannon ~ Pole, data = data2) #p > 0.05 variances not significantly different
#NEED NONPARAMETRIC TEST
wilcox.test(Shannon ~ Pole, data = data2, exact = FALSE)# p > 0.05 the median Shannon Index between poles not signif dif
```

Step Twelve: Intermediate Observed ASVs/Shannon Index by Sample
```{r}
#subset data by abundance
data3 <- data[ which(data$Abundance=="Intermediate"), ]

#Keeps our glaciers in the right order for barplots
data3 <- data3[order(data3$Glacier),]
# lock in factor level order
data3$SampleID <- factor(data3$SampleID, levels = data3$SampleID)

#barplot of species richness 
ggplot(data=data3, aes(x=SampleID, y=Observed, fill=Glacier)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Intermediate Community Richness")+
  geom_bar(data=subset(data3, Observed==min(Observed)), aes(SampleID, Observed),
              color="black", stat="identity") +
  geom_bar(data=subset(data3, Observed==max(Observed)), aes(SampleID, Observed),
              color="black", stat="identity")+
  geom_text(aes(label=Observed), vjust=1.6, color="white", size=2)

#barplot of species richness 
ggplot(data=data3, aes(x=SampleID, y=Shannon, fill=Glacier)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Intermediate Community Shannon Diversity")+
  geom_bar(data=subset(data3, Shannon==min(Shannon)), aes(SampleID, Shannon),
              color="black", stat="identity") +
  geom_bar(data=subset(data3, Shannon==max(Shannon)), aes(SampleID, Shannon),
              color="black", stat="identity")+
  geom_text(aes(label=round(Shannon, digits=2)), vjust=1.6, color="white", size=2)
```

Step Thirteen: Intermediate Observed ASVs/Shannon Index by Glacier
```{r}
#merge data to glacier level
ps.merged4 <- merge_samples(int.prune, "Glacier")
int_glacier <- estimate_richness(ps.merged4)
int_glacier$Glacier <- row.names(int_glacier)
int_glacier$Pole <- tot_glacier$Pole
int_glacier <- int_glacier[order(int_glacier$Pole),]
int_glacier$Glacier <- factor(int_glacier$Glacier, levels = int_glacier$Glacier)

#############################OBSERVED ASVS############################################
#plot total richness of each glacier
ggplot(data=int_glacier, aes(x=Glacier, y=Observed, fill=Pole)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Intermediate Community Richness by Glacier")+
          geom_bar(data=subset(int_glacier, Observed==min(Observed)), aes(Glacier, Observed),
              color="black", stat="identity") +
  geom_bar(data=subset(int_glacier, Observed==max(Observed)), aes(Glacier, Observed),
              color="black", stat="identity")+
  geom_text(aes(label=Observed), vjust=1.6, color="white", size=3)+
    geom_text(aes(label=Observed), vjust=1.6, color="white", size=3)

#Are there significant differences in species richness for each glacier?
#Test for significant differences between glacier asv richness
#ANOVA
res3a <- aov(Observed ~ Glacier, data = data3)
summary(res3a) #p value < 0.05 significant difference between glaciers
leveneTest(Observed ~ Glacier, data = data3) #p > 0.05 no evidence to suggest variance is significantly different
anov_res3a <- residuals(object = res3a)
#Run shapiro-wilk test
shapiro.test(x=anov_res3a) #p > 0.05 which suggests the data are normally distributed
#ANOVA valid!
#Which glaciers are different?
pairwise.wilcox.test(data3$Observed, data3$Glacier, p.adjust.method = "BH")
#Taylor and Upper Koettlitz sign dif
#Taylor and Upper Wright signif dif
#Taylor and Lower Koettlitzsignif dif

##############################SHANNON DIVERSITY################################

#barplot of shannon diversity richness 
ggplot(data=int_glacier, aes(x=Glacier, y=Shannon, fill=Pole)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Intermediate Community Shannon Diversity by Glacier")+
  geom_bar(data=subset(int_glacier, Shannon==min(Shannon)), aes(Glacier, Shannon),
              color="black", stat="identity") +
  geom_bar(data=subset(int_glacier, Shannon==max(Shannon)), aes(Glacier, Shannon),
              color="black", stat="identity")+
  geom_text(aes(label=round(Shannon, digits=2)), vjust=1.6, color="white", size=2)

#Total by glacier
p3 = plot_richness(int.prune, x="Glacier", color="Pole", measures=c("Observed", "Shannon")) + geom_boxplot()+
  ggtitle("Intermediate Community Richness and Shannon Diversity Boxplots")

p3$data$Glacier <- as.character(p3$data$Glacier)
p3$data$Glacier <- factor(p3$data$Glacier, levels=newSTorder)
print(p3)

#Are there significant differences in Shannon diversity for each glacier?
#Test for significant differences between glacier asv richness
#ANOVA
res3b <- aov(Shannon ~ Glacier, data = data3)
#Summary of analysis
summary(res3b) #p value < 0.05 significant difference between glaciers

#test validity of ANOVA
#use levene's test to check homogeny of variances
leveneTest(Shannon ~ Glacier, data = data3) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
anov_res3b <- residuals(object = res3b)

#Run shapiro-wilk test
shapiro.test(x=anov_res3b) #p < 0.05 which suggests the data are not normally distributed

#ANOVA invalid!

kruskal.test(Shannon ~ Glacier, data = data3) #p < 0.05 so the differences between the medians are statistically significant

dunnTest(Shannon ~ Glacier, data=data3, method="bh")
#Commonwealth - Storglaci√§ren
#Core - Taylor
#Lower Koettlitz - Taylor
#Lower Wright - Taylor
#Midre Lovenbreen - Taylor
#Storglaci√§ren - Taylor
#Taylor - Upper Koettlitz
#Taylor - Upper Wright
```

Step Fourteen: Intermediate Observed ASVs/Shannon Index by Pole
```{r}
#boxplot of observed species by pole
ggplot(data3, aes(x=Pole, y=Observed, fill=Pole)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  geom_jitter(shape=16, position=position_jitter(0.2))+
  theme_classic()+
  ggtitle("Intermediate Community Observed ASVs by Pole")

#boxplot of shannon index species by pole
ggplot(data3, aes(x=Pole, y=Shannon, fill=Pole)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  geom_jitter(shape=16, position=position_jitter(0.2))+
  theme_classic()+
  ggtitle("Intermediate Community Shannon Index by Pole")


#Total
#merge the phyloseq object by pole
ps.merged5 = merge_samples(int.prune, "Pole")
int_pole <- estimate_richness(ps.merged5)
int_pole$Pole <- row.names(int_pole)

#plot total richness of each pole
ggplot(data=int_pole, aes(x=Pole, y=Observed, fill=Pole)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Intermediate Community Richness by Pole")+
    geom_text(aes(label=Observed), vjust=1.6, color="white", size=5)

#differences in observed ASVs
#check normality of data
with(data3, shapiro.test(Observed[Pole == "Arctic"]))# p < 0.05 so not normally distributed
with(data3, shapiro.test(Observed[Pole == "Antarctic"])) #p < 0.05 not normally distributed
#NEED NON-PARAMETRIC TEST
wilcox.test(Observed ~ Pole, data = data3, exact = FALSE) # p < 0.05 the median between poles are significantly different

#differences in shannon diversity
#check normality of data
with(data3, shapiro.test(Shannon[Pole == "Arctic"]))# p > 0.05 normally distributed
with(data3, shapiro.test(Shannon[Pole == "Antarctic"])) #p < 0.05 not normally distributed
var.test(Shannon ~ Pole, data = data3) #p > 0.05 variances not significantly different
#NEED NONPARAMETRIC TEST
wilcox.test(Shannon ~ Pole, data = data3, exact = FALSE)# p < 0.05 the median Shannon Index between poles signif dif
```

Step Fifteen: Rare Observed ASVs/Shannon Index by Sample
```{r}
#subset data by abundance
data4 <- data[ which(data$Abundance=="Rare"), ]

#Keeps our glaciers in the right order for barplots
data4 <- data4[order(data4$Glacier),]
# lock in factor level order
data4$SampleID <- factor(data4$SampleID, levels = data4$SampleID)

#barplot of species richness 
ggplot(data=data4, aes(x=SampleID, y=Observed, fill=Glacier)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Rare Community Richness")+
  geom_bar(data=subset(data4, Observed==min(Observed)), aes(SampleID, Observed),
              color="black", stat="identity") +
  geom_bar(data=subset(data4, Observed==max(Observed)), aes(SampleID, Observed),
              color="black", stat="identity")+
  geom_text(aes(label=Observed), vjust=1.6, color="white", size=2)

#barplot of species richness 
ggplot(data=data4, aes(x=SampleID, y=Shannon, fill=Glacier)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Rare Community Shannon Diversity")+
  geom_bar(data=subset(data4, Shannon==min(Shannon)), aes(SampleID, Shannon),
              color="black", stat="identity") +
  geom_bar(data=subset(data4, Shannon==max(Shannon)), aes(SampleID, Shannon),
              color="black", stat="identity")+
  geom_text(aes(label=round(Shannon, digits=2)), vjust=1.6, color="white", size=2)
```

Step Sixteen: Rare Observed ASVs/Shannon Index by Glacier
```{r}
#merge data to glacier level
ps.merged6 <- merge_samples(rare.prune, "Glacier")
rare_glacier <- estimate_richness(ps.merged6)
rare_glacier$Glacier <- row.names(rare_glacier)
rare_glacier$Pole <- tot_glacier$Pole
rare_glacier <- rare_glacier[order(rare_glacier$Pole),]
rare_glacier$Glacier <- factor(rare_glacier$Glacier, levels = rare_glacier$Glacier)

#############################OBSERVED ASVS############################################
#plot total richness of each glacier
ggplot(data=rare_glacier, aes(x=Glacier, y=Observed, fill=Pole)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Rare Community Richness by Glacier")+
          geom_bar(data=subset(rare_glacier, Observed==min(Observed)), aes(Glacier, Observed),
              color="black", stat="identity") +
  geom_bar(data=subset(rare_glacier, Observed==max(Observed)), aes(Glacier, Observed),
              color="black", stat="identity")+
  geom_text(aes(label=Observed), vjust=1.6, color="white", size=3)+
    geom_text(aes(label=Observed), vjust=1.6, color="white", size=3)

#Are there significant differences in species richness for each glacier?
#Test for significant differences between glacier asv richness
#ANOVA
res4a <- aov(Observed ~ Glacier, data = data4)
summary(res4a) #p value < 0.05 significant difference between glaciers
leveneTest(Observed ~ Glacier, data = data3) #p > 0.05 no evidence to suggest variance is significantly different
anov_res4a <- residuals(object = res4a)
#Run shapiro-wilk test
shapiro.test(x=anov_res4a) #p < 0.05 which suggests the data are not normally distributed
#ANOVA valid!
#Which glaciers are different?
kruskal.test(Observed ~ Glacier, data = data4) #p < 0.05 so the differences between the medians are statistically significant
dunnTest(Observed ~ Glacier, data=data4, method="bh") #no signficiant differences between glaciers

##############################SHANNON DIVERSITY################################

#barplot of shannon diversity richness 
ggplot(data=rare_glacier, aes(x=Glacier, y=Shannon, fill=Pole)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Rare Community Shannon Diversity by Glacier")+
  geom_bar(data=subset(rare_glacier, Shannon==min(Shannon)), aes(Glacier, Shannon),
              color="black", stat="identity") +
  geom_bar(data=subset(rare_glacier, Shannon==max(Shannon)), aes(Glacier, Shannon),
              color="black", stat="identity")+
  geom_text(aes(label=round(Shannon, digits=2)), vjust=1.6, color="white", size=2)

#Total by glacier
p4 = plot_richness(rare.prune, x="Glacier", color="Pole", measures=c("Observed", "Shannon")) + geom_boxplot()+
  ggtitle("Rare Community Richness and Shannon Diversity Boxplots")

p4$data$Glacier <- as.character(p4$data$Glacier)
p4$data$Glacier <- factor(p4$data$Glacier, levels=newSTorder)
print(p4)

#Are there significant differences in Shannon diversity for each glacier?
#Test for significant differences between glacier asv richness
#ANOVA
res4b <- aov(Shannon ~ Glacier, data = data4)
#Summary of analysis
summary(res4b) #p value < 0.05 significant difference between glaciers

#test validity of ANOVA
#use levene's test to check homogeny of variances
leveneTest(Shannon ~ Glacier, data = data4) #p > 0.05 so no evidence to suggest variance across groups is significantly different so data meets this assumption

#We can check normality by performing a shapiro-wilk test on the ANOVA residuals
#extract residuals
anov_res4b <- residuals(object = res4b)

#Run shapiro-wilk test
shapiro.test(x=anov_res4b) #p > 0.05 which suggests the data are normally distributed

#ANOVA valid!
pairwise.wilcox.test(data4$Shannon, data4$Glacier, p.adjust.method = "BH") #no significant differences with adjusted p
```

Step Seventeen: Rare Observed ASVs/Shannon Index by Pole
```{r}
#boxplot of observed species by pole
ggplot(data4, aes(x=Pole, y=Observed, fill=Pole)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  geom_jitter(shape=16, position=position_jitter(0.2))+
  theme_classic()+
  ggtitle("Rare Community Observed ASVs by Pole")

#boxplot of shannon index species by pole
ggplot(data4, aes(x=Pole, y=Shannon, fill=Pole)) + 
    geom_boxplot(outlier.colour="red", outlier.shape=8,
                outlier.size=4)+
  geom_jitter(shape=16, position=position_jitter(0.2))+
  theme_classic()+
  ggtitle("Rare Community Shannon Index by Pole")


#Total
#merge the phyloseq object by pole
ps.merged7 = merge_samples(rare.prune, "Pole")
rare_pole <- estimate_richness(ps.merged7)
rare_pole$Pole <- row.names(rare_pole)

#plot total richness of each pole
ggplot(data=rare_pole, aes(x=Pole, y=Observed, fill=Pole)) +
  geom_bar(stat="identity")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle=90, hjust=1))+
  ggtitle("Rare Community Richness by Pole")+
    geom_text(aes(label=Observed), vjust=1.6, color="white", size=5)

#differences in observed ASVs
#check normality of data
with(data4, shapiro.test(Observed[Pole == "Arctic"]))# p < 0.05 so not normally distributed
with(data4, shapiro.test(Observed[Pole == "Antarctic"])) #p < 0.05 not normally distributed
#NEED NON-PARAMETRIC TEST
wilcox.test(Observed ~ Pole, data = data4, exact = FALSE) # p < 0.05 the median between poles are significantly different

#differences in shannon diversity
#check normality of data
with(data4, shapiro.test(Shannon[Pole == "Arctic"]))# p < 0.05 not normally distributed
with(data4, shapiro.test(Shannon[Pole == "Antarctic"])) #p < 0.05 not normally distributed
var.test(Shannon ~ Pole, data = data4) #p > 0.05 variances not significantly different
#NEED NONPARAMETRIC TEST
wilcox.test(Shannon ~ Pole, data = data4, exact = FALSE)# p > 0.05 the median Shannon Index between poles not signif dif
```