---
title: "18S-3-rare-abundant"
author: "Amy Solman"
date: "05/08/2021"
output: html_document
---
In this script I'm going to divide my cryoconite data into subcommunities based on their regional abundance.
Following Liu et al. (2015), Li et al., (2021)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Step One: Clear workspace and load packages
```{r}
rm(list=ls())
graphics.off()

library(phyloseq)
library(dplyr) 
library(plyr)
```

#Step Two: Load data 
```{r}
#Load data files
#load("../output/16S-my-sequence-data.RData") #load all our pre-processed data files

#load phyloseq object
ps <- readRDS("../output/16S-phyloseq-object.rds") #load unrarefied phyloseq object
ps.rar <- readRDS("../output/16S-phyloseq-object-rarefied.rds") #load rarefied phyloseq object
```

#Step Three: Find the local relative abundance of each ASV in each sample
```{r}
#check out rarefied object has the same number of reads per sample
sample_sums(ps.rar)

#transform to relative abundance data
ps.rel  = transform_sample_counts(ps.rar, function(x) x / sum(x) )

#sample sums should all now = 1
sample_sums(ps.rel)
ps.rel
```

#Step Four: Subset data by pole and remove ASVs with 0 relative abundance
```{r}
#subset data by pole
ps.rel.arc <- subset_samples(ps.rel, Pole == "Arctic")
ps.rel.ant <- subset_samples(ps.rel, Pole == "Antarctic")

#remove ASVs with 0 relative abundance
ps.rel.arc.filter <- filter_taxa(ps.rel.arc, function(x) sum(x) > 0, TRUE)
ps.rel.ant.filter <- filter_taxa(ps.rel.ant, function(x) sum(x) > 0, TRUE)

ps.rel.arc.filter
ps.rel.ant.filter
```

#Step Five: Filter taxa by abundance (1 = 100%, 0.1 = 10%, 0.01 = 1%, 0.001 = 0.1%, 0.0001 = 0.01%, 0.00001 = 0.001%)
```{r}
#RARE ARCTIC: only keep taxa with mean local relative abundance less than 0.001%
ps.rel.arc.filter.rare <- filter_taxa(ps.rel.arc.filter, function(x) mean(x) < 0.00001, TRUE)
#RARE ANTARCTIC
ps.rel.ant.filter.rare <- filter_taxa(ps.rel.ant.filter, function(x) mean(x) < 0.00001, TRUE)

#ABUNDANT ARCTIC: only keep taxa with mean local relative abundance more than 0.1%
ps.rel.arc.filter.abun <- filter_taxa(ps.rel.arc.filter, function(x) mean(x) > 0.001, TRUE)
#ABUNDANT ANTARCTIC
ps.rel.ant.filter.abun <- filter_taxa(ps.rel.ant.filter, function(x) mean(x) > 0.001, TRUE)

#INTERMEDIATE ARCTIC: only keep taxa with mean local relative abundance more than 0.001% and less than 0.1%
ps.rel.arc.filter.int <- filter_taxa(ps.rel.arc.filter, function(x) mean(x) > 0.00001 & mean(x) < 0.001, TRUE)
#INTERMEDIATE ANTARCTIC
ps.rel.ant.filter.int <- filter_taxa(ps.rel.ant.filter, function(x) mean(x) > 0.00001 & mean(x) < 0.001, TRUE)

```

Merge by abundance
```{r}
combine_phyloseq <- function(phylo1, phylo2, phylo3){
  #get our arctic abundance count table
abun_count1 <- data.frame(otu_table(phylo1), check.names = FALSE)
names(abun_count1) <- sample_data(phylo1)$SampleID
abun_count1$ASV <- row.names(abun_count1)
#get our antarctic abundance count table
abun_count2 <- data.frame(otu_table(phylo2), check.names = FALSE)
names(abun_count2) <- sample_data(phylo2)$SampleID
abun_count2$ASV <- row.names(abun_count2)
x <- dplyr::bind_rows(abun_count1, abun_count2)
x[is.na(x)] <- 0
#aggregate rows by ASV ID
y <- ddply(x,"ASV",numcolwise(sum))
row.names(y) <- y$ASV
y <- subset(y, select=-c(ASV))

my_subset <- subset(otu_table(phylo3), rownames(otu_table(phylo3)) %in% row.names(y))
new_physeq <- merge_phyloseq(my_subset, tax_table(phylo3), sample_data(phylo3), phy_tree(phylo3))
return(new_physeq)
}

#Abundant
arc.subset.abun <- subset(otu_table(ps.rel.arc), rownames(otu_table(ps.rel.arc)) %in% rownames(otu_table(ps.rel.arc.filter.abun)))
ps.ps.rel.arc.filter.abun <- merge_phyloseq(arc.subset.abun, tax_table(ps.rel.arc), sample_data(ps.rel.arc), phy_tree(ps.rel.arc))
ant.subset.abun <- subset(otu_table(ps.rel.ant), rownames(otu_table(ps.rel.ant)) %in% rownames(otu_table(ps.rel.ant.filter.abun)))
ps.ps.rel.ant.filter.abun <- merge_phyloseq(ant.subset.abun, tax_table(ps.rel.ant), sample_data(ps.rel.ant), phy_tree(ps.rel.ant))
ps.abun <- combine_phyloseq(ps.ps.rel.arc.filter.abun, ps.ps.rel.ant.filter.abun, ps)

#Intermediate
arc.subset.int <- subset(otu_table(ps.rel.arc), rownames(otu_table(ps.rel.arc)) %in% rownames(otu_table(ps.rel.arc.filter.int)))
ps.ps.rel.arc.filter.int <- merge_phyloseq(arc.subset.int, tax_table(ps.rel.arc), sample_data(ps.rel.arc), phy_tree(ps.rel.arc))
ant.subset.int <- subset(otu_table(ps.rel.ant), rownames(otu_table(ps.rel.ant)) %in% rownames(otu_table(ps.rel.ant.filter.int)))
ps.ps.rel.ant.filter.int <- merge_phyloseq(ant.subset.int, tax_table(ps.rel.ant), sample_data(ps.rel.ant), phy_tree(ps.rel.ant))
ps.int <- combine_phyloseq(ps.ps.rel.arc.filter.int, ps.ps.rel.ant.filter.int, ps)

#Rare
arc.subset.rare <- subset(otu_table(ps.rel.arc), rownames(otu_table(ps.rel.arc)) %in% rownames(otu_table(ps.rel.arc.filter.rare)))
ps.ps.rel.arc.filter.rare <- merge_phyloseq(arc.subset.rare, tax_table(ps.rel.arc), sample_data(ps.rel.arc), phy_tree(ps.rel.arc))
ant.subset.rare <- subset(otu_table(ps.rel.ant), rownames(otu_table(ps.rel.ant)) %in% rownames(otu_table(ps.rel.ant.filter.rare)))
ps.ps.rel.ant.filter.rare <- merge_phyloseq(ant.subset.rare, tax_table(ps.rel.ant), sample_data(ps.rel.ant), phy_tree(ps.rel.ant))
ps.rare <- combine_phyloseq(ps.ps.rel.arc.filter.rare, ps.ps.rel.ant.filter.rare, ps)
```

Remove any samples with zero counts from each of our communities
```{r}
#Total
ps.rar <- prune_samples(sample_sums(ps.rar) > 0, ps.rar)
#Abundant
ps.abun <- prune_samples(sample_sums(ps.abun) > 0, ps.abun)
#Intermediate
ps.int <- prune_samples(sample_sums(ps.int) > 0, ps.int)
#Rare
ps.rare <- prune_samples(sample_sums(ps.rare) > 0, ps.rare)
```

#Step Six: Export phyloseq objects
```{r}
saveRDS(ps.rar, "../output/16S-phyloseq-object-rarefied.rds")
#Now I'm going to export my phyloseq objects
#Total rare
saveRDS(ps.rare, "../output/16S-total-rare.rds")
#Total Abundant
saveRDS(ps.abun, "../output/16S-total-abundant.rds")
#Total Intermediate 
saveRDS(ps.int, "../output/16S-total-intermediate.rds")

# #ARCTIC RARE
# saveRDS(ps.rel.arc.filter.rare, "../output/16S-arctic-rare.rds")
# #ARCTIC ABUNDANT
# saveRDS(ps.rel.arc.filter.abun, "../output/16S-arctic-abundant.rds")
# #ARCTIC INTERMEDIATE
# saveRDS(ps.rel.arc.filter.int, "../output/16S-arctic-intermediate.rds")
# 
# #ANTARCTIC RARE
# saveRDS(ps.rel.ant.filter.rare, "../output/16S-antarctic-rare.rds")
# #ANTARCTIC ABUNDANT
# saveRDS(ps.rel.ant.filter.abun, "../output/16S-antarctic-abundant.rds")
# #ANTARCTIC INTERMEDIATE
# saveRDS(ps.rel.ant.filter.int, "../output/16S-antarctic-intermediate.rds")
```