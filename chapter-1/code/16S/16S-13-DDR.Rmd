---
title: "Distance-Decay Analysis"
author: "Amy Solman"
date: "08/10/2021"
output: html_document
---
This script will look at the correlation between geographic distance and community dissimilarity.

I will achieve this by:
1) Calculating community dissimilarities
2) Calculating community distances (using lat and long coords)
3) Mantel tests for correlation between the matrices
4) Carry out linear regression of distances and dissimilarities
5) Plot the linear regressions

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear workspace and load packages
```{r}
rm(list=ls())
graphics.off()

# library(ggpubr) #for making my boxplots
# library(FSA) #for dunn's test
# library(vegan) #for diversity indices
# library(ggplot2) #for making plots
# library(dplyr) #for manipulating data where you see %>% and computing summary stats
# install.packages("dendextend")
# library(dendextend) #for hierchical clustering
# install.packages("indicspecies")
# library(indicspecies) #for indicator species analysis
library(stringr) #for removing characters from string
library(fossil) #for creating distance matrix
# # install.packages("betapart")
# library(betapart) #for didtance decay analysis
 library(ade4) #mantel tests
```

Load Data
```{r}
#TOTAL DATASET
ps <- readRDS("../output/16S-phyloseq-object-rarefied.rds")

#Total Abundant
ps.abun <- readRDS("../output/16S-total-abundant.rds")
#Total Intermediate
ps.int <- readRDS("../output/16S-total-intermediate.rds")
#Total Rare
ps.rare <- readRDS("../output/16S-total-rare.rds")
```

1 TOTAL TAXA

1.1 Calculate community dissimilarities
```{r}
DistWU <- distance(ps, method="wUniFrac")
DistUU <- distance(ps, method="UniFrac")
DistBray <- distance(ps, method="bray")
DistCan <- distance(ps, method="canberra")
```

1.2 Calculate community distances
```{r}
#get metadata
meta <- data.frame(sample_data(ps))

#put a negative sign in front of all the south latitude coords
for (i in 1:nrow(meta)){
  if (meta$Pole[i] == "Antarctic"){
    meta$Glacier_Latitude[i] <- c(paste0("-", meta$Glacier_Latitude[i]))
    meta$Cryoconite_Latitude[i] <- c(paste0("-", meta$Cryoconite_Latitude[i]))
  }
}

#Some of our cryoconite holes don't have specific coords so we'll use the glacier coordinates
#remove letters from glacier coord strings
meta$Glacier_Latitude <- as.numeric(str_sub(meta$Glacier_Latitude,1,nchar(meta$Glacier_Latitude)-1))
meta$Glacier_Longitude <- as.numeric(str_sub(meta$Glacier_Longitude,1,nchar(meta$Glacier_Longitude)-1))

glac_lat <- meta$Glacier_Latitude
glac_long <- meta$Glacier_Longitude

#get latitude of each sample
cryo_lat <- as.numeric(meta$Cryoconite_Latitude)
#get longitude of each sample
cryo_long <- as.numeric(meta$Cryoconite_Longitude)

#replace any missing cryoconite coords with those of it's glacier
for (j in 1:length(cryo_lat)){
  if (is.na(cryo_lat[j])){
    cryo_lat[j] <- glac_lat[j]
    cryo_long[j] <- glac_long[j]
  }
}

#put into matrix
long.lat <- as.matrix(cbind(cryo_long, cryo_lat))

geo.dist <- earth.dist(long.lat, dist=TRUE) #a matrix of distances in kilometers between a list of longitudes and latitudes
```

1.3 Mantel tests for correlation between geographic distance and community dissimilarity
```{r}
#Weighted UniFrac Distances
mantel.rtest(geo.dist, DistWU, nrepet = 9999) #p < 0.05 so there is significant correlation between distance and community dissimilarity

#Unweighted UniFrac Distances
mantel.rtest(geo.dist, DistUU, nrepet = 9999) #p < 0.05 so there is a significant positive correlation between distance and community dissimilarity

#Bray-Curtis Distances
mantel.rtest(geo.dist, DistBray, nrepet = 9999) #p < 0.05 so there is significant correlation between distance and community dissimilarity

#Canberra Distances
mantel.rtest(geo.dist, DistCan, nrepet = 9999) #p < 0.05 so there is significant correlation between distance and community dissimilarity
```

1.4 Linear regression of community and distances
```{r}
DDR.wuni <- lm(DistWU ~ geo.dist)
summary(DDR.wuni) #p < 0.05 

DDR.uni <- lm(DistUU ~ geo.dist)
summary(DDR.uni) #p < 0.05

DDR.bray <- lm(DistBray ~ geo.dist)
summary(DDR.bray) #p < 0.05

DDR.can <- lm(DistCan ~ geo.dist)
summary(DDR.can) #p < 0.05
```

1.5 Plot significant linear regression
```{r}
#Weighted Unifrac
plot(geo.dist, DistWU, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Weighted Unifrac") #Plot the results
abline(DDR.wuni) #Add a regression line
title(main="Total Taxa: DDR by Weighted Unifrac Distances") 

#Unweighted Unifrac
plot(geo.dist, DistUU, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Unweighted Unifrac") #Plot the results
abline(DDR.uni) #Add a regression line
title(main="Total Taxa: DDR by Unweighted Unifrac Distances")

#Bray-Curtis
plot(geo.dist, DistBray, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Bray-Curtis Distances") #Plot the results
abline(DDR.bray) #Add a regression line
title(main="Total Taxa: DDR by Bray-Curtis Distances")

#Canberra Distances
plot(geo.dist, DistCan, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Canberra") #Plot the results
abline(DDR.can) #Add a regression line
title(main="Total Taxa: DDR by Canberra Distances")
```

2 ABUNDANT TAXA

2.1 Calculate community dissimilarities
```{r}
DistWU.ab <- distance(ps.abun, method="wUniFrac")
DistUU.ab <- distance(ps.abun, method="UniFrac")
DistBray.ab <- distance(ps.abun, method="bray")
DistCan.ab <- distance(ps.abun, method="canberra")
```

2.2 Calculate community distances
```{r}
#get metadata
meta.ab <- data.frame(sample_data(ps.abun))

#put a negative sign in front of all the south latitude coords
for (i in 1:nrow(meta.ab)){
  if (meta.ab$Pole[i] == "Antarctic"){
    meta.ab$Glacier_Latitude[i] <- c(paste0("-", meta.ab$Glacier_Latitude[i]))
    meta.ab$Cryoconite_Latitude[i] <- c(paste0("-", meta.ab$Cryoconite_Latitude[i]))
  }
}

#Some of our cryoconite holes don't have specific coords so we'll use the glacier coordinates
#remove letters from glacier coord strings
meta.ab$Glacier_Latitude <- as.numeric(str_sub(meta.ab$Glacier_Latitude,1,nchar(meta.ab$Glacier_Latitude)-1))
meta.ab$Glacier_Longitude <- as.numeric(str_sub(meta.ab$Glacier_Longitude,1,nchar(meta.ab$Glacier_Longitude)-1))

glac_lat.ab <- meta.ab$Glacier_Latitude
glac_long.ab <- meta.ab$Glacier_Longitude

#get latitude of each sample
cryo_lat.ab <- as.numeric(meta.ab$Cryoconite_Latitude)
#get longitude of each sample
cryo_long.ab <- as.numeric(meta.ab$Cryoconite_Longitude)

#replace any missing cryoconite coords with those of it's glacier
for (j in 1:length(cryo_lat.ab)){
  if (is.na(cryo_lat.ab[j])){
    cryo_lat.ab[j] <- glac_lat.ab[j]
    cryo_long.ab[j] <- glac_long.ab[j]
  }
}

#put into matrix
long.lat.ab <- as.matrix(cbind(cryo_long.ab, cryo_lat.ab))

geo.dist.ab <- earth.dist(long.lat.ab, dist=TRUE) #a matrix of distances in kilometers between a list of longitudes and latitudes
```

2.3 Mantel tests for correlation between geographic distance and community dissimilarity
```{r}
#Weighted UniFrac Distances
mantel.rtest(geo.dist.ab, DistWU.ab, nrepet = 9999) #p > 0.05 so there is no significant correlation between distance and community dissimilarity

#Unweighted UniFrac Distances
mantel.rtest(geo.dist.ab, DistUU.ab, nrepet = 9999) #p < 0.05 so there is a significant positive correlation between distance and community dissimilarity

#Bray-Curtis Distances
mantel.rtest(geo.dist.ab, DistBray.ab, nrepet = 9999) #p < 0.05 so there issignificant correlation between distance and community dissimilarity

#Canberra Distances
mantel.rtest(geo.dist.ab, DistCan.ab, nrepet = 9999) #p < 0.05 so there is significant correlation between distance and community dissimilarity
```

2.4 Linear regression of community and distances
```{r}
DDR.wuni.ab <- lm(DistWU.ab ~ geo.dist.ab)
summary(DDR.wuni.ab) #p < 0.05

DDR.uni.ab <- lm(DistUU.ab ~ geo.dist.ab)
summary(DDR.uni.ab) #p < 0.05

DDR.bray.ab <- lm(DistBray.ab ~ geo.dist.ab)
summary(DDR.bray.ab) #p < 0.05

DDR.can.ab <- lm(DistCan.ab ~ geo.dist.ab)
summary(DDR.can.ab) #p < 0.05
```

2.5 Plot significant linear regression
```{r}
#Weighted Unifrac
plot(geo.dist.ab, DistWU.ab, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Weighted Unifrac") #Plot the results
abline(DDR.wuni.ab) #Add a regression line
title(main="Abundant Taxa: DDR by Weighted Unifrac Distances") 

#Unweighted Unifrac
plot(geo.dist.ab, DistUU.ab, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Unweighted Unifrac") #Plot the results
abline(DDR.uni.ab) #Add a regression line
title(main="Abundant Taxa: DDR by Unweighted Unifrac Distances")

#Bray-Curtis
plot(geo.dist.ab, DistBray.ab, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Bray-Curtis Distances") #Plot the results
abline(DDR.bray.ab) #Add a regression line
title(main="Abundant Taxa: DDR by Bray-Curtis Distances")

#Canberra Distances
plot(geo.dist.ab, DistCan.ab, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Canberra") #Plot the results
abline(DDR.can.ab) #Add a regression line
title(main="Abundant Taxa: DDR by Canberra Distances")
```

3 INTERMEDIATE TAXA

3.1 Calculate community dissimilarities
```{r}
DistWU.i <- distance(ps.int, method="wUniFrac")
DistUU.i <- distance(ps.int, method="UniFrac")
DistBray.i <- distance(ps.int, method="bray")
DistCan.i <- distance(ps.int, method="canberra")
```

3.2 Calculate community distances
```{r}
#get metadata
meta.i <- data.frame(sample_data(ps.int))

#put a negative sign in front of all the south latitude coords
for (i in 1:nrow(meta.i)){
  if (meta.i$Pole[i] == "Antarctic"){
    meta.i$Glacier_Latitude[i] <- c(paste0("-", meta.i$Glacier_Latitude[i]))
    meta.i$Cryoconite_Latitude[i] <- c(paste0("-", meta.i$Cryoconite_Latitude[i]))
  }
}

#Some of our cryoconite holes don't have specific coords so we'll use the glacier coordinates
#remove letters from glacier coord strings
meta.i$Glacier_Latitude <- as.numeric(str_sub(meta.i$Glacier_Latitude,1,nchar(meta.i$Glacier_Latitude)-1))
meta.i$Glacier_Longitude <- as.numeric(str_sub(meta.i$Glacier_Longitude,1,nchar(meta.i$Glacier_Longitude)-1))

glac_lat.i <- meta.i$Glacier_Latitude
glac_long.i <- meta.i$Glacier_Longitude

#get latitude of each sample
cryo_lat.i <- as.numeric(meta.i$Cryoconite_Latitude)
#get longitude of each sample
cryo_long.i <- as.numeric(meta.i$Cryoconite_Longitude)

#replace any missing cryoconite coords with those of it's glacier
for (j in 1:length(cryo_lat.i)){
  if (is.na(cryo_lat.i[j])){
    cryo_lat.i[j] <- glac_lat.i[j]
    cryo_long.i[j] <- glac_long.i[j]
  }
}

#put into matrix
long.lat.i <- as.matrix(cbind(cryo_long.i, cryo_lat.i))

geo.dist.i <- earth.dist(long.lat.i, dist=TRUE) #a matrix of distances in kilometers between a list of longitudes and latitudes
```

3.3 Mantel tests for correlation between geographic distance and community dissimilarity
```{r}
#Weighted UniFrac Distances
mantel.rtest(geo.dist.i, DistWU.i, nrepet = 9999) #p < 0.05 so there is significant correlation between distance and community dissimilarity

#Unweighted UniFrac Distances
mantel.rtest(geo.dist.i, DistUU.i, nrepet = 9999) #p < 0.05 so there is a significant positive correlation between distance and community dissimilarity

#Bray-Curtis Distances
mantel.rtest(geo.dist.i, DistBray.i, nrepet = 9999) #p < 0.05 so there is significant correlation between distance and community dissimilarity

#Canberra Distances
mantel.rtest(geo.dist.i, DistCan.i, nrepet = 9999) #p < 0.05 so there is significant correlation between distance and community dissimilarity
```

3.4 Linear regression of community and distances
```{r}
DDR.wuni.i <- lm(DistWU.i ~ geo.dist.i)
summary(DDR.wuni.i) #p < 0.05

DDR.uni.i <- lm(DistUU.i ~ geo.dist.i)
summary(DDR.uni.i) #p < 0.05 

DDR.bray.i <- lm(DistBray.i ~ geo.dist.i)
summary(DDR.bray.i) #p > 0.05

DDR.can.i <- lm(DistCan.i ~ geo.dist.i)
summary(DDR.can.i) #p > 0.05
```

3.5 Plot significant linear regression
```{r}
#Weighted Unifrac
plot(geo.dist.i, DistWU.i, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Weighted Unifrac") #Plot the results
abline(DDR.wuni.i) #Add a regression line
title(main="Intermediate Taxa: DDR by Weighted Unifrac Distances") 

#Unweighted Unifrac
plot(geo.dist.i, DistUU.i, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Unweighted Unifrac") #Plot the results
abline(DDR.uni.i) #Add a regression line
title(main="Intermediate Taxa: DDR by Unweighted Unifrac Distances")

#Bray-Curtis
plot(geo.dist.i, DistBray.i, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Bray-Curtis Distances") #Plot the results
abline(DDR.bray.i) #Add a regression line
title(main="Intermediate Taxa: DDR by Bray-Curtis Distances")

#Canberra Distances
plot(geo.dist.i, DistCan.i, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Canberra") #Plot the results
abline(DDR.can.i) #Add a regression line
title(main="Intermediate Taxa: DDR by Canberra Distances")
```

4 RARE TAXA

4.1 Calculate community dissimilarities
```{r}
DistWU.ra <- distance(ps.rare, method="wUniFrac")
DistUU.ra <- distance(ps.rare, method="UniFrac")
DistBray.ra <- distance(ps.rare, method="bray")
DistCan.ra <- distance(ps.rare, method="canberra")
```

4.2 Calculate community distances
```{r}
#get metadata
meta.ra <- data.frame(sample_data(ps.rare))

#put a negative sign in front of all the south latitude coords
for (i in 1:nrow(meta.ra)){
  if (meta.ra$Pole[i] == "Antarctic"){
    meta.ra$Glacier_Latitude[i] <- c(paste0("-", meta.ra$Glacier_Latitude[i]))
    meta.ra$Cryoconite_Latitude[i] <- c(paste0("-", meta.ra$Cryoconite_Latitude[i]))
  }
}

#Some of our cryoconite holes don't have specific coords so we'll use the glacier coordinates
#remove letters from glacier coord strings
meta.ra$Glacier_Latitude <- as.numeric(str_sub(meta.ra$Glacier_Latitude,1,nchar(meta.ra$Glacier_Latitude)-1))
meta.ra$Glacier_Longitude <- as.numeric(str_sub(meta.ra$Glacier_Longitude,1,nchar(meta.ra$Glacier_Longitude)-1))

glac_lat.ra <- meta.ra$Glacier_Latitude
glac_long.ra <- meta.ra$Glacier_Longitude

#get latitude of each sample
cryo_lat.ra <- as.numeric(meta.ra$Cryoconite_Latitude)
#get longitude of each sample
cryo_long.ra <- as.numeric(meta.ra$Cryoconite_Longitude)

#replace any missing cryoconite coords with those of it's glacier
for (j in 1:length(cryo_lat.ra)){
  if (is.na(cryo_lat.ra[j])){
    cryo_lat.ra[j] <- glac_lat.ra[j]
    cryo_long.ra[j] <- glac_long.ra[j]
  }
}

#put into matrix
long.lat.ra <- as.matrix(cbind(cryo_long.ra, cryo_lat.ra))

geo.dist.ra <- earth.dist(long.lat.ra, dist=TRUE) #a matrix of distances in kilometers between a list of longitudes and latitudes
```

4.3 Mantel tests for correlation between geographic distance and community dissimilarity
```{r}
#Weighted UniFrac Distances
mantel.rtest(geo.dist.ra, DistWU.ra, nrepet = 9999) #p > 0.05 so there is no significant correlation between distance and community dissimilarity

#Unweighted UniFrac Distances
mantel.rtest(geo.dist.ra, DistUU.ra, nrepet = 9999) #p < 0.05 so there is a significant positive correlation between distance and community dissimilarity

#Bray-Curtis Distances
mantel.rtest(geo.dist.ra, DistBray.ra, nrepet = 9999) #p < 0.05 so there is significant correlation between distance and community dissimilarity

#Canberra Distances
mantel.rtest(geo.dist.ra, DistCan.ra, nrepet = 9999) #p < 0.05 so there is significant correlation between distance and community dissimilarity
```

4.4 Linear regression of community and distances
```{r}
DDR.wuni.ra <- lm(DistWU.ra ~ geo.dist.ra)
summary(DDR.wuni.ra) #p > 0.05

DDR.uni.ra <- lm(DistUU.ra ~ geo.dist.ra)
summary(DDR.uni.ra) #p < 0.05 

DDR.bray.ra <- lm(DistBray.ra ~ geo.dist.ra)
summary(DDR.bray.ra) #p < 0.05

DDR.can.ra <- lm(DistCan.ra ~ geo.dist.ra)
summary(DDR.can.ra) #p < 0.05
```

4.5 Plot significant linear regression
```{r}
#Weighted Unifrac
plot(geo.dist.ra, DistWU.ra, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Weighted Unifrac") #Plot the results
abline(DDR.wuni.ra) #Add a regression line
title(main="Rare Taxa: DDR by Weighted Unifrac Distances") 

#Unweighted Unifrac
plot(geo.dist.ra, DistUU.ra, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Unweighted Unifrac") #Plot the results
abline(DDR.uni.ra) #Add a regression line
title(main="Rare Taxa: DDR by Unweighted Unifrac Distances")

#Bray-Curtis
plot(geo.dist.ra, DistBray.ra, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Bray-Curtis Distances") #Plot the results
abline(DDR.bray.ra) #Add a regression line
title(main="Rare Taxa: DDR by Bray-Curtis Distances")

#Canberra Distances
plot(geo.dist.ra, DistCan.ra, pch = 16, col = "blue",
     xlab="Distance (km)", ylab="Canberra") #Plot the results
abline(DDR.can.ra) #Add a regression line
title(main="Rare Taxa: DDR by Canberra Distances")
```

