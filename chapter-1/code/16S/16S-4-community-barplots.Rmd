---
title: "good-18S-6-community-profiles"
author: "Amy Solman"
date: "05/10/2021"
output: html_document
---

This script will visualize the taxa groups present in our samples, so that differences in total, abundant, intermediate and rare communities can be compared between glaciers, regions and poles.

This will be done by:
Abundance bar plots (bar plots showing the relative abundance of each phyla within each sample/glacier/region/pole

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear workspace and load packages
```{r}
rm(list=ls())
graphics.off()

# library(ggpubr) #for making my boxplots
# library(FSA) #for dunn's test
# library(vegan) #for diversity indices
library(ggplot2) #for making plots
library(dplyr) #for manipulating data where you see %>% and computing summary stats
#remotes::install_github("cpauvert/psadd")
#library(psadd)
```

Load Data
```{r}
#TOTAL DATASET
ps <- readRDS("../output/16S-phyloseq-object-rarefied.rds")

#Total Abundant
ps.abun <- readRDS("../output/16S-total-abundant.rds")
#Total Intermediate
ps.int <- readRDS("../output/16S-total-intermediate.rds")
#Total Rare
ps.rare <- readRDS("../output/16S-total-rare.rds")
```

Remove any samples with zero counts from each of our communities
```{r}
#Total
ps.prune <- prune_samples(sample_sums(ps) > 0, ps)
#Abundant
abun.prune <- prune_samples(sample_sums(ps.abun) > 0, ps.abun)
#Intermediate
int.prune <- prune_samples(sample_sums(ps.int) > 0, ps.int)
#Rare
rare.prune <- prune_samples(sample_sums(ps.rare) > 0, ps.rare)
```

1 TOTAL TAXA
1.1 Abundance Bar Plots
```{r}
#Agglomerate ASVs by phyla into dataframes ready for plotting
ps.glom <- ps.prune %>%
  tax_glom(taxrank = "Phylum", NArm=FALSE) %>%
  psmelt()

#Glacier
ggplot(ps.glom, aes(x = Glacier, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Glacier")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Region
ggplot(ps.glom, aes(x = Region, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Region")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Pole
ggplot(ps.glom, aes(x = Pole, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Pole")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```
1.2 Another bar plot
```{r}
#convert to relative abundance
ps_rel_abund = phyloseq::transform_sample_counts(ps.prune, function(x){x / sum(x)})

#plot
#Glacier
phyloseq::plot_bar(ps_rel_abund, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Glacier, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Region
phyloseq::plot_bar(ps_rel_abund, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Region, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Pole
phyloseq::plot_bar(ps_rel_abund, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Pole, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

```
1.3 Comparing phyla for both poles
```{r}
#Agglomerate taxa to phylum level
ps_phylum <- phyloseq::tax_glom(ps.prune, "Phylum")
phyloseq::taxa_names(ps_phylum) <- phyloseq::tax_table(ps_phylum)[, "Phylum"]

#plot
phyloseq::psmelt(ps_phylum) %>%
ggplot(data = ., aes(x = Pole, y = Abundance)) +
  geom_boxplot(outlier.shape  = NA) +
  geom_jitter(aes(color = Phylum), height = 0, width = .2) +
  labs(x = "", y = "Abundance\n") +
  facet_wrap(~ Phylum, scales = "free")

```
1.4 Pie chart
```{r}
counts <- data.frame(t(otu_table(ps_phylum)))
count_sums <- colSums(counts)
pct <- count_sums/sum(count_sums)*100
lbls <- names(counts) # add percents to labels
df <- data.frame(lbls, pct)
x <- subset(df, df$pct < 2)
sum_x <- sum(x$pct)
#remove rows with less than 1
y <- subset(df, df$pct > 2)
df2 <- data.frame("Other", sum_x)
names(df2) <- c("lbls", "pct")
newdf <- rbind(y, df2)
newdf$lbls <- paste(newdf$lbls, round(newdf$pct, digits=2)) # add percents to labels
newdf$lbls <- paste(newdf$lbls,"%",sep="") # ad % to labels 
#pie(newdf$pct, labels = newdf$lbls, col=rainbow(length(newdf$pct)), radius = 0.9, cex = 0.4)
pie(newdf$pct, labels = newdf$lbls, col=rainbow(length(newdf$pct)), radius= 1, cex=0.3, main="Total Community Pie Chart")
```

2 ABUNDANT TAXA
2.1 Abundance Bar Plots
```{r}
#Agglomerate ASVs by phyla into dataframes ready for plotting
abun.glom <- abun.prune %>%
  tax_glom(taxrank = "Phylum", NArm=FALSE) %>%
  psmelt()

#Glacier
ggplot(abun.glom, aes(x = Glacier, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Glacier")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Region
ggplot(abun.glom, aes(x = Region, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Region")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Pole
ggplot(abun.glom, aes(x = Pole, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Pole")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```
2.2 Another bar plot
```{r}
#convert to relative abundance
ps_rel_abund.ab = phyloseq::transform_sample_counts(abun.prune, function(x){x / sum(x)})

#plot
#Glacier
phyloseq::plot_bar(ps_rel_abund.ab, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Glacier, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Region
phyloseq::plot_bar(ps_rel_abund.ab, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Region, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Pole
phyloseq::plot_bar(ps_rel_abund.ab, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Pole, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

```
2.3 Comparing phyla for both poles
```{r}
#Agglomerate taxa to phylum level
ps_phylum.ab <- phyloseq::tax_glom(abun.prune, "Phylum")
phyloseq::taxa_names(ps_phylum.ab) <- phyloseq::tax_table(ps_phylum.ab)[, "Phylum"]

#plot
phyloseq::psmelt(ps_phylum.ab) %>%
ggplot(data = ., aes(x = Pole, y = Abundance)) +
  geom_boxplot(outlier.shape  = NA) +
  geom_jitter(aes(color = Phylum), height = 0, width = .2) +
  labs(x = "", y = "Abundance\n") +
  facet_wrap(~ Phylum, scales = "free")

```

2.4 Pie chart
```{r}
counts <- data.frame(t(otu_table(ps_phylum.ab)))
count_sums <- colSums(counts)
#pct <- round(count_sums/sum(count_sums)*100)
pct <- count_sums/sum(count_sums)*100
lbls <- names(counts) # add percents to labels
df <- data.frame(lbls, pct)
x <- subset(df, df$pct < 2)
sum_x <- sum(x$pct)
#remove rows with less than 1
y <- subset(df, df$pct > 2)
df2 <- data.frame("Other", sum_x)
names(df2) <- c("lbls", "pct")
newdf <- rbind(y, df2)
newdf$lbls <- paste(newdf$lbls, round(newdf$pct, digits=2)) # add percents to labels
newdf$lbls <- paste(newdf$lbls,"%",sep="") # ad % to labels 
#pie(newdf$pct, labels = newdf$lbls, col=rainbow(length(newdf$pct)), radius = 1, cex = 0.3)
pie(newdf$pct, labels = newdf$lbls, col=rainbow(length(newdf$pct)), main="Abundant Community Pie Chart")
```

3 INTERMEDIATE TAXA
3.1 Abundance Bar Plots
```{r}
#Agglomerate ASVs by phyla into dataframes ready for plotting
ps.int.glom <- int.prune %>%
  tax_glom(taxrank = "Phylum", NArm=FALSE) %>%
  psmelt()

#Glacier
ggplot(ps.int.glom, aes(x = Glacier, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Glacier")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Region
ggplot(ps.int.glom, aes(x = Region, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Region")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Pole
ggplot(ps.int.glom, aes(x = Pole, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Pole")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```
3.2 Another bar plot
```{r}
#convert to relative abundance
ps_rel_abund.i = phyloseq::transform_sample_counts(int.prune, function(x){x / sum(x)})

#plot
#Glacier
phyloseq::plot_bar(ps_rel_abund.i, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Glacier, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Region
phyloseq::plot_bar(ps_rel_abund.i, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Region, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Pole
phyloseq::plot_bar(ps_rel_abund.i, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Pole, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

```
3.3 Comparing phyla for both poles
```{r}
#Agglomerate taxa to phylum level
ps_phylum.i <- phyloseq::tax_glom(int.prune, "Phylum")
phyloseq::taxa_names(ps_phylum.i) <- phyloseq::tax_table(ps_phylum.i)[, "Phylum"]

#plot
phyloseq::psmelt(ps_phylum.i) %>%
ggplot(data = ., aes(x = Pole, y = Abundance)) +
  geom_boxplot(outlier.shape  = NA) +
  geom_jitter(aes(color = Phylum), height = 0, width = .2) +
  labs(x = "", y = "Abundance\n") +
  facet_wrap(~ Phylum, scales = "free")

```
3.4 Pie chart
```{r}
counts <- data.frame(t(otu_table(ps_phylum.i)))
count_sums <- colSums(counts)
pct <- count_sums/sum(count_sums)*100
lbls <- names(counts) # add percents to labels
df <- data.frame(lbls, pct)
x <- subset(df, df$pct < 2)
sum_x <- sum(x$pct)
#remove rows with less than 1
y <- subset(df, df$pct > 2)
df2 <- data.frame("Other", sum_x)
names(df2) <- c("lbls", "pct")
newdf <- rbind(y, df2)
newdf$lbls <- paste(newdf$lbls, round(newdf$pct, digits=2)) # add percents to labels
newdf$lbls <- paste(newdf$lbls,"%",sep="") # ad % to labels 
#pie(newdf$pct, labels = newdf$lbls, col=rainbow(length(newdf$pct)), radius = 0.9, cex = 0.4)
pie(newdf$pct, labels = newdf$lbls, col=rainbow(length(newdf$pct)), cex=0.6, main="Intermediate Community Pie Chart")
```

4 RARE TAXA
4.1 Abundance Bar Plots
```{r}
#Agglomerate ASVs by phyla into dataframes ready for plotting
rare.glom <- rare.prune %>%
  tax_glom(taxrank = "Phylum", NArm=FALSE) %>%
  psmelt()

#Glacier
ggplot(rare.glom, aes(x = Glacier, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Glacier")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Region
ggplot(rare.glom, aes(x = Region, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Region")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#Pole
ggplot(rare.glom, aes(x = Pole, y = Abundance, fill = Phylum)) +
  geom_bar(position="fill", stat="identity") +
  xlab("Pole")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```
4.2 Another bar plot
```{r}
#convert to relative abundance
ps_rel_abund.ra = phyloseq::transform_sample_counts(rare.prune, function(x){x / sum(x)})

#plot
#Glacier
phyloseq::plot_bar(ps_rel_abund.ra, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Glacier, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Region
phyloseq::plot_bar(ps_rel_abund.ra, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Region, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

#Pole
phyloseq::plot_bar(ps_rel_abund.ra, fill = "Phylum") +
  geom_bar(aes(color = Phylum, fill = Phylum), stat = "identity", position = "stack") +
  labs(x = "", y = "Relative Abundance\n") +
  facet_wrap(~ Pole, scales = "free") +
  theme(panel.background = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

```
4.3 Comparing phyla for both poles
```{r}
#Agglomerate taxa to phylum level
ps_phylum.ra <- phyloseq::tax_glom(rare.prune, "Phylum")
phyloseq::taxa_names(ps_phylum.ra) <- phyloseq::tax_table(ps_phylum.ra)[, "Phylum"]

#plot
phyloseq::psmelt(ps_phylum.ra) %>%
ggplot(data = ., aes(x = Pole, y = Abundance)) +
  geom_boxplot(outlier.shape  = NA) +
  geom_jitter(aes(color = Phylum), height = 0, width = .2) +
  labs(x = "", y = "Abundance\n") +
  facet_wrap(~ Phylum, scales = "free")

```
4.4 Pie chart
```{r}
counts <- data.frame(t(otu_table(ps_phylum.ra)))
count_sums <- colSums(counts)
#pct <- round(count_sums/sum(count_sums)*100)
pct <- count_sums/sum(count_sums)*100
lbls <- names(counts) # add percents to labels
df <- data.frame(lbls, pct)
x <- subset(df, df$pct < 2)
sum_x <- sum(x$pct)
#remove rows with less than 1
y <- subset(df, df$pct > 2)
df2 <- data.frame("Other", sum_x)
names(df2) <- c("lbls", "pct")
newdf <- rbind(y, df2)
newdf$lbls <- paste(newdf$lbls, round(newdf$pct, digits=2)) # add percents to labels
newdf$lbls <- paste(newdf$lbls,"%",sep="") # ad % to labels 
#pie(newdf$pct, labels = newdf$lbls, col=rainbow(length(newdf$pct)), radius = 1, cex = 0.3)
pie(newdf$pct, labels = newdf$lbls, col=rainbow(length(newdf$pct)), radius=1, cex=0.5)
```