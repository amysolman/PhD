---
title: "MultiCoLA"
author: "Amy Solman"
date: "19/02/2022"
output: html_document
---
SCRIPTS AND GUIDE DOWNLOADED FROM: https://www.mpi-bremen.de/en/Softwares.html#section1550

Gobet, A., Quince, C., and Ramette, A. 2010. Multivariate Cutoff Level Analysis (MultiCoLA) of Large Community Datasets. Nucl. Acids Res.


*************************************************************************************************************
*Steps of MuliCoLA Analysis*

1) Load and prepare the data

2) Community Structure
2.1) Obtain a matrix for each taxonomic level (when the taxonomic annotation is available only)
2.2) Apply successive cutoffs on each original matrix
2.3) Calculate of Spearman (or Pearson, Kendall) correlations and Procrustes correlations between the original dataset and the truncated ones
2.4) Plot results of cutoff impact

3) Ecological Patterns
3.1) Variation partitioning at several cutoff levels for all taxonomic levels
3.2) Calculation of correlation coefficients for the environmental parameters (for the first RDA axis)
3.3) Calculation of the significance of the whole variation partitioning model and the impact of the pure environmental parameters

4) Save workspace
*************************************************************************************************************

First, set the directory where you want to work, i.e. where your input file and the series of scripts should be, and where you will find the several outputs from these scripts. The directory should be created beforehand and the name should not contain spaces to be readable by the software R (e.g. use underscore to separate words). The path to the working directory (e.g. “454_MPTS”) may be indicated as followed:
setwd("/Users/angeliquegobet/R/454_MPTS")

Clear workspace and import data
```{r}
rm(list=ls())
graphics.off()

#load packages
library(vegan)
library(MASS)
library(ggplot2)
library(tibble) #to convert rowname to column and vice versa

#load phyloseq object
ps_pro <- readRDS("../../results/16S/phylo-objects/16S-phyloseq-object-rarefied-decontam.rds") 
ps_euk <- readRDS("../../results/18S/phylo-objects/18S-phyloseq-object-rarefied.rds") 

#source our data prep function
source("solman-MultiCoLA-input-file-prep.R")

#source pre-written MultiCoLA functions from Gobet et al
source("taxa.pooler.1.4.r") #step 2.1
source("COtables.1.4.r") #step 2.2
source("cutoff.impact.1.4.r") #step 2.3
source("cutoff.impact.fig.1.4.r") #step 2.4 
source("VP.COL.1.4.r") #step 3.1
source("corrcoeff.ENV.1.4.r") #step 3.2
source("signif.1.4.r") #step 3.3
```

16S Arctic Data-set based cut-offs

1) Load and prepare data
I have previously written a function MultiCoLA_input_file_prep() to take a phyloseq object and output data for this analysis.

```{r}
#separate arctic samples
ps_arc <- subset_samples(ps_pro, Pole=="Arctic")
#remove asvs with 0 counts
ps_arc_filter = filter_taxa(ps_arc, function(x) sum(x) >= 1, TRUE)
#prep data
M <- MultiCoLA_input_file_prep(ps_arc_filter)
```

2) Community Structure

2.1) Obtain a matrix for each taxonomic level (when the taxonomic annotation is available only)

```{r}
all_taxa_pooled<-taxa.pooler(M)
```

2.2) Apply successive cutoffs on each original matrix

```{r}
#Remove dominant types 

dom.truncated.DS.phylum<-COtables(all_taxa_pooled[[1]], Type="ADS",typem="dominant")

dom.truncated.DS.class<-COtables(all_taxa_pooled[[2]], Type="ADS",typem="dominant")

dom.truncated.DS.order<-COtables(all_taxa_pooled[[3]], Type="ADS",typem="dominant")

dom.truncated.DS.family<-COtables(all_taxa_pooled[[4]], Type="ADS",typem="dominant")

dom.truncated.DS.genus<-COtables(all_taxa_pooled[[5]], Type="ADS",typem="dominant")

dom.truncated.DS.species<-COtables(all_taxa_pooled[[6]], Type="ADS",typem="dominant")

dom.truncated.DS.OTUcompleteDS<-COtables(all_taxa_pooled[[7]], Type="ADS",typem="dominant")

dom.truncated.DS.OTUwholeDS<-COtables(all_taxa_pooled[[8]], Type="ADS",typem="dominant")

#Remove rare types

rare.truncated.DS.phylum<-COtables(all_taxa_pooled[[1]], Type="ADS",typem="rare")

rare.truncated.DS.class<-COtables(all_taxa_pooled[[2]], Type="ADS",typem="rare")

rare.truncated.DS.order<-COtables(all_taxa_pooled[[3]], Type="ADS",typem="rare")

rare.truncated.DS.family<-COtables(all_taxa_pooled[[4]], Type="ADS",typem="rare")

rare.truncated.DS.genus<-COtables(all_taxa_pooled[[5]], Type="ADS",typem="rare")

rare.truncated.DS.species<-COtables(all_taxa_pooled[[6]], Type="ADS",typem="rare")

rare.truncated.DS.OTUcompleteDS<-COtables(all_taxa_pooled[[7]], Type="ADS",typem="rare")

rare.truncated.DS.OTUwholeDS<-COtables(all_taxa_pooled[[8]], Type="ADS",typem="rare")
```

2.3) Calculate of Spearman (or Pearson, Kendall) correlations and Procrustes correlations between the original dataset and the truncated ones

```{r}
dom.corr.all<-cutoff.impact(all_taxa_pooled,Type="ADS",corcoef="spearman",typem="dominant")

rare.corr.all<-cutoff.impact(all_taxa_pooled,Type="ADS",corcoef="spearman",typem="rare")
```

Export results
```{r}
#Dominant
write.csv(dom.corr.all[[1]], "results/16S-arctic-phylum-dominant-spearman-procrustes-results.csv")
write.csv(dom.corr.all[[2]], "results/16S-arctic-class-dominant-spearman-procrustes-results.csv")
write.csv(dom.corr.all[[3]], "results/16S-arctic-order-dominant-spearman-procrustes-results.csv")
write.csv(dom.corr.all[[4]], "results/16S-arctic-family-dominant-spearman-procrustes-results.csv")
write.csv(dom.corr.all[[5]], "results/16S-arctic-genus-dominant-spearman-procrustes-results.csv")
write.csv(dom.corr.all[[6]], "results/16S-arctic-species-dominant-spearman-procrustes-results.csv")
write.csv(dom.corr.all[[7]], "results/16S-arctic-classified-only-dominant-spearman-procrustes-results.csv")
write.csv(dom.corr.all[[8]], "results/16S-arctic-all-asvs-dominant-spearman-procrustes-results.csv")

#Rare
write.csv(rare.corr.all[[1]], "results/16S-arctic-phylum-rare-spearman-procrustes-results.csv")
write.csv(rare.corr.all[[2]], "results/16S-arctic-class-rare-spearman-procrustes-results.csv")
write.csv(rare.corr.all[[3]], "results/16S-arctic-order-rare-spearman-procrustes-results.csv")
write.csv(rare.corr.all[[4]], "results/16S-arctic-family-rare-spearman-procrustes-results.csv")
write.csv(rare.corr.all[[5]], "results/16S-arctic-genus-rare-spearman-procrustes-results.csv")
write.csv(rare.corr.all[[6]], "results/16S-arctic-species-rare-spearman-procrustes-results.csv")
write.csv(rare.corr.all[[7]], "results/16S-arctic-classified-only-rare-spearman-procrustes-results.csv")
write.csv(rare.corr.all[[8]], "results/16S-arctic-all-asvs-rare-spearman-procrustes-results.csv")

#Collate results into one dataframe
x1 <- data.frame(dom.corr.all[[1]])
x1$Rank <- "Phylum"
x1$Type <- "Dominant"
x2 <- data.frame(dom.corr.all[[2]])
x2$Rank <- "Class"
x2$Type <- "Dominant"
x3 <- data.frame(dom.corr.all[[3]])
x3$Rank <- "Order"
x3$Type <- "Dominant"
x4 <- data.frame(dom.corr.all[[4]])
x4$Rank <- "Family"
x4$Type <- "Dominant"
x5 <- data.frame(dom.corr.all[[5]])
x5$Rank <- "Genus"
x5$Type <- "Dominant"
x6 <- data.frame(dom.corr.all[[6]])
x6$Rank <- "Species"
x6$Type <- "Dominant"
x7 <- data.frame(dom.corr.all[[7]])
x7$Rank <- "Classified"
x7$Type <- "Dominant"
x8 <- data.frame(dom.corr.all[[8]])
x8$Rank <- "Total"
x8$Type <- "Dominant"

y1 <- data.frame(rare.corr.all[[1]])
y1$Rank <- "Phylum"
y1$Type <- "Rare"
y2 <- data.frame(rare.corr.all[[2]])
y2$Rank <- "Class"
y2$Type <- "Rare"
y3 <- data.frame(rare.corr.all[[3]])
y3$Rank <- "Order"
y3$Type <- "Rare"
y4 <- data.frame(rare.corr.all[[4]])
y4$Rank <- "Family"
y4$Type <- "Rare"
y5 <- data.frame(rare.corr.all[[5]])
y5$Rank <- "Genus"
y5$Type <- "Rare"
y6 <- data.frame(rare.corr.all[[6]])
y6$Rank <- "Species"
y6$Type <- "Rare"
y7 <- data.frame(rare.corr.all[[7]])
y7$Rank <- "Classified"
y7$Type <- "Rare"
y8 <- data.frame(rare.corr.all[[8]])
y8$Rank <- "Total"
y8$Type <- "Rare"

total_results <- rbind(x1,x2,x3, x4, x5, x6, x7, x8, y1, y2, y3, y4, y5, y6, y7, y8)
#total_results <- tibble::rownames_to_column(total_results, "Truncated")
Truncated <- rownames(x1)

#Add truncated values to rare results
#Subset dataframe
rare <- total_results[total_results$Type == "Rare",]
rare$Truncated = as.numeric(rep(Truncated, 8))

#Add reverse truncated values to dominant results
#Subset dataframe
dom <- total_results[total_results$Type == "Dominant",]
dom$Truncated = as.numeric(rep(rev(Truncated), 8))

#bind the data frames
total_results_rare_dom <- rbind(rare, dom)

#export
write.csv(total_results_rare_dom, "results/16S-arctic-total-results.csv")
```

Plot dominant results
```{r}
#Dominant Spearman's rank results
dom <- total_results_rare_dom[total_results_rare_dom$Type == "Dominant",]

#At what truncation point does the total dataset drop below 0.8 coefficient?
dom_tot <- dom[dom$Rank == "Total",]
dom_tot_trim <- dom_tot[dom_tot$corrcoeff < 0.8,]
dom_tot_value <- as.numeric(dom_tot_trim$Truncated[1])

p1 <- ggplot(dom, aes(x=Truncated, y=corrcoeff, group=Rank)) +
  geom_line(aes(color=Rank))+
  geom_point(aes(color=Rank))+
  ylim(0,1)+
  scale_x_continuous(breaks = dom$Truncated)+
  theme_bw()+
  geom_vline(xintercept = dom_tot_value, linetype="dotted", 
                color = "blue", size=1)+
  xlab("% Total Rare ASVs")+
  ylab("Spearman's Correlation Coefficient")+
  ggtitle("16S Arctic data set-based Spearman's correlation coefficients between original \n data set dissimilarity matrix and matrices with increasing addition of rare types")+
  theme(axis.text.x = element_text(angle = 90))

pdf("results/16S-Arctic-spearmans-dominant.pdf")
print(p1)
dev.off()

#Dominant Procrustes results

#At what truncation point does the total dataset drop below 0.8 R value?
dom_tot_trim_R <- dom_tot[dom_tot$R.Procrustes < 0.9,]
dom_tot_value_R <- as.numeric(dom_tot_trim_R$Truncated[1])

p2 <- ggplot(dom, aes(x=Truncated, y=R.Procrustes, group=Rank)) +
  geom_line(aes(color=Rank))+
  geom_point(aes(color=Rank))+
  ylim(0,1)+
  scale_x_continuous(breaks = dom$Truncated)+
  theme_bw()+
  geom_vline(xintercept = dom_tot_value_R, linetype="dotted", 
                color = "blue", size=1)+
  xlab("% ASVs Removed")+
  ylab("Procrustes R Value")+
  ggtitle("16S data set-based Procrustes R value between original data set\n NMDS and datasets truncated by increasing addition of rare types")+
  theme(axis.text.x = element_text(angle = 90))
  
pdf("results/16S-Arctic-procrustes-dominant.pdf")
print(p2)
dev.off()

```

Plot rare results
```{r}
#Dominant Spearman's rank results
#Subset dataframe
rare <- total_results_rare_dom[total_results_rare_dom$Type == "Rare",]

#At what truncation point does the total dataset drop below 0.8 coefficient?
rare_tot <- rare[rare$Rank == "Total",]
rare_tot_trim <- rare_tot[rare_tot$corrcoeff < 0.85,]
rare_tot_value <- as.numeric(rare_tot_trim$Truncated[1])

p3 <- ggplot(rare, aes(x=Truncated, y=corrcoeff, group=Rank)) +
  geom_line(aes(color=Rank))+
  geom_point(aes(color=Rank))+
  ylim(0,1)+
  scale_x_continuous(breaks = rare$Truncated)+
  theme_bw()+
  geom_vline(xintercept = rare_tot_value, linetype="dotted", 
                color = "blue", size=1)+
  xlab("% Total Rare ASVs Removed")+
  ylab("Spearman's Correlation Coefficient")+
  ggtitle("16S Arctic data set-based Spearman's correlation coefficients between original\n data set dissimilarity matrix and matrices truncated by increasing removal of \nrare types")+
  theme(axis.text.x = element_text(angle = 90))

pdf("results/16S-Arctic-spearmans-rare.pdf")
print(p3)
dev.off()

#Rare Procrustes results

#At what truncation point does the total dataset drop below 0.8 R value?
rare_tot_trim_R <- rare_tot[rare_tot$R.Procrustes < 0.95,]
rare_tot_value_R <- as.numeric(rare_tot_trim_R$Truncated[1])

p4 <- ggplot(rare, aes(x=Truncated, y=R.Procrustes, group=Rank)) +
  geom_line(aes(color=Rank))+
  geom_point(aes(color=Rank))+
  ylim(0,1)+
  scale_x_continuous(breaks = rare$Truncated)+
  theme_bw()+
  geom_vline(xintercept = rare_tot_value_R, linetype="dotted", 
                color = "blue", size=1)+
  xlab("% Total Rare ASVs Removed")+
  ylab("Procrustes R Value")+
  ggtitle("16S data set-based Procrustes R value between original data set\n NMDS and datasets truncated by increasing removal of\n rare types")+
  theme(axis.text.x = element_text(angle = 90))
  
pdf("results/16S-Arctic-procrustes-rare.pdf")
print(p4)
dev.off()

```

According to this analysis, with a data set-based approach, the abundant subcommunity comprises the 15% most abundant ASVs and the rare subcommunity comparises the 5% least abundant ASVs. Let's see what that looks like.
```{r}
#What is 15% of total counts 
total_counts_15 <- sum(sums)*0.15
#What is 5% of total counts
total_counts_5 <- sum(sums)*0.05

asv_tab <- data.frame(otu_table(ps_arc_filter))
asv_abun <- data.frame(rowSums(asv_tab))
order_abun <- data.frame(asv_abun[order(-asv_abun$rowSums.asv_tab.), , drop=FALSE])
order_abun_rev <- data.frame(asv_abun[order(asv_abun$rowSums.asv_tab.), , drop=FALSE])

my_counts <- c(0)
for (i in 1:nrow(order_abun)){
  my_counts <- c(my_counts, order_abun$rowSums.asv_tab.[i] + my_counts[i])
}
my_counts <-my_counts[-c(1)]
order_abun$Total_Counts <- my_counts

my_counts_2 <- c(0)
for (i in 1:nrow(order_abun_rev)){
  my_counts_2 <- c(my_counts_2, order_abun_rev$rowSums.asv_tab.[i] + my_counts_2[i])
}
my_counts_2 <-my_counts_2[-c(1)]
order_abun_rev$Total_Counts <- my_counts_2

#Subset Abundant community
abun_com <- order_abun[order_abun$Total_Counts <= total_counts_15, ]

#Subset Rare community
rare_com <- order_abun_rev[order_abun_rev$Total_Counts <= total_counts_5,]

#Subset Intermediate community 
int_com <- order_abun[!(row.names(order_abun) %in% row.names(abun_com)),]
int_com <- int_com[!(row.names(int_com) %in% row.names(rare_com)),]
```


