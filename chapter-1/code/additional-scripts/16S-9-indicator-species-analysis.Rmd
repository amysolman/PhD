---
title: "Indicator Species Analysis"
author: "Amy Solman"
date: "06/10/2021"
output: html_document
---
This script will carry out Indicator Species Analysis 

Indicator Species Analysis will be used to answer the question:
Which species are found more often in the Arctic compared to the Antarctic?


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear workspace and load packages
```{r}
rm(list=ls())
graphics.off()

# library(ggpubr) #for making my boxplots
# library(FSA) #for dunn's test
# library(vegan) #for diversity indices
library(ggplot2) #for making plots
# library(dplyr) #for manipulating data where you see %>% and computing summary stats
# install.packages("dendextend")
# library(dendextend) #for hierchical clustering
#install.packages("indicspecies")
library(indicspecies)
library(phyloseq)

```

Load Data
```{r}
#TOTAL DATASET
ps <- readRDS("../output/16S-phyloseq-object-rarefied.rds")

#Total Abundant
ps.abun <- readRDS("../output/16S-total-abundant.rds")
#Total Intermediate
ps.int <- readRDS("../output/16S-total-intermediate.rds")
#Total Rare
ps.rare <- readRDS("../output/16S-total-rare.rds")
```

Remove any samples with zero counts from each of our communities
```{r}
#Total
ps <- prune_samples(sample_sums(ps) > 0, ps)
#Abundant
ps.abun <- prune_samples(sample_sums(ps.abun) > 0, ps.abun)
#Intermediate
ps.int <- prune_samples(sample_sums(ps.int) > 0, ps.int)
#Rare
ps.rare <- prune_samples(sample_sums(ps.rare) > 0, ps.rare)
```

Tutorial from: https://jkzorz.github.io/2019/07/02/Indicator-species-analysis.html 

Total Taxa
```{r}
#transform into relative abundances
ps.rel = phyloseq::transform_sample_counts(ps, function(x){x / sum(x)})

#get the asv table from our phyloseq object
counts1 <- data.frame(t(otu_table(ps.rel)))

#check this worked correctly
rowSums(counts1) #all rows should equal 1

#get the metadata from our phyloseq object
meta1 <- data.frame(sample_data(ps.rel))

#run indicator species command
inv1 = multipatt(counts1, meta1$Pole, func = "r.g", control = how(nperm=999))

#view results
summary(inv1) #220 asvs identified as specific to the Arctic
#115 asvs identified as specific to Antarctic

#get taxonomy
taxa_tab1 <- data.frame(tax_table(ps.rel))

#extract output data
Results1 <- inv1$sign

#bind with taxa table 
Results1_taxa <- cbind(Results1, taxa_tab1)

#remove rows with p value >0.05
Results1.prune <- Results1_taxa[Results1_taxa$p.value <= 0.05, ]

#Get our Arctic taxa 
Arctic_res1 <- Results1.prune[Results1.prune$s.Arctic == 1, ]
#Arctic_res1$Pole <- "Arctic"
df1 <- data.frame(table(Arctic_res1$Class))
df1$Pole <- "Arctic"

#Get our Antarctic taxa 
Antarctic_res1 <- Results1.prune[Results1.prune$s.Antarctic == 1, ]
df2 <- data.frame(table(Antarctic_res1$Class))
df2$Pole <- "Antarctic"

#Visualise

pct1 <- df1$Freq/sum(df1$Freq)*100
lbls1 <- df1$Var # add percents to labels
datafrm1 <- data.frame(lbls1, pct1)
x1 <- subset(datafrm1, datafrm1$pct1 < 1)
sum_x1 <- sum(x1$pct)
#remove rows with less than 2
y1 <- subset(datafrm1, datafrm1$pct > 1)
datafrm2 <- data.frame("Other", sum_x1)
names(datafrm2) <- c("lbls1", "pct1")
newdf1 <- rbind(y1, datafrm2)
newdf1$lbls1 <- paste(newdf1$lbls1, round(newdf1$pct1, digits=2)) # add percents to labels
newdf1$lbls1 <- paste(newdf1$lbls1,"%",sep="") # ad % to labels 
pie(newdf1$pct1, labels = newdf1$lbls1, col=rainbow(length(newdf1$pct1)), radius= 1, cex=0.3, main="Arctic Total Community Indicator Species by Class")

pct2 <- df2$Freq/sum(df2$Freq)*100
lbls2 <- df2$Var # add percents to labels
datafrm2 <- data.frame(lbls2, pct2)
x2 <- subset(datafrm2, datafrm2$pct2 < 1)
sum_x2 <- sum(x2$pct)
#remove rows with less than 2
y2 <- subset(datafrm2, datafrm2$pct > 1)
datafrm2 <- data.frame("Other", sum_x2)
names(datafrm2) <- c("lbls2", "pct2")
newdf2 <- rbind(y2, datafrm2)
newdf2$lbls2 <- paste(newdf2$lbls2, round(newdf2$pct2, digits=2)) # add percents to labels
newdf2$lbls2 <- paste(newdf2$lbls2,"%",sep="") # ad % to labels 
pie(newdf2$pct2, labels = newdf2$lbls2, col=rainbow(length(newdf2$pct2)), radius= 1, cex=0.3, main="Antarctic Total Community Indicator Species by Class")
```

Abundant Taxa
```{r}
#transform into relative abundances
ps.rel.abun = phyloseq::transform_sample_counts(ps.abun, function(x){x / sum(x)})

#get the asv table from our phyloseq object
counts2 <- data.frame(t(otu_table(ps.rel.abun)))

#check this worked correctly
rowSums(counts2) #all rows should equal 1

#get the metadata from our phyloseq object
meta2 <- data.frame(sample_data(ps.rel.abun))

#run indicator species command
inv2 = multipatt(counts2, meta2$Pole, func = "r.g", control = how(nperm=999))

#view results
summary(inv2) #37 asvs identified as specific to the Arctic
#41 asvs identified as specific to Antarctic

#get taxonomy
taxa_tab2 <- data.frame(tax_table(ps.rel.abun))

#extract output data
Results2 <- inv2$sign

#bind with taxa table 
Results2_taxa <- cbind(Results2, taxa_tab2)

#remove rows with p value >0.05
Results2.prune <- Results2_taxa[Results2_taxa$p.value <= 0.05, ]

#Get our Arctic taxa 
Arctic_res2 <- Results2.prune[Results2.prune$s.Arctic == 1, ]
#Arctic_res1$Pole <- "Arctic"
df3 <- data.frame(table(Arctic_res2$Class))
df3$Pole <- "Arctic"

#Get our Antarctic taxa 
Antarctic_res2 <- Results2.prune[Results2.prune$s.Antarctic == 1, ]
df4 <- data.frame(table(Antarctic_res2$Class))
df4$Pole <- "Antarctic"

#Visualise

pct3 <- df3$Freq/sum(df3$Freq)*100
lbls3 <- df3$Var # add percents to labels
datafrm1 <- data.frame(lbls3, pct3)
x3 <- subset(datafrm1, datafrm1$pct3 < 1)
sum_x3 <- sum(x3$pct)
#remove rows with less than 2
y3 <- subset(datafrm1, datafrm1$pct > 1)
datafrm2 <- data.frame("Other", sum_x3)
names(datafrm2) <- c("lbls3", "pct3")
newdf3 <- rbind(y3, datafrm2)
newdf3$lbls3 <- paste(newdf3$lbls3, round(newdf3$pct3, digits=2)) # add percents to labels
newdf3$lbls3 <- paste(newdf3$lbls3,"%",sep="") # ad % to labels 
pie(newdf3$pct3, labels = newdf3$lbls3, col=rainbow(length(newdf3$pct3)), radius= 1, cex=0.3, main="Arctic Abundant Community Indicator Species by Class")

pct4 <- df4$Freq/sum(df4$Freq)*100
lbls4 <- df4$Var # add percents to labels
datafrm4 <- data.frame(lbls4, pct4)
x4 <- subset(datafrm4, datafrm4$pct4 < 1)
sum_x4 <- sum(x4$pct)
#remove rows with less than 2
y4 <- subset(datafrm4, datafrm4$pct > 1)
datafrm4 <- data.frame("Other", sum_x4)
names(datafrm4) <- c("lbls4", "pct4")
newdf4 <- rbind(y4, datafrm4)
newdf4$lbls4 <- paste(newdf4$lbls4, round(newdf4$pct4, digits=2)) # add percents to labels
newdf4$lbls4 <- paste(newdf4$lbls4,"%",sep="") # ad % to labels 
pie(newdf4$pct4, labels = newdf4$lbls4, col=rainbow(length(newdf4$pct4)), radius= 1, cex=0.3, main="Antarctic Abundant Community Indicator Species by Class")
```

Intermediate Taxa
```{r}
#transform into relative abundances
ps.rel.int = phyloseq::transform_sample_counts(ps.int, function(x){x / sum(x)})

#get the asv table from our phyloseq object
counts2 <- data.frame(t(otu_table(ps.rel.int)))

#check this worked correctly
rowSums(counts2) #all rows should equal 1

#get the metadata from our phyloseq object
meta2 <- data.frame(sample_data(ps.rel.int))

#run indicator species command
inv2 = multipatt(counts2, meta2$Pole, func = "r.g", control = how(nperm=999))

#view results
summary(inv2) #37 asvs identified as specific to the Arctic
#41 asvs identified as specific to Antarctic

#get taxonomy
taxa_tab2 <- data.frame(tax_table(ps.rel.int))

#extract output data
Results2 <- inv2$sign

#bind with taxa table 
Results2_taxa <- cbind(Results2, taxa_tab2)

#remove rows with p value >0.05
Results2.prune <- Results2_taxa[Results2_taxa$p.value <= 0.05, ]

#Get our Arctic taxa 
Arctic_res2 <- Results2.prune[Results2.prune$s.Arctic == 1, ]
#Arctic_res1$Pole <- "Arctic"
df3 <- data.frame(table(Arctic_res2$Class))
df3$Pole <- "Arctic"

#Get our Antarctic taxa 
Antarctic_res2 <- Results2.prune[Results2.prune$s.Antarctic == 1, ]
df4 <- data.frame(table(Antarctic_res2$Class))
df4$Pole <- "Antarctic"

#Visualise

pct3 <- df3$Freq/sum(df3$Freq)*100
lbls3 <- df3$Var # add percents to labels
datafrm1 <- data.frame(lbls3, pct3)
x3 <- subset(datafrm1, datafrm1$pct3 < 1)
sum_x3 <- sum(x3$pct)
#remove rows with less than 2
y3 <- subset(datafrm1, datafrm1$pct > 1)
datafrm2 <- data.frame("Other", sum_x3)
names(datafrm2) <- c("lbls3", "pct3")
newdf3 <- rbind(y3, datafrm2)
newdf3$lbls3 <- paste(newdf3$lbls3, round(newdf3$pct3, digits=2)) # add percents to labels
newdf3$lbls3 <- paste(newdf3$lbls3,"%",sep="") # ad % to labels 
pie(newdf3$pct3, labels = newdf3$lbls3, col=rainbow(length(newdf3$pct3)), radius= 1, cex=0.3, main="Arctic Intermediate Community Indicator Species by Class")

pct4 <- df4$Freq/sum(df4$Freq)*100
lbls4 <- df4$Var # add percents to labels
datafrm4 <- data.frame(lbls4, pct4)
x4 <- subset(datafrm4, datafrm4$pct4 < 1)
sum_x4 <- sum(x4$pct)
#remove rows with less than 2
y4 <- subset(datafrm4, datafrm4$pct > 1)
datafrm4 <- data.frame("Other", sum_x4)
names(datafrm4) <- c("lbls4", "pct4")
newdf4 <- rbind(y4, datafrm4)
newdf4$lbls4 <- paste(newdf4$lbls4, round(newdf4$pct4, digits=2)) # add percents to labels
newdf4$lbls4 <- paste(newdf4$lbls4,"%",sep="") # ad % to labels 
pie(newdf4$pct4, labels = newdf4$lbls4, col=rainbow(length(newdf4$pct4)), radius= 1, cex=0.3, main="Antarctic Intermediate Community Indicator Species by Class")
```

Rare Taxa
```{r}
#transform into relative abundances
ps.rel.rare = phyloseq::transform_sample_counts(ps.rare, function(x){x / sum(x)})

#get the asv table from our phyloseq object
counts2 <- data.frame(t(otu_table(ps.rel.rare)))

#check this worked correctly
rowSums(counts2) #all rows should equal 1

#get the metadata from our phyloseq object
meta2 <- data.frame(sample_data(ps.rel.rare))

#run indicator species command
inv2 = multipatt(counts2, meta2$Pole, func = "r.g", control = how(nperm=999))

#view results
summary(inv2) #37 asvs identified as specific to the Arctic
#41 asvs identified as specific to Antarctic

#get taxonomy
taxa_tab2 <- data.frame(tax_table(ps.rel.rare))

#extract output data
Results2 <- inv2$sign

#bind with taxa table 
Results2_taxa <- cbind(Results2, taxa_tab2)

#remove rows with p value >0.05
Results2.prune <- Results2_taxa[Results2_taxa$p.value <= 0.05, ]

#Get our Arctic taxa 
Arctic_res2 <- Results2.prune[Results2.prune$s.Arctic == 1, ]
#Arctic_res1$Pole <- "Arctic"
df3 <- data.frame(table(Arctic_res2$Class))
df3$Pole <- "Arctic"

#Get our Antarctic taxa 
Antarctic_res2 <- Results2.prune[Results2.prune$s.Antarctic == 1, ]
df4 <- data.frame(table(Antarctic_res2$Class))
df4$Pole <- "Antarctic"

#Visualise

pct3 <- df3$Freq/sum(df3$Freq)*100
lbls3 <- df3$Var # add percents to labels
datafrm1 <- data.frame(lbls3, pct3)
x3 <- subset(datafrm1, datafrm1$pct3 < 1)
sum_x3 <- sum(x3$pct)
#remove rows with less than 2
y3 <- subset(datafrm1, datafrm1$pct > 1)
datafrm2 <- data.frame("Other", sum_x3)
names(datafrm2) <- c("lbls3", "pct3")
newdf3 <- rbind(y3, datafrm2)
newdf3$lbls3 <- paste(newdf3$lbls3, round(newdf3$pct3, digits=2)) # add percents to labels
newdf3$lbls3 <- paste(newdf3$lbls3,"%",sep="") # ad % to labels 
pie(newdf3$pct3, labels = newdf3$lbls3, col=rainbow(length(newdf3$pct3)), radius= 1, cex=0.3, main="Arctic Rare Community Indicator Species by Class")

pct4 <- df4$Freq/sum(df4$Freq)*100
lbls4 <- df4$Var # add percents to labels
datafrm4 <- data.frame(lbls4, pct4)
x4 <- subset(datafrm4, datafrm4$pct4 < 1)
sum_x4 <- sum(x4$pct)
#remove rows with less than 2
y4 <- subset(datafrm4, datafrm4$pct > 1)
datafrm4 <- data.frame("Other", sum_x4)
names(datafrm4) <- c("lbls4", "pct4")
newdf4 <- rbind(y4, datafrm4)
newdf4$lbls4 <- paste(newdf4$lbls4, round(newdf4$pct4, digits=2)) # add percents to labels
newdf4$lbls4 <- paste(newdf4$lbls4,"%",sep="") # ad % to labels 
pie(newdf4$pct4, labels = newdf4$lbls4, col=rainbow(length(newdf4$pct4)), radius= 1, cex=0.3, main="Antarctic Rare Community Indicator Species by Class")
```